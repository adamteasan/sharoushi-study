<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Á§æÂä¥Â£´Ë©¶È®ì Â≠¶ÁøíRPG Pro</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Noto Sans JP', Arial, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      padding: 20px;
      color: #e0e0e0;
    }

    .main-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      flex-wrap: wrap;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tab-btn {
      flex: 1;
      padding: 12px 8px;
      background: rgba(255, 255, 255, 0.08);
      border: none;
      border-radius: 10px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #e94560, #c23152);
      color: white;
      box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
      transform: translateY(-2px);
    }

    .tab-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.15);
      color: white;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .tab-content.active {
      display: block;
    }

    .game-container {
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(233, 69, 96, 0.3);
    }

    .hero-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }

    .hero-card {
      background: linear-gradient(135deg, rgba(233, 69, 96, 0.15), rgba(194, 49, 82, 0.1));
      border: 2px solid rgba(233, 69, 96, 0.3);
      border-radius: 16px;
      padding: 25px;
      position: relative;
      overflow: hidden;
    }

    .hero-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(233, 69, 96, 0.05) 0%, transparent 70%);
      animation: pulse 4s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1)
      }

      50% {
        transform: scale(1.05)
      }
    }

    .hero-title {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hero-name {
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, #ff6b6b, #ffd93d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-level {
      font-size: 48px;
      font-weight: 900;
      color: #ffd93d;
      text-shadow: 0 0 20px rgba(255, 217, 61, 0.5);
      font-family: 'Courier New', monospace;
    }

    .xp-bar-container {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      height: 24px;
      margin: 10px 0;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .xp-bar {
      height: 100%;
      background: linear-gradient(90deg, #e94560, #ffd93d);
      border-radius: 10px;
      transition: width 1s ease;
      position: relative;
    }

    .xp-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 50%);
      border-radius: 10px;
    }

    .xp-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      font-weight: bold;
      color: white;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
      z-index: 1;
    }

    .combo-display {
      text-align: center;
      padding: 15px;
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 217, 61, 0.1));
      border-radius: 12px;
      border: 1px solid rgba(255, 107, 107, 0.3);
      margin-bottom: 20px;
    }

    .combo-count {
      font-size: 42px;
      font-weight: 900;
      color: #ff6b6b;
      text-shadow: 0 0 30px rgba(255, 107, 107, 0.6);
    }

    .combo-label {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
    }

    .combo-multiplier {
      font-size: 20px;
      font-weight: bold;
      color: #ffd93d;
    }

    .weapon-display {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 217, 61, 0.2);
      margin-bottom: 20px;
    }

    .weapon-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 10px;
    }

    .weapon-name {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #ffd93d;
    }

    .weapon-stat {
      text-align: center;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
    }

    .boss-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .boss-card {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 18px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .boss-card:hover {
      border-color: rgba(233, 69, 96, 0.5);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .boss-card.defeated {
      border-color: rgba(255, 217, 61, 0.5);
      background: rgba(255, 217, 61, 0.05);
    }

    .boss-card.defeated::after {
      content: 'CLEAR!';
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #ffd93d, #ff6b6b);
      color: #1a1a2e;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 900;
    }

    .boss-name {
      font-size: 16px;
      font-weight: bold;
      color: #ff6b6b;
      margin-bottom: 4px;
    }

    .boss-subject {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 10px;
    }

    .boss-hp-bar {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 6px;
      height: 16px;
      overflow: hidden;
      position: relative;
      margin-bottom: 8px;
    }

    .boss-hp-fill {
      height: 100%;
      background: linear-gradient(90deg, #e94560, #ff6b6b);
      border-radius: 6px;
      transition: width 0.8s ease;
    }

    .boss-hp-fill.low {
      background: linear-gradient(90deg, #ffd93d, #ff6b6b);
    }

    .boss-hp-text {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      font-family: 'Courier New', monospace;
    }

    .badge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }

    .badge-item {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s;
      opacity: 0.4;
    }

    .badge-item.earned {
      opacity: 1;
      border-color: rgba(255, 217, 61, 0.5);
      background: rgba(255, 217, 61, 0.05);
    }

    .badge-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .badge-name {
      font-size: 12px;
      font-weight: bold;
      color: #ffd93d;
    }

    .badge-desc {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 4px;
    }

    /* Particle/Effect Overlay */
    #particleCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    .levelup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .levelup-overlay.active {
      display: flex;
      animation: fadeIn 0.3s;
    }

    .levelup-text {
      font-size: 64px;
      font-weight: 900;
      background: linear-gradient(135deg, #ffd93d, #ff6b6b, #ffd93d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: levelUpBounce 0.6s ease;
      text-align: center;
    }

    .levelup-sub {
      font-size: 24px;
      color: #ffd93d;
      margin-top: 15px;
      animation: fadeIn 0.5s 0.3s both;
    }

    @keyframes levelUpBounce {
      0% {
        transform: scale(0);
        opacity: 0
      }

      50% {
        transform: scale(1.3)
      }

      100% {
        transform: scale(1);
        opacity: 1
      }
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0)
      }

      25% {
        transform: translateX(-5px)
      }

      75% {
        transform: translateX(5px)
      }
    }

    .screen-shake {
      animation: shake 0.3s ease;
    }

    /* Timer Section */
    .timer-container {
      max-width: 500px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(233, 69, 96, 0.2);
    }

    h1 {
      text-align: center;
      color: #e94560;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .date-display {
      text-align: center;
      background: linear-gradient(135deg, #e94560, #c23152);
      color: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 25px;
      font-size: 16px;
      font-weight: bold;
    }

    .subject-select {
      margin-bottom: 25px;
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: rgba(255, 255, 255, 0.7);
      font-size: 16px;
    }

    select,
    input[type="date"],
    input[type="text"] {
      width: 100%;
      padding: 14px;
      font-size: 17px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    input[type="text"] {
      text-align: center;
      font-family: 'Courier New', monospace;
    }

    select:focus,
    input:focus {
      outline: none;
      border-color: #e94560;
    }

    select option {
      background: #1a1a2e;
      color: white;
    }

    .timer-display {
      text-align: center;
      font-size: 72px;
      font-weight: bold;
      color: #e94560;
      margin: 40px 0;
      font-family: 'Courier New', monospace;
      text-shadow: 0 0 30px rgba(233, 69, 96, 0.4);
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
    }

    button {
      padding: 16px;
      font-size: 17px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .controls button {
      flex: 1;
    }

    .start-btn {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .start-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .start-btn:disabled {
      background: #374151;
      cursor: not-allowed;
      transform: none;
    }

    .stop-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .stop-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .stop-btn:disabled {
      background: #374151;
      cursor: not-allowed;
      transform: none;
    }

    .reset-btn {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
    }

    .reset-btn:hover {
      transform: translateY(-2px);
    }

    .elapsed-info {
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 20px;
      font-size: 16px;
      min-height: 24px;
    }

    .record-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #e94560, #c23152);
      color: white;
      font-size: 19px;
      font-weight: bold;
    }

    .record-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
    }

    .record-btn:disabled {
      background: #374151;
      cursor: not-allowed;
      transform: none;
    }

    .message {
      text-align: center;
      margin-top: 15px;
      padding: 12px;
      border-radius: 10px;
      font-weight: bold;
      display: none;
    }

    .message.success {
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
      display: block;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .message.error {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      display: block;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .helper-text {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 5px;
      text-align: center;
    }

    /* Sheet Section */
    .sheet-container {
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(233, 69, 96, 0.2);
    }

    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .total-display {
      background: linear-gradient(135deg, #e94560, #c23152);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
    }

    .total-label {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .total-time {
      font-size: 48px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
    }

    .sheet-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      max-height: 75vh;
      overflow-y: auto;
      position: relative;
      background: rgba(0, 0, 0, 0.2);
    }

    .sheet-table thead th {
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .sheet-table thead tr.summary-row td {
      position: sticky;
      top: 40px;
      /* Adjust based on header height */
      z-index: 15;
      background: #1a1a2e;
    }

    .sheet-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(0, 0, 0, 0.2);
      font-size: 14px;
      color: white;
    }

    .sheet-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .sheet-table th {
      background: #e94560;
      color: white;
      padding: 12px 8px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-width: 80px;
    }

    .sheet-table th.subject-col {
      min-width: 90px;
      background: #10b981;
    }

    .sheet-table th.total-col {
      min-width: 80px;
      background: #ffd93d;
      color: #1a1a2e;
    }

    .sheet-table td {
      padding: 8px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sheet-table .date-cell {
      font-weight: bold;
    }

    .sheet-table .weekday-sat {
      color: #60a5fa;
    }

    .sheet-table .weekday-sun {
      color: #f87171;
    }

    .sheet-table .shift-early {
      background: rgba(96, 165, 250, 0.1);
    }

    .sheet-table .shift-rest {
      background: rgba(251, 146, 60, 0.1);
    }

    .sheet-table .shift-late {
      background: rgba(244, 114, 182, 0.1);
    }

    .sheet-table input {
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-family: 'Courier New', monospace;
      padding: 4px;
      font-size: 14px;
      color: white;
    }

    .sheet-table input:focus {
      outline: 2px solid #e94560;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }

    .sheet-table input.has-value {
      background: rgba(233, 69, 96, 0.3) !important;
      color: #ffd93d;
      font-weight: bold;
    }

    .sheet-table .shift-early input.has-value {
      background: rgba(96, 165, 250, 0.4) !important;
    }

    .sheet-table .shift-rest input.has-value {
      background: rgba(251, 146, 60, 0.3) !important;
    }

    .sheet-table .shift-late input.has-value {
      background: rgba(244, 114, 182, 0.3) !important;
    }

    .sheet-table .total-cell {
      background: rgba(255, 217, 61, 0.15);
      font-weight: bold;
      font-family: 'Courier New', monospace;
      color: #ffd93d;
    }

    .sheet-table .summary-row {
      background: rgba(255, 255, 255, 0.05);
      font-weight: bold;
    }

    /* Log Section */
    .log-container {
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(233, 69, 96, 0.2);
    }

    .log-table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      max-height: 70vh;
      overflow-y: auto;
    }

    .log-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(0, 0, 0, 0.2);
    }

    .log-table thead {
      background: #e94560;
      color: white;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .log-table th {
      padding: 15px;
      text-align: left;
      font-weight: bold;
      font-size: 15px;
    }

    .log-table td {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.8);
    }

    .log-table tbody tr:hover {
      background: rgba(233, 69, 96, 0.1);
    }

    .log-actions {
      display: flex;
      gap: 8px;
    }

    .edit-btn,
    .delete-btn {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
    }

    .edit-btn {
      background: #3b82f6;
      color: white;
    }

    .delete-btn {
      background: #ef4444;
      color: white;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      border: 1px solid rgba(233, 69, 96, 0.3);
    }

    .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #e94560;
      margin-bottom: 20px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-buttons button {
      flex: 1;
    }

    /* Stats Section */
    .stats-container {
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(233, 69, 96, 0.2);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(233, 69, 96, 0.2), rgba(194, 49, 82, 0.1));
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      transition: transform 0.3s;
      border: 1px solid rgba(233, 69, 96, 0.2);
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      color: #ffd93d;
    }

    .goal-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .goal-card {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      border-left: 5px solid #e94560;
    }

    .goal-title {
      font-size: 18px;
      font-weight: bold;
      color: white;
      margin-bottom: 15px;
    }

    .goal-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .goal-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
    }

    .goal-value {
      font-size: 20px;
      font-weight: bold;
      color: #ffd93d;
      font-family: 'Courier New', monospace;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 10px;
    }

    .status-ahead {
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
    }

    .status-behind {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    .status-ontrack {
      background: rgba(96, 165, 250, 0.2);
      color: #93c5fd;
    }

    .chart-section {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .chart-title {
      font-size: 20px;
      font-weight: bold;
      color: white;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-canvas {
      width: 100%;
      height: 300px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 15px;
    }

    .subject-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .subject-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 15px;
      border-left: 4px solid #e94560;
    }

    .subject-name {
      font-weight: bold;
      color: white;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .subject-target {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 12px;
    }

    .subject-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .subject-time {
      font-size: 24px;
      font-weight: bold;
      color: #ffd93d;
      font-family: 'Courier New', monospace;
    }

    .subject-percentage {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e94560, #ffd93d);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .insights-section {
      background: linear-gradient(135deg, rgba(233, 69, 96, 0.1), rgba(194, 49, 82, 0.05));
      border-radius: 12px;
      padding: 25px;
      border-left: 5px solid #e94560;
    }

    .insight-item {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      margin-bottom: 15px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .insight-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .insight-content h3 {
      color: #ffd93d;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .insight-content p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      line-height: 1.5;
    }

    .controls-row {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .export-btn,
    .clear-btn,
    .sync-btn {
      padding: 12px 20px;
      font-size: 15px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .export-btn {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    .sync-btn {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }

    .trend-up {
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
    }

    .trend-down {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    .trend-neutral {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.7);
    }

    /* AI Advisor */
    .ai-container {
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .ai-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .ai-subject-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 25px;
    }

    .ai-subject-btn {
      padding: 14px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: white;
      font-weight: bold;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .ai-subject-btn:hover {
      border-color: rgba(16, 185, 129, 0.5);
      background: rgba(16, 185, 129, 0.1);
    }

    .ai-subject-btn.active {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.2);
      box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
    }

    .ai-advice-panel {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .ai-point {
      background: rgba(16, 185, 129, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 4px solid #10b981;
    }

    .ai-point h4 {
      color: #6ee7b7;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .ai-point p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      line-height: 1.6;
    }

    .ai-tips {
      background: rgba(255, 217, 61, 0.1);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 217, 61, 0.2);
      margin-top: 20px;
    }

    .ai-tips h3 {
      color: #ffd93d;
      margin-bottom: 12px;
    }

    .ai-tips li {
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.5;
    }

    .ai-progress-advice {
      background: rgba(233, 69, 96, 0.1);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(233, 69, 96, 0.2);
      margin-top: 20px;
    }

    @media(max-width:768px) {
      .timer-display {
        font-size: 56px;
      }

      .stat-value {
        font-size: 24px;
      }

      .sheet-table {
        font-size: 12px;
      }

      .total-time {
        font-size: 36px;
      }

      .chart-canvas {
        height: 200px;
      }

      .hero-panel {
        grid-template-columns: 1fr;
      }

      .hero-level {
        font-size: 36px;
      }

      .tab-btn {
        font-size: 12px;
        padding: 10px 4px;
      }
    }

    /* === ËøΩÂä†Ôºö„É™„Ç¢„É´„Çø„Ç§„É†Êà¶Èóò„Ç∑„Çπ„ÉÜ„É†Áî®„Çπ„Çø„Ç§„É´ === */
    .battle-view {
      background: linear-gradient(135deg, rgba(233, 69, 96, 0.1), rgba(194, 49, 82, 0.05));
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 20px;
      border: 2px solid rgba(233, 69, 96, 0.3);
    }

    .battle-stage {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .vs-label {
      font-size: 20px;
      font-weight: 900;
      color: #e94560;
      text-shadow: 0 0 10px rgba(233, 69, 96, 0.5);
      font-style: italic;
    }

    .hero-display-rt {
      text-align: center;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      border: 1px solid rgba(16, 185, 129, 0.3);
      position: relative;
    }

    .enemy-display {
      text-align: center;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      border: 1px solid rgba(233, 69, 96, 0.3);
      position: relative;
    }

    .enemy-icon {
      font-size: 48px;
      margin-bottom: 5px;
      animation: enemyFloat 2s ease-in-out infinite;
    }

    @keyframes enemyFloat {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .enemy-name {
      font-size: 18px;
      font-weight: bold;
      color: #ff6b6b;
      margin-bottom: 10px;
    }

    .enemy-hp-bar-container {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      height: 24px;
      position: relative;
      margin: 10px 0;
      overflow: hidden;
    }

    /* Êó¢Â≠ò„ÅÆÊïµHP„Éê„Éº„Å®ÈáçË§á„Åó„Å™„ÅÑ„Çà„ÅÜÈÅ©Âàá„Å™„ÇØ„É©„ÇπÂêç„Çí‰ΩøÁî® */
    .enemy-hp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #e94560, #ff6b6b);
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    .enemy-hp-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: bold;
      color: white;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
      font-family: 'Courier New', monospace;
      font-size: 12px;
      z-index: 1;
    }

    .enemy-stats,
    .hero-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 8px;
    }

    .stat-item-mini {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      padding: 2px 4px;
      display: flex;
      justify-content: space-between;
    }

    .player-stats-realtime {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 15px;
      display: grid;
      gap: 8px;
    }

    .stat-row-rt {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      font-size: 14px;
    }

    .stat-row-rt.highlight {
      background: rgba(255, 217, 61, 0.1);
      border-left: 3px solid #ffd93d;
    }

    .battle-log-realtime {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-title {
      font-size: 14px;
      font-weight: bold;
      color: #ffd93d;
      margin-bottom: 10px;
    }

    .log-messages {
      display: flex;
      flex-direction: column-reverse;
      gap: 6px;
    }

    .log-message {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      animation: slideIn 0.3s ease;
    }

    .log-message.critical {
      color: #ffd93d;
      font-weight: bold;
      background: rgba(255, 217, 61, 0.1);
    }

    .log-message.defeat {
      color: #6ee7b7;
      background: rgba(16, 185, 129, 0.1);
    }

    .log-message.spawn {
      color: #93c5fd;
      background: rgba(59, 130, 246, 0.1);
    }

    .log-message.levelup {
      color: #ff6b6b;
      font-weight: bold;
      background: rgba(233, 69, 96, 0.1);
    }

    .log-message.skill {
      color: #c4b5fd;
      background: rgba(139, 92, 246, 0.1);
    }

    .log-message.weapon {
      color: #fbbf24;
      background: rgba(245, 158, 11, 0.1);
    }

    .floating-damage {
      position: fixed;
      font-size: 32px;
      font-weight: bold;
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      animation: floatDamage 1s ease-out forwards;
      z-index: 9999;
    }

    .floating-damage.critical {
      font-size: 48px;
      color: #ffd93d;
      text-shadow: 0 0 10px rgba(255, 217, 61, 0.8);
    }

    @keyframes floatDamage {
      0% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      100% {
        opacity: 0;
        transform: translateY(-100px) scale(1.2);
      }
    }

    .mini-levelup {
      animation: levelUpSlide 2s ease;
    }

    @keyframes levelUpSlide {
      0% {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }

      10% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      90% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      100% {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
    }

    /* === ËøΩÂä†ÔºöÈ´òÂ∫¶Â≠¶ÁøíÂàÜÊûêÁî®„Çπ„Çø„Ç§„É´ === */
    .pace-container {
      margin: 15px 0;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .pace-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .pace-label {
      color: rgba(255, 255, 255, 0.5);
    }

    .pace-value {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      color: #ffd93d;
    }

    /* === ËøΩÂä†ÔºöË£ÖÂÇô„Éª„Çπ„Ç≠„É´Áî®„Çπ„Çø„Ç§„É´ === */
    .equip-btn {
      margin-top: 10px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #8b5cf6, #6d28d9);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      font-size: 14px;
      transition: transform 0.2s;
    }

    .equip-btn:hover {
      transform: translateY(-2px);
    }

    .skill-bar {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }

    .skill-btn {
      position: relative;
      width: 60px;
      height: 60px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transition: all 0.2s;
    }

    .skill-btn:hover:not(:disabled) {
      border-color: #ffd93d;
      transform: scale(1.05);
    }

    .skill-btn:disabled {
      filter: grayscale(100%);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .skill-icon {
      font-size: 24px;
      margin-bottom: 2px;
    }

    .skill-name {
      font-size: 10px;
      color: white;
      text-align: center;
      line-height: 1;
    }

    .skill-cooldown-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 0%;
      background: rgba(0, 0, 0, 0.7);
      transition: height 0.1s linear;
    }

    .skill-cooldown-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: bold;
      color: white;
      text-shadow: 0 0 5px black;
      font-size: 14px;
      display: none;
    }

    .skill-btn.cooldown .skill-cooldown-text {
      display: block;
    }

    /* Ë£ÖÂÇôÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */
    .equip-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
    }

    .equip-item {
      display: flex;
      align-items: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .equip-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .equip-item.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .equip-item.equipped {
      border-color: #ffd93d;
      background: rgba(255, 217, 61, 0.1);
    }

    .equip-icon {
      font-size: 24px;
      margin-right: 10px;
      min-width: 30px;
      text-align: center;
    }

    .equip-info {
      flex: 1;
    }

    .equip-name {
      font-weight: bold;
      font-size: 14px;
      color: white;
    }

    .equip-stat {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    .equip-rarity {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
      color: white;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* „É¨„Ç¢„É™„ÉÜ„Ç£Ëâ≤ */
    .rarity-common {
      background: #6B7280;
    }

    .rarity-uncommon {
      background: #10B981;
    }

    .rarity-rare {
      background: #3B82F6;
    }

    .rarity-epic {
      background: #8B5CF6;
    }

    .rarity-legendary {
      background: #F59E0B;
    }

    .rarity-mythic {
      background: #EC4899;
    }

    .rarity-divine {
      background: #EF4444;
    }

    /* „Éë„ÉÉ„Ç∑„Éñ„Çπ„Ç≠„É´‰∏ÄË¶ß */
    .passive-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .passive-skill {
      font-size: 20px;
      padding: 5px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      cursor: help;
      position: relative;
    }

    .passive-skill:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 100;
      pointer-events: none;
      margin-bottom: 5px;
    }
  </style>
</head>

<body>
  <canvas id="particleCanvas"></canvas>
  <div id="levelUpOverlay" class="levelup-overlay">
    <div class="levelup-text" id="levelUpText">LEVEL UP!</div>
    <div class="levelup-sub" id="levelUpSub"></div>
  </div>
  <div class="main-container">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('game')">&#9876; ÂÜíÈô∫</button>
      <button class="tab-btn" onclick="switchTab('shop')">üõí „Ç∑„Éß„ÉÉ„Éó„ÉªË£ÖÂÇô</button>
      <button class="tab-btn" onclick="switchTab('timer')">&#9201; „Çø„Ç§„Éû„Éº</button>
      <button class="tab-btn" onclick="switchTab('sheet')">&#128203; „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà</button>
      <button class="tab-btn" onclick="switchTab('log')">&#128221; „É≠„Ç∞</button>
      <button class="tab-btn" onclick="switchTab('report')">&#128202; „É¨„Éù„Éº„Éà</button>
      <button class="tab-btn" onclick="switchTab('stats')">&#128200; ÂàÜÊûê</button>
    </div>

    <!-- Game Tab -->
    <div id="game-tab" class="tab-content active">
      <div class="game-container">
        <h1 style="color:#ffd93d;font-size:32px;margin-bottom:25px;text-shadow:0 0 20px rgba(255,217,61,0.3);">&#9876;
          Á§æÂä¥Â£´„ÇØ„Ç®„Çπ„Éà &#9876;</h1>
        <div class="hero-panel">
          <div class="hero-card" style="position:relative;">
            <div class="hero-title">TITLE</div>
            <div class="hero-name" id="heroTitle">Ë¶ãÁøí„ÅÑÊõ∏Áîü</div>
            <div style="margin-top:15px;">
              <div class="hero-title">LEVEL</div>
              <div class="hero-level" id="heroLevel">1</div>
            </div>

            <!-- NEW: DETAILED STATS PANEL -->
            <div id="heroStatsPanel"
              style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-family:'Courier New', monospace;">
              <div>
                <div style="font-size:11px;color:#aaa;">HP</div>
                <div style="font-size:16px;color:#ff6b6b;font-weight:bold;"><span id="statHP">100</span> / <span
                    id="statMaxHP">100</span></div>
              </div>
              <div>
                <div style="font-size:11px;color:#aaa;">ATK</div>
                <div style="font-size:16px;color:#ffd93d;font-weight:bold;" id="statATK">100</div>
              </div>
              <div>
                <div style="font-size:11px;color:#aaa;">DEF</div>
                <div style="font-size:16px;color:#4caf50;font-weight:bold;" id="statDEF">0</div>
              </div>
              <div>
                <div style="font-size:11px;color:#aaa;">CRT</div>
                <div style="font-size:16px;color:#f39c12;font-weight:bold;" id="statCRT">5.0%</div>
              </div>
              <div>
                <div style="font-size:11px;color:#aaa;">GOLD</div>
                <div style="font-size:16px;color:#f1c40f;font-weight:bold;" id="statGold">0 G</div>
              </div>
              <div>
                <div style="font-size:11px;color:#aaa;">EXP</div>
                <div style="font-size:16px;color:#3498db;font-weight:bold;" id="statEXP">0</div>
              </div>
            </div>

            <div class="xp-bar-container" style="margin-top:15px;">
              <div class="xp-bar" id="xpBar" style="width:0%"></div>
              <div class="xp-text" id="xpText">0 / 100 XP</div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;">
              <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">
                <div style="font-size:11px;color:rgba(255,255,255,0.5);">&#128218; Á∑èÂ≠¶Áøí</div>
                <div style="font-size:18px;font-weight:bold;color:#ffd93d;font-family:'Courier New',monospace;"
                  id="heroTotalTime">00:00</div>
              </div>
              <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">
                <div style="font-size:11px;color:rgba(255,255,255,0.5);">&#128165; ÊíÉÁ†¥„Éú„Çπ</div>
                <div style="font-size:18px;font-weight:bold;color:#ff6b6b;" id="heroDefeated">0/10</div>
              </div>
            </div>
          </div>
          <div>
            <div class="combo-display">
              <div class="combo-label">&#128293; ÈÄ£Á∂öÂ≠¶Áøí„Ç≥„É≥„Éú</div>
              <div class="combo-count" id="comboCount">0Êó•</div>
              <div class="combo-multiplier" id="comboMultiplier">x1.0 XP</div>
            </div>
            <!-- Restored Weapon/Skill Display -->
            <div id="adventureEquipGrid" style="margin-top:20px; display:grid; grid-template-columns: 1fr; gap:10px;">
              <div class="equip-display-item"
                style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; display:flex; align-items:center;">
                <div id="advWpIcon" style="font-size:24px; margin-right:15px;">üó°Ô∏è</div>
                <div style="flex:1;">
                  <div id="advWpName" style="font-weight:bold; font-size:14px; color:#ffd700;">Ê≠¶Âô®„Å™„Åó</div>
                  <div id="advWpStat" style="font-size:11px; color:#aaa;">ATK 0</div>
                </div>
              </div>
              <div class="equip-display-item"
                style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; display:flex; align-items:center;">
                <div id="advAmIcon" style="font-size:24px; margin-right:15px;">üõ°Ô∏è</div>
                <div style="flex:1;">
                  <div id="advAmName" style="font-weight:bold; font-size:14px; color:#4caf50;">Èò≤ÂÖ∑„Å™„Åó</div>
                  <div id="advAmStat" style="font-size:11px; color:#aaa;">DEF 0</div>
                </div>
              </div>
              <div class="equip-display-item"
                style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; display:flex; align-items:center;">
                <div id="advAcIcon" style="font-size:24px; margin-right:15px;">üíç</div>
                <div style="flex:1;">
                  <div id="advAcName" style="font-weight:bold; font-size:14px; color:#9c27b0;">„Ç¢„ÇØ„Çª„Å™„Åó</div>
                  <div id="advAcStat" style="font-size:11px; color:#aaa;">Effect ---</div>
                </div>
              </div>
            </div>
            <div id="adventureSkillGrid"
              style="margin-top:15px; display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
              <!-- Passive skills -->
            </div>
          </div>
        </div>

        <h2 style="color:#ff6b6b;margin-bottom:15px;font-size:20px;">&#128121; „Éú„ÇπË®é‰ºê„Éû„ÉÉ„Éó</h2>
        <div class="boss-grid" id="bossGrid"></div>

        <h2 style="color:#ffd93d;margin-bottom:15px;font-size:20px;">&#127942; ÂÆüÁ∏æ„Éê„ÉÉ„Ç∏</h2>
        <div class="badge-grid" id="badgeGrid"></div>
      </div>
    </div>

    <!-- NEW: Shop & Equip Tab -->
    <div id="shop-tab" class="tab-content">
      <div class="game-container">
        <h1 style="color:#ffd700; font-size:32px; margin-bottom:20px;">üõí „Ç∑„Éß„ÉÉ„Éó & Ë£ÖÂÇô</h1>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
          <!-- LEFT: Equipment & Skills -->
          <div>
            <h3 style="color:white; border-bottom:1px solid #555; padding-bottom:10px; margin-bottom:15px;">‚öîÔ∏è ÁèæÂú®„ÅÆË£ÖÂÇô
            </h3>
            <div id="currentEquipDisplay"
              style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; display:flex; align-items:center; margin-bottom:20px;">
              <div id="shopEquipIcon" style="font-size:40px; margin-right:20px;">üó°Ô∏è</div>
              <div>
                <div id="shopEquipName" style="font-weight:bold; font-size:18px; color:#ffd700;">Ê≠¶Âô®„Å™„Åó</div>
                <div id="shopEquipStat" style="font-size:14px; color:#aaa;">ATK 0</div>
              </div>
            </div>

            <h3 style="color:white; border-bottom:1px solid #555; padding-bottom:10px; margin-bottom:15px;">‚ú® „Éë„ÉÉ„Ç∑„Éñ„Çπ„Ç≠„É´
            </h3>
            <div id="shopPassiveList"
              style="display:grid; grid-template-columns:repeat(auto-fill, minmax(70px, 1fr)); gap:10px;">
              <!-- Skills inserted here -->
            </div>
          </div>

          <!-- RIGHT: Gacha & Shop -->
          <div>
            <div
              style="background:linear-gradient(135deg, #2c3e50, #000000); padding:20px; border-radius:15px; text-align:center; border:1px solid #ffd700;">
              <h2 style="color:#ffd700; margin-bottom:10px;">üîÆ Ê≠¶Âô®„Ç¨„ÉÅ„É£</h2>
              <div style="font-size:60px; margin:20px 0; animation: bounce 2s infinite;">üéÅ</div>
              <div style="font-size:18px; font-weight:bold; margin-bottom:15px;">ÊâÄÊåÅ„Ç≥„Ç§„É≥: <span id="shopGoldDisplay"
                  style="color:#ffd700;">0 G</span></div>
              <button onclick="pullGacha()"
                style="width:100%; padding:15px; background:linear-gradient(45deg, #ffd700, #ffa500); color:black; font-weight:bold; border:none; border-radius:10px; font-size:18px; cursor:pointer; box-shadow:0 5px 15px rgba(212, 175, 55, 0.4);">
                1ÂõûÂºï„Åè (10,000 G)
              </button>
              <p style="font-size:12px; color:#aaa; margin-top:10px;">ÈáçË§á„ÅØË¶öÈÜí(Âº∑Âåñ)„Åï„Çå„Åæ„ÅôÔºÅ</p>
            </div>

            <h3 style="color:white; border-bottom:1px solid #555; padding-bottom:10px; margin:20px 0 15px;">üéí ÊâÄÊåÅÊ≠¶Âô® (Âº∑Âåñ)
            </h3>
            <div id="shopWeaponList"
              style="background:rgba(0,0,0,0.2); max-height:400px; overflow-y:auto; border-radius:10px; padding:10px;">
              <!-- Inventory list inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Timer Tab -->
    <div id="timer-tab" class="tab-content">
      <div class="timer-container">
        <h1>&#9201; Â≠¶Áøí„Çø„Ç§„Éû„Éº</h1>
        <div class="date-display" id="dateDisplay">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
        <div class="subject-select">
          <label for="recordDate">Ë®òÈå≤„Åô„ÇãÊó•‰ªò</label>
          <input type="date" id="recordDate">
        </div>
        <div class="subject-select">
          <label for="subject">ÁßëÁõÆ„ÇíÈÅ∏Êäû</label>
          <select id="subject">
            <option value="Âä¥ÂÉçÂü∫Ê∫ñÊ≥ï">Âä¥ÂÉçÂü∫Ê∫ñÊ≥ï</option>
            <option value="Âä¥ÂÉçÂÆâÂÖ®Ë°õÁîüÊ≥ï">Âä¥ÂÉçÂÆâÂÖ®Ë°õÁîüÊ≥ï</option>
            <option value="Âä¥ÂÉçËÄÖÁÅΩÂÆ≥Ë£úÂÑü‰øùÈô∫Ê≥ï">Âä¥ÂÉçËÄÖÁÅΩÂÆ≥Ë£úÂÑü‰øùÈô∫Ê≥ï</option>
            <option value="ÈõáÁî®‰øùÈô∫Ê≥ï">ÈõáÁî®‰øùÈô∫Ê≥ï</option>
            <option value="Âä¥ÂÉç‰øùÈô∫Âæ¥ÂèéÊ≥ï">Âä¥ÂÉç‰øùÈô∫Âæ¥ÂèéÊ≥ï</option>
            <option value="ÂÅ•Â∫∑‰øùÈô∫Ê≥ï">ÂÅ•Â∫∑‰øùÈô∫Ê≥ï</option>
            <option value="ÂõΩÊ∞ëÂπ¥ÈáëÊ≥ï">ÂõΩÊ∞ëÂπ¥ÈáëÊ≥ï</option>
            <option value="ÂéöÁîüÂπ¥Èáë‰øùÈô∫Ê≥ï">ÂéöÁîüÂπ¥Èáë‰øùÈô∫Ê≥ï</option>
            <option value="Á§æ‰ºö‰øùÈô∫„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò">Á§æ‰ºö‰øùÈô∫„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò</option>
            <option value="Âä¥ÂÉç„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò">Âä¥ÂÉç„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò</option>
            <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
          </select>
        </div>

        <!-- ‚òÖÊñ∞Ë¶èËøΩÂä†Ôºö„É™„Ç¢„É´„Çø„Ç§„É†Êà¶Èóò„Éì„É•„Éº -->
        <div class="battle-view">
          <div class="battle-stage">
            <!-- „ÅÇ„Å™„Åü„ÅÆË°®Á§∫ -->
            <div class="hero-display-rt">
              <div class="enemy-icon" id="rtHeroIcon">üë§</div>
              <div class="enemy-name" id="rtHeroName">„ÅÇ„Å™„Åü</div>
              <div class="enemy-hp-bar-container" style="background: rgba(255,107,107,0.2);">
                <div class="enemy-hp-bar-fill" id="rtHeroHPFill"
                  style="width: 100%; background: linear-gradient(90deg, #ff6b6b, #ee5253);"></div>
                <span class="enemy-hp-text" id="rtHeroHPText">HP 1000 / 1000</span>
              </div>
              <div class="enemy-hp-bar-container"
                style="background: rgba(16,185,129,0.2); height: 8px; margin-top: 5px;">
                <div class="enemy-hp-bar-fill" id="rtXPBarFill"
                  style="width: 0%; background: linear-gradient(90deg, #10b981, #6ee7b7);"></div>
              </div>
              <div id="rtXPText" style="font-size:10px; color:#aaa; text-align:center; margin-top:2px;">EXP -- / --
              </div>
              <div class="hero-stats-grid">
                <div class="stat-item-mini"><span>‚öîÔ∏è</span><span id="rtHeroATKDisplay">--</span></div>
                <div class="stat-item-mini"><span>üõ°Ô∏è</span><span id="rtHeroDEFDisplay">--</span></div>
                <div class="stat-item-mini"><span>üí•</span><span id="rtHeroCRTDisplay">--</span></div>
                <div class="stat-item-mini"><span>üí∞</span><span id="rtHeroGoldDisplay">--</span></div>
              </div>
            </div>

            <div class="vs-divider"
              style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
              <div class="vs-label" style="margin:0;">VS</div>
              <div id="rtFloorDisplay" style="font-size:14px; color:#ffd700; font-weight:bold; margin-top:5px;">FLOOR 1
              </div>
              <div id="rtStageDisplay" style="font-size:10px; color:#aaa;">Stage 1/10</div>
            </div>

            <!-- Êïµ„ÅÆË°®Á§∫ -->
            <div class="enemy-display" id="enemyDisplay">
              <div class="enemy-icon" id="enemyIcon">üëæ</div>
              <div class="enemy-name" id="enemyName">Êïµ„ÇíÂæÖÊ©ü‰∏≠...</div>
              <div class="enemy-hp-bar-container">
                <div class="enemy-hp-bar-fill" id="enemyHPBar" style="width: 100%"></div>
                <span class="enemy-hp-text" id="enemyHPText">100 / 100</span>
              </div>
              <div class="enemy-stats">
                <div class="stat-item-mini"><span>‚öîÔ∏è</span><span id="enemyATK">--</span></div>
                <div class="stat-item-mini"><span>üõ°Ô∏è</span><span id="enemyDEF">--</span></div>
                <div class="stat-item-mini"><span>‚ú®</span><span id="enemyGold">--</span></div>
                <div class="stat-item-mini"><span>Lv</span><span id="enemyLevel">--</span></div>
              </div>
            </div>
          </div>

          <div class="player-stats-realtime"
            style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; background: none; padding: 0;">
            <div class="stat-row-rt highlight" style="flex: 1; min-width: 100px; justify-content: center; gap: 5px;">
              <span class="stat-label">‚ö° DPS</span>
              <span class="stat-value" id="rtDPS">--</span>
            </div>
          </div>
        </div>
      </div>

      <div class="timer-display" id="timer">00:00:00</div>
      <div class="subject-select">
        <label for="manualTime">„Åæ„Åü„ÅØÊôÇÈñì„ÇíÁõ¥Êé•ÂÖ•Âäõ</label>
        <input type="text" id="manualTime" placeholder="‰æã: 1:30 (1ÊôÇÈñì30ÂàÜ)">
        <p class="helper-text">ÂΩ¢Âºè: ÊôÇ:ÂàÜ (‰æã: 2:15 = 2ÊôÇÈñì15ÂàÜ)</p>
      </div>
      <div class="elapsed-info" id="elapsedInfo"></div>
      <div class="controls">
        <button class="start-btn" id="startBtn" onclick="startTimer()">ÈñãÂßã</button>
        <button class="stop-btn" id="stopBtn" onclick="stopTimer()" disabled>ÂÅúÊ≠¢</button>
        <button class="reset-btn" id="resetBtn" onclick="resetTimer()">„É™„Çª„ÉÉ„Éà</button>
      </div>

      <!-- ‚òÖÊñ∞Ë¶èËøΩÂä†ÔºöÊà¶Èóò„É≠„Ç∞ -->
      <div class="battle-log-realtime">
        <div class="log-title">üìú Êà¶Èóò„É≠„Ç∞</div>
        <div class="log-messages" id="realtimeLog"></div>
      </div>

      <button class="record-btn" id="recordBtn" onclick="recordTime()">&#9876; Ë®òÈå≤„Åó„Å¶ÊîªÊíÉÔºÅ</button>
      <div class="message" id="message"></div>
    </div>
  </div>

  <!-- Sheet Tab -->
  <div id="sheet-tab" class="tab-content">
    <div class="sheet-container">
      <div class="sheet-header">
        <h1>&#128203; Â≠¶Áøí„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà</h1>
        <div class="controls-row">
          <button class="sync-btn" onclick="syncFromTimer()">&#128260; „Çø„Ç§„Éû„Éº„Åã„ÇâÂêåÊúü</button>
          <button class="clear-btn" style="background:linear-gradient(135deg, #f59e0b, #d97706); color:white;"
            onclick="migrateFromV4()">&#128229; V4.0„Åã„ÇâÁßªË°å</button>
          <button class="export-btn" onclick="exportSheet()">&#128190; Ê®™ÂûãCSV</button>
          <button class="export-btn" onclick="exportOriginalFormat()">&#128202; Á∏¶ÂûãCSV</button>
        </div>
      </div>
      <div class="total-display">
        <div class="total-label">Á∑èÂ≠¶ÁøíÊôÇÈñì</div>
        <div class="total-time" id="sheetTotalTime">00:00</div>
      </div>
      <div class="sheet-wrapper">
        <table class="sheet-table" id="sheetTable">
          <thead>
            <tr id="sheetHeader">
              <th class="date-col">Êó•‰ªò</th>
              <th class="weekday-col">ÊõúÊó•</th>
              <th class="remaining-col">ÊÆã„ÇäÊó•Êï∞</th>
              <th class="subject-col">Âä¥ÂÉçÂü∫Ê∫ñÊ≥ï</th>
              <th class="subject-col">Âä¥ÂÉçÂÆâÂÖ®Ë°õÁîüÊ≥ï</th>
              <th class="subject-col">Âä¥ÁÅΩ‰øùÈô∫Ê≥ï</th>
              <th class="subject-col">ÈõáÁî®‰øùÈô∫Ê≥ï</th>
              <th class="subject-col">Âä¥ÂÉç‰øùÈô∫Âæ¥ÂèéÊ≥ï</th>
              <th class="subject-col">ÂÅ•Â∫∑‰øùÈô∫Ê≥ï</th>
              <th class="subject-col">ÂõΩÊ∞ëÂπ¥ÈáëÊ≥ï</th>
              <th class="subject-col">ÂéöÁîüÂπ¥Èáë‰øùÈô∫Ê≥ï</th>
              <th class="subject-col">Á§æ‰øù‰∏ÄËà¨Â∏∏Ë≠ò</th>
              <th class="subject-col">Âä¥ÂÉç‰∏ÄËà¨Â∏∏Ë≠ò</th>
              <th class="subject-col">„Åù„ÅÆ‰ªñ</th>
              <th class="total-col">ÂΩìÊó•ÂêàË®à</th>
            </tr>
            <tr class="summary-row">
              <td colspan="3">ÁßëÁõÆÂà•ÂêàË®à</td>
              <td id="sum-0">00:00</td>
              <td id="sum-1">00:00</td>
              <td id="sum-2">00:00</td>
              <td id="sum-3">00:00</td>
              <td id="sum-4">00:00</td>
              <td id="sum-5">00:00</td>
              <td id="sum-6">00:00</td>
              <td id="sum-7">00:00</td>
              <td id="sum-8">00:00</td>
              <td id="sum-9">00:00</td>
              <td id="sum-10">00:00</td>
              <td id="sum-total" class="total-cell">00:00</td>
            </tr>
          </thead>
          <tbody id="sheetBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Log Tab -->
  <div id="log-tab" class="tab-content">
    <div class="log-container">
      <h1>&#128221; Ë®òÈå≤„É≠„Ç∞</h1>
      <div class="log-table-wrapper">
        <table class="log-table">
          <thead>
            <tr>
              <th>Êó•‰ªò</th>
              <th>Ë®òÈå≤ÊôÇÂàª</th>
              <th>ÁßëÁõÆ</th>
              <th>Â≠¶ÁøíÊôÇÈñì</th>
              <th>Êìç‰Ωú</th>
            </tr>
          </thead>
          <tbody id="logTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Report Tab -->
  <div id="report-tab" class="tab-content">
    <div class="stats-container card">
      <h1>&#128202; Â≠¶Áøí„É¨„Éù„Éº„Éà</h1>
      <div style="display:flex;gap:12px;margin:20px 0 30px;justify-content:center;flex-wrap:wrap;">
        <button class="filter-btn active" id="reportBtnToday" onclick="switchReport('today')"
          style="padding:12px 24px;background:linear-gradient(135deg,#e94560,#c23152);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">‰ªäÊó•</button>
        <button class="filter-btn" id="reportBtnWeek" onclick="switchReport('week')"
          style="padding:12px 24px;background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.7);border:none;border-radius:12px;font-weight:700;cursor:pointer;">‰ªäÈÄ±</button>
        <button class="filter-btn" id="reportBtnMonth" onclick="switchReport('month')"
          style="padding:12px 24px;background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.7);border:none;border-radius:12px;font-weight:700;cursor:pointer;">‰ªäÊúà</button>
      </div>
      <div id="reportContent">
        <div
          style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:15px; margin-bottom:20px;">
          <div class="report-card"
            style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; text-align:center;">
            <div style="font-size:12px; color:#aaa;">‰ªäÊó•</div>
            <div style="font-size:20px; font-weight:bold; color:white;" id="reportToday">00:00</div>
          </div>
          <div class="report-card"
            style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; text-align:center;">
            <div style="font-size:12px; color:#aaa;">‰ªäÈÄ±</div>
            <div style="font-size:20px; font-weight:bold; color:white;" id="reportWeek">00:00</div>
          </div>
          <div class="report-card"
            style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; text-align:center;">
            <div style="font-size:12px; color:#aaa;">‰ªäÊúà</div>
            <div style="font-size:20px; font-weight:bold; color:white;" id="reportMonth">00:00</div>
          </div>
          <div class="report-card"
            style="background:linear-gradient(135deg, #2c3e50, #4ca1af); padding:15px; border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.2);">
            <div style="font-size:12px; color:#ffd700; font-weight:bold;">‰ªäÂπ¥</div>
            <div style="font-size:24px; font-weight:bold; color:white;" id="reportYear">00:00</div>
          </div>
        </div>

        <!-- Detailed Breakdown -->
        <h3 id="reportDetailTitle"
          style="color:#ddd; border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:10px;">
          ‰ªäÊó•„ÅÆË©≥Á¥∞
        </h3>
        <div id="reportDetailList"></div>
      </div>
    </div>
  </div>

  <!-- Stats Tab -->
  <div id="stats-tab" class="tab-content">
    <div class="stats-container">
      <h1>&#128200; È´òÂ∫¶„Å™Â≠¶ÁøíÂàÜÊûê</h1>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Á∑èÂ≠¶ÁøíÊôÇÈñì</div>
          <div class="stat-value" id="totalAllTime">00:00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">‰ªäÈÄ±„ÅÆÂ≠¶ÁøíÊôÇÈñì</div>
          <div class="stat-value" id="weekTime">00:00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">‰ªäÊúà„ÅÆÂ≠¶ÁøíÊôÇÈñì</div>
          <div class="stat-value" id="monthTime">00:00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Â≠¶ÁøíÊó•Êï∞</div>
          <div class="stat-value"><span id="studyDays">0</span>Êó•</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Êó©Áï™Âπ≥Âùá</div>
          <div class="stat-value" id="earlyAvg">00:00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ÈÅÖÁï™Âπ≥Âùá</div>
          <div class="stat-value" id="lateAvg">00:00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">‰ºëÊó•Âπ≥Âùá</div>
          <div class="stat-value" id="restAvg">00:00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ë©¶È®ì„Åæ„Åß</div>
          <div class="stat-value"><span id="daysToExam">0</span>Êó•</div>
        </div>
      </div>
      <div class="goal-cards">
        <div class="goal-card">
          <div class="goal-title">&#127919; 800ÊôÇÈñìÁõÆÊ®ô</div>
          <div class="goal-stat"><span class="goal-label">ÈÅîÊàêÁéá</span><span class="goal-value"
              id="goal800Progress">0%</span></div>
          <div style="margin:15px 0;padding:15px;background:rgba(0,0,0,0.2);border-radius:8px;">
            <div style="font-size:13px;font-weight:bold;color:white;margin-bottom:10px;">ÂøÖË¶Å„Éö„Éº„Çπ</div>
            <div style="display:grid;gap:8px;">
              <div style="display:flex;justify-content:space-between;font-size:13px;"><span
                  style="color:rgba(255,255,255,0.5);">Êó©Áï™:</span><span id="goal800EarlyPace"
                  style="font-family:'Courier New',monospace;font-weight:bold;color:#ffd93d;">00:00</span></div>
              <div style="display:flex;justify-content:space-between;font-size:13px;"><span
                  style="color:rgba(255,255,255,0.5);">ÈÅÖÁï™:</span><span id="goal800LatePace"
                  style="font-family:'Courier New',monospace;font-weight:bold;color:#ffd93d;">00:00</span></div>
              <div style="display:flex;justify-content:space-between;font-size:13px;"><span
                  style="color:rgba(255,255,255,0.5);">‰ºëÊó•:</span><span id="goal800RestPace"
                  style="font-family:'Courier New',monospace;font-weight:bold;color:#ffd93d;">00:00</span></div>
            </div>
          </div>
          <div id="goal800Status"></div>
        </div>
        <div class="goal-card">
          <div class="goal-title">&#127919; 1000ÊôÇÈñìÁõÆÊ®ô</div>
          <div class="goal-stat"><span class="goal-label">ÈÅîÊàêÁéá</span><span class="goal-value"
              id="goal1000Progress">0%</span></div>
          <div style="margin:15px 0;padding:15px;background:rgba(0,0,0,0.2);border-radius:8px;">
            <div style="font-size:13px;font-weight:bold;color:white;margin-bottom:10px;">ÂøÖË¶Å„Éö„Éº„Çπ</div>
            <div style="display:grid;gap:8px;">
              <div style="display:flex;justify-content:space-between;font-size:13px;"><span
                  style="color:rgba(255,255,255,0.5);">Êó©Áï™:</span><span id="goal1000EarlyPace"
                  style="font-family:'Courier New',monospace;font-weight:bold;color:#ffd93d;">00:00</span></div>
              <div style="display:flex;justify-content:space-between;font-size:13px;"><span
                  style="color:rgba(255,255,255,0.5);">ÈÅÖÁï™:</span><span id="goal1000LatePace"
                  style="font-family:'Courier New',monospace;font-weight:bold;color:#ffd93d;">00:00</span></div>
              <div style="display:flex;justify-content:space-between;font-size:13px;"><span
                  style="color:rgba(255,255,255,0.5);">‰ºëÊó•:</span><span id="goal1000RestPace"
                  style="font-family:'Courier New',monospace;font-weight:bold;color:#ffd93d;">00:00</span></div>
            </div>
          </div>
          <div id="goal1000Status"></div>
        </div>
        <div class="goal-card">
          <div class="goal-title">&#127919; 1200ÊôÇÈñìÁõÆÊ®ô</div>
          <div class="goal-stat"><span class="goal-label">ÈÅîÊàêÁéá</span><span class="goal-value"
              id="goal1200Progress">0%</span></div>
          <div style="margin:15px 0;padding:15px;background:rgba(0,0,0,0.2);border-radius:8px;">
            <div style="font-size:13px;font-weight:bold;color:white;margin-bottom:10px;">ÂøÖË¶Å„Éö„Éº„Çπ</div>
            <div style="display:grid;gap:8px;">
              <div style="display:flex;justify-content:space-between;font-size:13px;"><span
                  style="color:rgba(255,255,255,0.5);">Êó©Áï™:</span><span id="goal1200EarlyPace"
                  style="font-family:'Courier New',monospace;font-weight:bold;color:#ffd93d;">00:00</span></div>
              <div style="display:flex;justify-content:space-between;font-size:13px;"><span
                  style="color:rgba(255,255,255,0.5);">ÈÅÖÁï™:</span><span id="goal1200LatePace"
                  style="font-family:'Courier New',monospace;font-weight:bold;color:#ffd93d;">00:00</span></div>
              <div style="display:flex;justify-content:space-between;font-size:13px;"><span
                  style="color:rgba(255,255,255,0.5);">‰ºëÊó•:</span><span id="goal1200RestPace"
                  style="font-family:'Courier New',monospace;font-weight:bold;color:#ffd93d;">00:00</span></div>
            </div>
          </div>
          <div id="goal1200Status"></div>
        </div>
      </div>
      <div class="chart-section">
        <div class="chart-title"><span>&#128218;</span><span>ÁßëÁõÆÂà•Â≠¶ÁøíÊôÇÈñì</span></div>
        <div id="subjectBreakdown" class="subject-breakdown"></div>
      </div>
      <div class="chart-section">
        <div class="chart-title"><span>&#128200;</span><span>Â≠¶Áøí„Éà„É¨„É≥„Éâ (Áõ¥Ëøë30Êó•)</span><span id="trendIndicator"></span>
        </div>
        <div class="chart-canvas"><canvas id="trendChart"></canvas></div>
      </div>
      <div class="chart-section">
        <div class="chart-title"><span>&#128197;</span><span>ÊõúÊó•Âà•„ÉªÁßëÁõÆÂà•Â≠¶Áøí„Éë„Çø„Éº„É≥</span></div>
        <div style="display:flex;gap:10px;margin-bottom:20px;justify-content:center;"><button class="filter-btn"
            id="weekdayBtn1Week" onclick="updateWeekdayChartPeriod('week')"
            style="padding:8px 16px;background:#e94560;color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;">Áõ¥Ëøë1ÈÄ±Èñì</button><button
            class="filter-btn" id="weekdayBtn1Month" onclick="updateWeekdayChartPeriod('month')"
            style="padding:8px 16px;background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.7);border:none;border-radius:8px;font-weight:700;cursor:pointer;">Áõ¥Ëøë1„É∂Êúà</button><button
            class="filter-btn active" id="weekdayBtnAll" onclick="updateWeekdayChartPeriod('all')"
            style="padding:8px 16px;background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.7);border:none;border-radius:8px;font-weight:700;cursor:pointer;">ÂÖ®ÊúüÈñì</button>
        </div>
        <div class="chart-canvas"><canvas id="weekdayChart"></canvas></div>
      </div>
      <div class="insights-section">
        <div class="chart-title"><span>&#128161;</span><span>Â≠¶Áøí„Ç§„É≥„Çµ„Ç§„Éà</span></div>
        <div id="insights"></div>
      </div>
    </div>
  </div>

  <!-- AI Advisor Tab -->
  <div id="ai-tab" class="tab-content">
    <div class="ai-container">
      <div class="ai-header">
        <h1 style="color:#10b981;">&#129504; AIÂ≠¶Áøí„Ç¢„Éâ„Éê„Ç§„Ç∂„Éº</h1>
        <p style="color:rgba(255,255,255,0.6);margin-top:10px;">ÁßëÁõÆ„ÇíÈÅ∏„Çì„ÅßÈáçË¶Å„Éù„Ç§„É≥„Éà„Å®Â≠¶Áøí„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Çá„ÅÜ</p>
      </div>
      <div class="ai-subject-grid" id="aiSubjectGrid"></div>
      <div id="aiAdvicePanel"></div>
      <div id="aiGeneralAdvice"></div>
    </div>
  </div>


  </div><!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Ë®òÈå≤„ÇíÁ∑®ÈõÜ</div>
      <div class="subject-select"><label for="editDate">Êó•‰ªò</label><input type="date" id="editDate"></div>
      <div class="subject-select"><label for="editSubject">ÁßëÁõÆ</label>
        <select id="editSubject">
          <option value="Âä¥ÂÉçÂü∫Ê∫ñÊ≥ï">Âä¥ÂÉçÂü∫Ê∫ñÊ≥ï</option>
          <option value="Âä¥ÂÉçÂÆâÂÖ®Ë°õÁîüÊ≥ï">Âä¥ÂÉçÂÆâÂÖ®Ë°õÁîüÊ≥ï</option>
          <option value="Âä¥ÂÉçËÄÖÁÅΩÂÆ≥Ë£úÂÑü‰øùÈô∫Ê≥ï">Âä¥ÂÉçËÄÖÁÅΩÂÆ≥Ë£úÂÑü‰øùÈô∫Ê≥ï</option>
          <option value="ÈõáÁî®‰øùÈô∫Ê≥ï">ÈõáÁî®‰øùÈô∫Ê≥ï</option>
          <option value="Âä¥ÂÉç‰øùÈô∫Âæ¥ÂèéÊ≥ï">Âä¥ÂÉç‰øùÈô∫Âæ¥ÂèéÊ≥ï</option>
          <option value="ÂÅ•Â∫∑‰øùÈô∫Ê≥ï">ÂÅ•Â∫∑‰øùÈô∫Ê≥ï</option>
          <option value="ÂõΩÊ∞ëÂπ¥ÈáëÊ≥ï">ÂõΩÊ∞ëÂπ¥ÈáëÊ≥ï</option>
          <option value="ÂéöÁîüÂπ¥Èáë‰øùÈô∫Ê≥ï">ÂéöÁîüÂπ¥Èáë‰øùÈô∫Ê≥ï</option>
          <option value="Á§æ‰ºö‰øùÈô∫„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò">Á§æ‰ºö‰øùÈô∫„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò</option>
          <option value="Âä¥ÂÉç„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò">Âä¥ÂÉç„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò</option>
          <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
        </select>
      </div>
      <div class="subject-select"><label for="editTime">Â≠¶ÁøíÊôÇÈñì</label><input type="text" id="editTime"
          placeholder="‰æã: 1:30"></div>
      <div class="modal-buttons">
        <button class="start-btn" onclick="saveEdit()">‰øùÂ≠ò</button>
        <button class="reset-btn" onclick="closeEditModal()">„Ç≠„É£„É≥„Çª„É´</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // ===== GLOBAL VARIABLES =====
    let startTime = null, elapsedTime = 0, timerInterval = null, isPaused = false, pausedTime = 0;
    let studyRecords = [], sheetData = {}, trendChartInstance = null, weekdayChartInstance = null, editingIndex = -1;
    let weekdayChartPeriod = 'all', currentReportType = 'today';

    // ===== REAL-TIME BATTLE VARIABLES & NEW RPG SYSTEM =====
    let battleInterval = null;
    let currentEnemy = null;
    let battleTime = 0;
    let attackDamageHistory = [];

    function logBattle(msg, type = "normal") {
      const log = document.getElementById('battleLog');
      if (!log) return;
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}`;
      log.prepend(entry);
      if (log.childNodes.length > 50) log.lastChild.remove();
    }

    function showFloatingDamage(dmg, isCritical) {
      const parent = document.getElementById('enemyDisplay');
      if (!parent) return;
      const el = document.createElement('div');
      el.className = `floating-damage ${isCritical ? 'critical' : ''}`;
      el.textContent = (isCritical ? 'CRITICAL! ' : '') + dmg;
      el.style.left = (40 + Math.random() * 20) + '%';
      el.style.top = (30 + Math.random() * 20) + '%';
      parent.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }
    // 2.1 „Éó„É¨„Ç§„É§„Éº„Çπ„ÉÜ„Éº„Çø„ÇπÊßãÈÄ† (User Provided + Enhancements)
    const playerStats = {
      level: 1, exp: 0, gold: 0,
      baseATK: 100, baseDEF: 0, baseCRT: 5, baseCritMultiplier: 2.0,
      equippedWeapon: null,
      equippedArmor: null,
      equippedAccessory: null,

      // Êñ∞Ê©üËÉΩÁî®„Éá„Éº„Çø
      inventory: [],        // Áç≤Âæó„Åó„ÅüÊ≠¶Âô®„ÉªÈò≤ÂÖ∑„Éª„Ç¢„ÇØ„Çª {id, level, count}
      skills: [],           // NEW: Áç≤Âæó„Åó„Åü„Çπ„Ç≠„É´ {id, level, count}
      lastLoginDate: null,  // „É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„ÇπÁî®
      lastSaveTime: Date.now(), // „Ç™„Éï„É©„Ç§„É≥„Éú„Éº„Éä„ÇπÁî®

      // Floor system
      currentFloor: 1,
      currentStage: 1,
      currentHP: 1000,
      totalHP: 1000,

      // Dynamic Calculated Stats
      totalATK: 100, totalDEF: 0, totalCRT: 5, critMultiplier: 2.0, dps: 0
    };

    // ...

    function calcXPInfo(extraXP = 0) {
      const savedXP = studyRecords.reduce((s, r) => s + r.minutes * 10, 0);
      const totalXP = savedXP + extraXP;
      let lv = 1, xpUsed = 0, xpReq = 100;
      while (totalXP >= xpUsed + xpReq && lv < 100) {
        xpUsed += xpReq;
        lv++;
        xpReq = Math.floor(100 * Math.pow(1.15, lv - 1));
      }
      return { level: lv, currentXP: totalXP - xpUsed, nextXP: Math.floor(100 * Math.pow(1.15, lv - 1)), totalXP: totalXP };
    }
    function calcLevel() { return calcXPInfo().level; }

    function calculateTotalStats() {
      const lv = playerStats.level;
      let levelMult = 1.0;
      if (lv < 10) levelMult = 1.0;
      else if (lv < 20) levelMult = 1.3;
      else if (lv < 30) levelMult = 1.6;
      else if (lv < 40) levelMult = 2.0;
      else if (lv < 50) levelMult = 2.5;
      else if (lv < 100) levelMult = 3.0 + (lv - 50) * 0.1;
      else levelMult = 10.0;

      let wp = playerStats.equippedWeapon;
      let wpAtk = 0;
      if (!wp && weapons.length > 0) {
        for (let i = weapons.length - 1; i >= 0; i--) {
          if (lv >= weapons[i].level) { wp = weapons[i]; break; }
        }
        playerStats.equippedWeapon = wp;
      }
      if (wp) {
        wpAtk = wp.atk;
        const inv = playerStats.inventory.find(i => i.name === wp.name);
        if (inv) wpAtk = Math.floor(wp.atk * (1 + 0.15 * (inv.level - 1)) * (1 + 0.05 * ((inv.count || 1) - 1)));
      }

      let am = playerStats.equippedArmor, ac = playerStats.equippedAccessory;
      let bonusDef = 0, bonusHp = 0, bonusAtk = 0, bonusCrt = 0, bonusExp = 0, bonusAll = 0;

      if (am) {
        bonusDef += am.def;
        const inv = playerStats.inventory.find(i => i.name === am.name);
        if (inv) bonusDef = Math.floor(bonusDef * (1 + 0.15 * (inv.level - 1)));
      }
      if (ac) {
        let mult = 1.0;
        const inv = playerStats.inventory.find(i => i.name === ac.name);
        if (inv) mult = (1 + 0.15 * (inv.level - 1));
        if (ac.effect.hp) bonusHp += ac.effect.hp * mult;
        if (ac.effect.atk) bonusAtk += ac.effect.atk * mult;
        if (ac.effect.def) bonusDef += ac.effect.def * mult;
        if (ac.effect.crt) bonusCrt += ac.effect.crt;
        if (ac.effect.exp) bonusExp += ac.effect.exp;
        if (ac.effect.all) bonusAll += ac.effect.all * mult;
      }

      let skAtk = 0, skCrt = 0, skCrtM = 0;
      autoSkills.forEach(s => {
        const userSkill = playerStats.skills.find(k => k.id === s.id);
        if (userSkill) {
          const slv = userSkill.level, mult = 1 + (slv - 1) * 0.2;
          if (s.effect.atkBonus) skAtk += s.effect.atkBonus * mult;
          if (s.effect.crtRate) skCrt += s.effect.crtRate + (slv > 1 ? slv : 0);
          if (s.effect.crtMulti) skCrtM += s.effect.crtMulti;
          if (s.effect.allBonus) skAtk += s.effect.allBonus * mult;
          if (s.effect.allStats) { skAtk += s.effect.allStats * mult; skCrt += (s.effect.allStats / 10) * mult; }
        }
      });

      playerStats.totalATK = Math.floor((playerStats.baseATK + bonusAtk) * levelMult * (1 + (wpAtk + skAtk + bonusAll) / 100));
      playerStats.totalDEF = bonusDef + Math.floor(bonusAll * 5);

      // HP calculation: Base HP + Bonus from equipment/skills
      const baseHP = (playerStats.totalATK * 10);
      playerStats.totalHP = baseHP + bonusHp + (bonusAll * 50);

      // Ensure currentHP is within bounds
      if (playerStats.currentHP === undefined || playerStats.currentHP > playerStats.totalHP) {
        playerStats.currentHP = playerStats.totalHP;
      }

      playerStats.totalCRT = playerStats.baseCRT + (lv * 0.2) + skCrt + bonusCrt;
      playerStats.critMultiplier = playerStats.baseCritMultiplier + skCrtM;
    }

    function refreshRPGStatsUI(extraXP = 0) {
      const info = calcXPInfo(extraXP);
      playerStats.level = info.level;
      playerStats.exp = info.currentXP;

      // Update Game Tab Stats
      const elStatHP = document.getElementById('statHP'); if (elStatHP) elStatHP.textContent = Math.floor(playerStats.currentHP);
      const elStatMaxHP = document.getElementById('statMaxHP'); if (elStatMaxHP) elStatMaxHP.textContent = playerStats.totalHP;
      const elStatATK = document.getElementById('statATK'); if (elStatATK) elStatATK.textContent = playerStats.totalATK;
      const elStatDEF = document.getElementById('statDEF'); if (elStatDEF) elStatDEF.textContent = playerStats.totalDEF;
      const elStatCRT = document.getElementById('statCRT'); if (elStatCRT) elStatCRT.textContent = playerStats.totalCRT.toFixed(1) + '%';
      const elStatGold = document.getElementById('statGold'); if (elStatGold) elStatGold.textContent = playerStats.gold + " G";
      const elStatEXP = document.getElementById('statEXP'); if (elStatEXP) elStatEXP.textContent = Math.floor(info.currentXP);

      // Update Timer Tab Stats
      const elRtAtk = document.getElementById('rtHeroATKDisplay'); if (elRtAtk) elRtAtk.textContent = playerStats.totalATK;
      const elRtDef = document.getElementById('rtHeroDEFDisplay'); if (elRtDef) elRtDef.textContent = playerStats.totalDEF;
      const elRtCrt = document.getElementById('rtHeroCRTDisplay'); if (elRtCrt) elRtCrt.textContent = playerStats.totalCRT.toFixed(1) + '%';
      const elRtGold = document.getElementById('rtHeroGoldDisplay'); if (elRtGold) elRtGold.textContent = playerStats.gold + "G";
      const elRtDps = document.getElementById('rtDPS'); if (elRtDps) elRtDps.textContent = (playerStats.dps || 0) + "/Áßí";

      // Progress Bars
      const elXpBar = document.getElementById('xpBar'); if (elXpBar) elXpBar.style.width = (info.currentXP / info.nextXP * 100) + '%';
      const elXpText = document.getElementById('xpText'); if (elXpText) elXpText.textContent = `${Math.floor(info.currentXP)} / ${info.nextXP} XP`;

      const elRtXPFill = document.getElementById('rtXPBarFill'); if (elRtXPFill) elRtXPFill.style.width = (info.currentXP / info.nextXP * 100) + '%';
      const elRtXPText = document.getElementById('rtXPText'); if (elRtXPText) elRtXPText.textContent = `EXP ${Math.floor(info.currentXP)} / ${info.nextXP}`;

      const elHeroName = document.getElementById('rtHeroName'); if (elHeroName) elHeroName.textContent = `„ÅÇ„Å™„Åü Lv.${info.level}`;
      const elHeroLevel = document.getElementById('heroLevel'); if (elHeroLevel) elHeroLevel.textContent = info.level;

      // Realtime Hero HP
      const elRtHpFill = document.getElementById('rtHeroHPFill'); if (elRtHpFill) elRtHpFill.style.width = (playerStats.currentHP / playerStats.totalHP * 100) + '%';
      const elRtHpText = document.getElementById('rtHeroHPText'); if (elRtHpText) elRtHpText.textContent = `HP ${Math.ceil(playerStats.currentHP)} / ${playerStats.totalHP}`;

      // Floor & Stage UI (Timer Tab)
      const elFloor = document.getElementById('rtFloorDisplay'); if (elFloor) elFloor.textContent = `FLOOR ${playerStats.currentFloor}`;
      const elStage = document.getElementById('rtStageDisplay'); if (elStage) elStage.textContent = `Stage ${playerStats.currentStage}/10`;

      // Adventure Tab Equipment Display
      if (playerStats.equippedWeapon) {
        const wp = playerStats.equippedWeapon;
        const elIcon = document.getElementById('advWpIcon'); if (elIcon) elIcon.textContent = wp.icon;
        const elName = document.getElementById('advWpName'); if (elName) elName.textContent = wp.name;
        const elStat = document.getElementById('advWpStat'); if (elStat) elStat.textContent = `ATK ${wp.atk}`;
      }
      if (playerStats.equippedArmor) {
        const am = playerStats.equippedArmor;
        const elIcon = document.getElementById('advAmIcon'); if (elIcon) elIcon.textContent = am.icon;
        const elName = document.getElementById('advAmName'); if (elName) elName.textContent = am.name;
        const elStat = document.getElementById('advAmStat'); if (elStat) elStat.textContent = `DEF ${am.def}`;
      }
      if (playerStats.equippedAccessory) {
        const ac = playerStats.equippedAccessory;
        const elIcon = document.getElementById('advAcIcon'); if (elIcon) elIcon.textContent = ac.icon;
        const elName = document.getElementById('advAcName'); if (elName) elName.textContent = ac.name;
        const elStat = document.getElementById('advAcStat'); if (elStat) elStat.textContent = ac.desc || 'Effect OK';
      }

      // Update Adventure Skill Grid (Passive display)
      const skGrid = document.getElementById('adventureSkillGrid');
      if (skGrid) {
        skGrid.innerHTML = '';
        playerStats.skills.forEach(sk => {
          const base = autoSkills.find(s => s.id === sk.id);
          if (base) {
            const div = document.createElement('div');
            div.className = 'passive-skill';
            div.textContent = base.icon;
            div.dataset.tooltip = `${base.name} Lv.${sk.level}`;
            skGrid.appendChild(div);
          }
        });
      }
    }

    // ... SAVE/LOAD ...
    function saveGameData() {
      const data = {
        gold: playerStats.gold,
        equippedWeaponId: playerStats.equippedWeapon ? playerStats.equippedWeapon.name : null,
        equippedArmorId: playerStats.equippedArmor ? playerStats.equippedArmor.name : null,
        equippedAccessoryId: playerStats.equippedAccessory ? playerStats.equippedAccessory.name : null,
        inventory: playerStats.inventory,
        skills: playerStats.skills,
        lastLoginDate: playerStats.lastLoginDate,
        lastSaveTime: Date.now(),
        // Progress Persistence
        currentFloor: playerStats.currentFloor || 1,
        currentStage: playerStats.currentStage || 1,
        currentHP: playerStats.currentHP
      };
      localStorage.setItem('heroGameDataV2', JSON.stringify(data));
    }

    function saveRecords() { localStorage.setItem('studyRecordsV2', JSON.stringify(studyRecords)); }
    function loadRecords() {
      const s = localStorage.getItem('studyRecordsV2');
      if (s) { studyRecords = JSON.parse(s); }
      else {
        // Migration from old key if exists
        const old = localStorage.getItem('studyRecords');
        if (old) { studyRecords = JSON.parse(old); saveRecords(); }
      }
    }
    function saveSheetData() { localStorage.setItem('sheetDataV2', JSON.stringify(sheetData)); }
    function loadSheetData() {
      const s = localStorage.getItem('sheetDataV2');
      if (s) { sheetData = JSON.parse(s); }
      else {
        // Sync from records if sheet is empty
        const tmp = {};
        studyRecords.forEach(r => {
          if (!tmp[r.date]) tmp[r.date] = {};
          if (!tmp[r.date][r.subject]) tmp[r.date][r.subject] = 0;
          tmp[r.date][r.subject] += r.minutes;
        });
        sheetData = tmp;
        saveSheetData();
      }
    }

    function loadGameData() {
      const s = localStorage.getItem('heroGameDataV2');
      loadRecords();
      loadSheetData();

      if (s) {
        const data = JSON.parse(s);
        playerStats.gold = data.gold || 0;
        playerStats.lastLoginDate = data.lastLoginDate || null;
        playerStats.lastSaveTime = data.lastSaveTime || Date.now();
        playerStats.inventory = data.inventory || [];
        playerStats.skills = data.skills || [];

        // Progress Persistence
        playerStats.currentFloor = data.currentFloor || 1;
        playerStats.currentStage = data.currentStage || 1;

        // Initial Stat Calculation (to get totalHP)
        calculateTotalStats();
        playerStats.currentHP = (data.currentHP !== undefined) ? data.currentHP : playerStats.totalHP;

        // Weapon
        if (data.equippedWeaponId) {
          const base = weapons.find(w => w.name === data.equippedWeaponId) || weapons[0];
          playerStats.equippedWeapon = base;
        } else if (data.equippedWeaponIdx !== undefined && data.equippedWeaponIdx !== -1) {
          playerStats.equippedWeapon = weapons[data.equippedWeaponIdx];
        }

        // Armor & Accessory
        if (data.equippedArmorId) playerStats.equippedArmor = armors.find(a => a.name === data.equippedArmorId);
        if (data.equippedAccessoryId) playerStats.equippedAccessory = accessories.find(a => a.name === data.equippedAccessoryId);

        checkLoginBonus();
        checkOfflineBonus();
      } else {
        playerStats.lastLoginDate = toDateKeyLocal(new Date());
        calculateTotalStats();
        playerStats.currentHP = playerStats.totalHP;
      }

      // Update UI after all data loaded
      try { updateGameUI(); } catch (e) { console.error("Initial UI error", e); }
    }

    // Unified pullGacha (10,000G) is defined later in the script.
    // 3. „Çπ„Ç≠„É´„Ç∑„Çπ„ÉÜ„É†ÔºàRPGÈ¢®Ôºâ
    const autoSkills = [
      { id: "sk_atk_1", level: 5, name: "ÈóòÂøó", type: "skill", effect: { atkBonus: 10 }, icon: "üî•", rarity: "common" },
      { id: "sk_atk_2", level: 10, name: "„Éê„Éº„Çµ„Éº„ÇØ", type: "skill", effect: { atkBonus: 15 }, icon: "üí¢", rarity: "common" },
      { id: "sk_atk_3", level: 15, name: "ÊÄ™Âäõ", type: "skill", effect: { atkBonus: 20 }, icon: "üí™", rarity: "common" },
      { id: "sk_atk_4", level: 20, name: "ÂâõÂäõ", type: "skill", effect: { atkBonus: 25 }, icon: "‚ö°", rarity: "common" },
      { id: "sk_atk_5", level: 25, name: "ÁåõÊîª", type: "skill", effect: { atkBonus: 30 }, icon: "üå™Ô∏è", rarity: "uncommon" },
      { id: "sk_atk_6", level: 30, name: "ÁãÇÊà¶Â£´„ÅÆÈ≠Ç", type: "skill", effect: { atkBonus: 40 }, icon: "üò§", rarity: "uncommon" },
      { id: "sk_atk_7", level: 35, name: "ÈóòÁ•ûÈôçËá®", type: "skill", effect: { atkBonus: 50 }, icon: "üëπ", rarity: "uncommon" },
      { id: "sk_atk_8", level: 40, name: "Ë¶öÈÜí", type: "skill", effect: { atkBonus: 60 }, icon: "‚ú®", rarity: "rare" },
      { id: "sk_atk_9", level: 45, name: "Ë∂ÖË¶öÈÜí", type: "skill", effect: { atkBonus: 80 }, icon: "üåü", rarity: "rare" },
      { id: "sk_atk_10", level: 50, name: "Ê•µÈôêÁ™ÅÁ†¥", type: "skill", effect: { atkBonus: 100 }, icon: "üí•", rarity: "rare" },
      { id: "sk_atk_11", level: 55, name: "ÁÑ°Âèå", type: "skill", effect: { atkBonus: 120 }, icon: "‚öîÔ∏è", rarity: "epic" },
      { id: "sk_atk_12", level: 60, name: "Á•ûÈÄü", type: "skill", effect: { atkBonus: 150 }, icon: "üí®", rarity: "epic" },
      { id: "sk_atk_13", level: 65, name: "Á†¥Â£äÁ•û„ÅÆÂäõ", type: "skill", effect: { atkBonus: 180 }, icon: "üî±", rarity: "epic" },
      { id: "sk_atk_14", level: 70, name: "Â§©‰∏äÂ§©‰∏ã", type: "skill", effect: { atkBonus: 220 }, icon: "üëë", rarity: "legendary" },
      { id: "sk_atk_15", level: 75, name: "ÁÑ°Èôê„ÅÆÂäõ", type: "skill", effect: { atkBonus: 260 }, icon: "‚ôæÔ∏è", rarity: "legendary" },
      { id: "sk_atk_16", level: 80, name: "Áµ∂ÂØæÂº∑ËÄÖ", type: "skill", effect: { atkBonus: 300 }, icon: "üèÜ", rarity: "legendary" },
      { id: "sk_atk_17", level: 85, name: "Á•û„ÅÆÈ†òÂüü", type: "skill", effect: { atkBonus: 350 }, icon: "üåà", rarity: "mythic" },
      { id: "sk_atk_18", level: 90, name: "Á©∂Ê•µÈÄ≤Âåñ", type: "skill", effect: { atkBonus: 400 }, icon: "ü¶æ", rarity: "mythic" },

      { id: "sk_crt_1", level: 12, name: "ÈõÜ‰∏≠", type: "skill", effect: { crtRate: 5 }, icon: "üéØ", rarity: "common" },
      { id: "sk_crt_2", level: 18, name: "ÂøÖ‰∏≠", type: "skill", effect: { crtRate: 5 }, icon: "üèπ", rarity: "common" },
      { id: "sk_crt_3", level: 24, name: "ÊÄ•ÊâÄÊîªÊíÉ", type: "skill", effect: { crtRate: 5, crtMulti: 0.2 }, icon: "üî™", rarity: "uncommon" },
      { id: "sk_crt_4", level: 32, name: "‰ºöÂøÉÁöÑ‰∏ÄÊíÉ", type: "skill", effect: { crtRate: 8, crtMulti: 0.3 }, icon: "‚ö°", rarity: "uncommon" },
      { id: "sk_crt_5", level: 38, name: "„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„Ç¢„Ç§", type: "skill", effect: { crtRate: 10, crtMulti: 0.5 }, icon: "üëÅÔ∏è", rarity: "rare" },
      { id: "sk_crt_6", level: 44, name: "ÂøÖÊÆ∫", type: "skill", effect: { crtRate: 12, crtMulti: 0.5 }, icon: "üíÄ", rarity: "rare" },
      { id: "sk_crt_7", level: 52, name: "‰∏ÄÊíÉÂøÖÊÆ∫", type: "skill", effect: { crtRate: 15, crtMulti: 1.0 }, icon: "‚öîÔ∏è", rarity: "epic" },
      { id: "sk_crt_8", level: 58, name: "Ëá¥ÂëΩÁöÑÁãôÊíÉ", type: "skill", effect: { crtRate: 18, crtMulti: 1.0 }, icon: "üéØ", rarity: "epic" },
      { id: "sk_crt_9", level: 68, name: "Á†¥ÊªÖ„ÅÆ‰∏ÄÊíÉ", type: "skill", effect: { crtRate: 20, crtMulti: 1.5 }, icon: "üí•", rarity: "legendary" },
      { id: "sk_crt_10", level: 78, name: "Á•ûÈÄüÈÄ£ÊíÉ", type: "skill", effect: { crtRate: 25, crtMulti: 2.0 }, icon: "‚ö°", rarity: "legendary" },
      { id: "sk_crt_11", level: 88, name: "Á©∂Ê•µÂøÖÊÆ∫", type: "skill", effect: { crtRate: 30, crtMulti: 3.0 }, icon: "‚ò†Ô∏è", rarity: "mythic" },

      { id: "sk_exp_1", level: 8, name: "Â≠¶Áøí", type: "skill", effect: { expBonus: 10 }, icon: "üìñ", rarity: "common" },
      { id: "sk_exp_2", level: 16, name: "Ë®òÊÜ∂Âäõ", type: "skill", effect: { expBonus: 15 }, icon: "üß†", rarity: "common" },
      { id: "sk_exp_3", level: 22, name: "ÁêÜËß£Âäõ", type: "skill", effect: { expBonus: 20 }, icon: "üí°", rarity: "uncommon" },
      { id: "sk_exp_4", level: 28, name: "Âê∏Âèé", type: "skill", effect: { expBonus: 25 }, icon: "üåä", rarity: "uncommon" },
      { id: "sk_exp_5", level: 36, name: "Áü•Ë≠òÊ¨≤", type: "skill", effect: { expBonus: 35 }, icon: "üìö", rarity: "rare" },
      { id: "sk_exp_6", level: 42, name: "Â§©Êâç", type: "skill", effect: { expBonus: 50 }, icon: "üåü", rarity: "rare" },
      { id: "sk_exp_7", level: 48, name: "Âè°Êô∫", type: "skill", effect: { expBonus: 70 }, icon: "üîÆ", rarity: "epic" },
      { id: "sk_exp_8", level: 56, name: "Ë≥¢ËÄÖ", type: "skill", effect: { expBonus: 100 }, icon: "üßô", rarity: "epic" },
      { id: "sk_exp_9", level: 64, name: "Ë®òÊÜ∂ÂÆÆÊÆø", type: "skill", effect: { expBonus: 150 }, icon: "üè∞", rarity: "legendary" },
      { id: "sk_exp_10", level: 72, name: "ÂÆåÂÖ®Ë®òÊÜ∂", type: "skill", effect: { expBonus: 200 }, icon: "üíæ", rarity: "legendary" },
      { id: "sk_exp_11", level: 82, name: "Áü•Ë≠òÁ•û", type: "skill", effect: { expBonus: 300 }, icon: "üëº", rarity: "mythic" },

      { id: "sk_sp_1", level: 26, name: "ÈÄ£ÊíÉ", type: "skill", effect: { comboBonus: 0.3 }, icon: "üåÄ", rarity: "uncommon" },
      { id: "sk_sp_2", level: 34, name: "‰π±Ëàû", type: "skill", effect: { comboBonus: 0.5 }, icon: "üí´", rarity: "uncommon" },
      { id: "sk_sp_3", level: 46, name: "ÂÖ®‰ΩìÂº∑Âåñ", type: "skill", effect: { allBonus: 10 }, icon: "üìà", rarity: "rare" },
      { id: "sk_sp_4", level: 54, name: "„Éê„ÉïÂå†", type: "skill", effect: { allBonus: 15 }, icon: "‚ú®", rarity: "epic" },
      { id: "sk_sp_5", level: 62, name: "ÈôêÁïåÁ™ÅÁ†¥", type: "skill", effect: { allBonus: 20 }, icon: "üöÄ", rarity: "epic" },
      { id: "sk_sp_6", level: 76, name: "Ëã±ÈõÑË®º", type: "skill", effect: { allBonus: 30 }, icon: "üèÖ", rarity: "legendary" },
      { id: "sk_sp_7", level: 84, name: "‰ºùË™¨Âäõ", type: "skill", effect: { allBonus: 50 }, icon: "‚≠ê", rarity: "mythic" },
      { id: "sk_sp_8", level: 92, name: "Á•ûË©±Âüü", type: "skill", effect: { allBonus: 75 }, icon: "üå†", rarity: "mythic" },

      { id: "sk_ult_1", level: 95, name: "Ë¶áËÄÖÈ¢®Ê†º", type: "skill", effect: { allStats: 100 }, icon: "üëë", rarity: "divine" },
      { id: "sk_ult_2", level: 99, name: "Á•û„ÅÆÈ†òÂüü", type: "skill", effect: { allStats: 150 }, icon: "üåå", rarity: "divine" },

      // Refactored Active Skills -> Passive
      { id: "sk_new_1", level: 50, name: "Ê≤°È†≠", type: "skill", effect: { atkBonus: 200 }, icon: "üí•", rarity: "rare" },
      { id: "sk_new_2", level: 50, name: "Ê∑±„ÅÑÈõÜ‰∏≠", type: "skill", effect: { crtRate: 10 }, icon: "üß†", rarity: "rare" },
      { id: "sk_new_3", level: 60, name: "ÈÅéÂéªÂïè„ÅÆÊ•µÊÑè", type: "skill", effect: { allStats: 50 }, icon: "üìú", rarity: "epic" }
    ];

    // Ê≠¶Âô®
    const weapons = [
      { level: 1, name: "Êú®„ÅÆÊ£í", icon: "ü™µ", atk: 0, rarity: "common" }, { level: 3, name: "„Éä„Ç§„Éï", icon: "üî™", atk: 5, rarity: "common" },
      { level: 5, name: "„Ç∑„Éß„Éº„Éà„ÇΩ„Éº„Éâ", icon: "üó°Ô∏è", atk: 15, rarity: "common" }, { level: 8, name: "„Éñ„É≠„Éº„Éâ„ÇΩ„Éº„Éâ", icon: "‚öîÔ∏è", atk: 25, rarity: "uncommon" },
      { level: 12, name: "„Éê„Éà„É´„Ç¢„ÉÉ„ÇØ„Çπ", icon: "ü™ì", atk: 40, rarity: "uncommon" }, { level: 15, name: "„É≠„É≥„Ç∞„ÇΩ„Éº„Éâ", icon: "üó°Ô∏è", atk: 55, rarity: "uncommon" },
      { level: 18, name: "„Ç∞„É¨„Éº„Éà„ÇΩ„Éº„Éâ", icon: "‚öîÔ∏è", atk: 75, rarity: "rare" }, { level: 22, name: "„Éü„Çπ„É™„É´„ÇΩ„Éº„Éâ", icon: "‚öîÔ∏è", atk: 95, rarity: "rare" },
      { level: 25, name: "ÁÇé„ÅÆÂâ£", icon: "üî•", atk: 120, rarity: "rare" }, { level: 28, name: "Ê∞∑„ÅÆÂâ£", icon: "‚ùÑÔ∏è", atk: 145, rarity: "rare" },
      { level: 32, name: "Èõ∑„ÅÆÂâ£", icon: "‚ö°", atk: 175, rarity: "epic" }, { level: 35, name: "„Éâ„É©„Ç¥„É≥„Çπ„É¨„Ç§„É§„Éº", icon: "üêâ", atk: 210, rarity: "epic" },
      { level: 38, name: "ËÅñÂâ£", icon: "‚ú®", atk: 250, rarity: "epic" }, { level: 42, name: "È≠îÂâ£", icon: "üåü", atk: 295, rarity: "epic" },
      { level: 45, name: "„Éá„Éº„É¢„É≥„Éñ„É¨„Éº„Éâ", icon: "üòà", atk: 345, rarity: "legendary" }, { level: 48, name: "Â§©‰Ωø„ÅÆÂâ£", icon: "üëº", atk: 400, rarity: "legendary" },
      { level: 52, name: "„É´„Éº„É≥„ÇΩ„Éº„Éâ", icon: "üîÆ", atk: 465, rarity: "legendary" }, { level: 55, name: "Ë¶áÁéãÂâ£", icon: "üëë", atk: 540, rarity: "legendary" },
      { level: 58, name: "Á•ûÊÆ∫„Åó„ÅÆÂâ£", icon: "‚öîÔ∏è", atk: 625, rarity: "legendary" }, { level: 62, name: "„Ç®„Çø„Éº„Éä„É´„Éñ„É¨„Éº„Éâ", icon: "‚ôæÔ∏è", atk: 720, rarity: "mythic" },
      { level: 65, name: "Á†¥ÊªÖ„ÅÆÂâ£", icon: "üíÄ", atk: 830, rarity: "mythic" }, { level: 68, name: "Ââµ‰∏ñ„ÅÆÂâ£", icon: "üåç", atk: 955, rarity: "mythic" },
      { level: 72, name: "Ê¨°ÂÖÉÂàÄ", icon: "üåÄ", atk: 1095, rarity: "mythic" }, { level: 75, name: "ÁÑ°Èôê„ÅÆÂàÉ", icon: "‚ôæÔ∏è", atk: 1255, rarity: "mythic" },
      { level: 78, name: "Áúü„ÉªÁ•ûÊÆ∫„Åó", icon: "‚ò†Ô∏è", atk: 1440, rarity: "mythic" }, { level: 82, name: "„Ç´„Ç™„Çπ„Éñ„É™„É≥„Ç¨„Éº", icon: "üå™Ô∏è", atk: 1650, rarity: "divine" },
      { level: 85, name: "„Ç∞„É©„É†", icon: "‚öîÔ∏è", atk: 1895, rarity: "divine" }, { level: 88, name: "„Ç®„ÇØ„Çπ„Ç´„É™„Éê„Éº", icon: "üëë", atk: 2175, rarity: "divine" },
      { level: 92, name: "„Ç¢„Çπ„Ç´„É≠„É≥", icon: "üêâ", atk: 2500, rarity: "divine" }, { level: 95, name: "„Ç∞„É≥„Ç∞„Éã„É´", icon: "üî±", atk: 2875, rarity: "divine" },
      { level: 99, name: "Áúü„Éª„Ç®„ÇØ„Çπ„Ç´„É™„Éê„Éº", icon: "‚ö°", atk: 3500, rarity: "divine" }
    ];

    // Èò≤ÂÖ∑ (DEF)
    const armors = [
      { level: 1, name: "Â∏É„ÅÆÊúç", icon: "üëï", def: 5, rarity: "common" },
      { level: 5, name: "ÁöÆ„ÅÆÈéß", icon: "üß•", def: 15, rarity: "common" },
      { level: 10, name: "ÈéñÂ∏∑Â≠ê", icon: "‚õìÔ∏è", def: 30, rarity: "uncommon" },
      { level: 20, name: "ÈâÑ„ÅÆÈéß", icon: "üõ°Ô∏è", def: 50, rarity: "rare" },
      { level: 30, name: "„Éü„Çπ„É™„É´„Ç¢„Éº„Éû„Éº", icon: "üí†", def: 80, rarity: "epic" },
      { level: 40, name: "„Éâ„É©„Ç¥„É≥„É°„Ç§„É´", icon: "üêâ", def: 120, rarity: "legendary" },
      { level: 50, name: "Á•û„ÅÆÈéß", icon: "‚ú®", def: 200, rarity: "mythic" }
    ];

    // „Ç¢„ÇØ„Çª„Çµ„É™„Éº (Special Stats)
    const accessories = [
      { level: 1, name: "„ÅäÂÆà„Çä", icon: "üßø", effect: { hp: 50 }, rarity: "common", desc: "HP+50" },
      { level: 5, name: "Âäõ„ÅÆÊåáËº™", icon: "üíç", effect: { atk: 20 }, rarity: "common", desc: "ATK+20" },
      { level: 10, name: "ÂÆà„Çä„ÅÆÊåáËº™", icon: "üõ°Ô∏è", effect: { def: 20 }, rarity: "uncommon", desc: "DEF+20" },
      { level: 20, name: "‰ºöÂøÉ„ÅÆÊåáËº™", icon: "‚ö°", effect: { crt: 5 }, rarity: "rare", desc: "CRT+5%" },
      { level: 30, name: "Ë≥¢ËÄÖ„ÅÆÁü≥", icon: "üíé", effect: { exp: 10 }, rarity: "epic", desc: "EXP+10%" },
      { level: 40, name: "Ë¶áÁéã„ÅÆ„Éç„ÉÉ„ÇØ„É¨„Çπ", icon: "üëë", effect: { all: 5 }, rarity: "legendary", desc: "ÂÖ®„Çπ„ÉÜ+5%" },
      { level: 50, name: "Á•û„ÅÆÁû≥", icon: "üëÅÔ∏è", effect: { all: 10, crt: 5 }, rarity: "mythic", desc: "ÂÖ®„Çπ„ÉÜ+10%, CRT+5%" }
    ];



    const subjects = ['Âä¥ÂÉçÂü∫Ê∫ñÊ≥ï', 'Âä¥ÂÉçÂÆâÂÖ®Ë°õÁîüÊ≥ï', 'Âä¥ÂÉçËÄÖÁÅΩÂÆ≥Ë£úÂÑü‰øùÈô∫Ê≥ï', 'ÈõáÁî®‰øùÈô∫Ê≥ï', 'Âä¥ÂÉç‰øùÈô∫Âæ¥ÂèéÊ≥ï', 'ÂÅ•Â∫∑‰øùÈô∫Ê≥ï', 'ÂõΩÊ∞ëÂπ¥ÈáëÊ≥ï', 'ÂéöÁîüÂπ¥Èáë‰øùÈô∫Ê≥ï', 'Á§æ‰ºö‰øùÈô∫„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò', 'Âä¥ÂÉç„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò', '„Åù„ÅÆ‰ªñ'];
    const subjectTargets = { 'Âä¥ÂÉçÂü∫Ê∫ñÊ≥ï': 120, 'Âä¥ÂÉçÂÆâÂÖ®Ë°õÁîüÊ≥ï': 80, 'Âä¥ÂÉçËÄÖÁÅΩÂÆ≥Ë£úÂÑü‰øùÈô∫Ê≥ï': 120, 'ÈõáÁî®‰øùÈô∫Ê≥ï': 120, 'Âä¥ÂÉç‰øùÈô∫Âæ¥ÂèéÊ≥ï': 70, 'ÂÅ•Â∫∑‰øùÈô∫Ê≥ï': 130, 'ÂõΩÊ∞ëÂπ¥ÈáëÊ≥ï': 150, 'ÂéöÁîüÂπ¥Èáë‰øùÈô∫Ê≥ï': 150, 'Á§æ‰ºö‰øùÈô∫„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò': 80, 'Âä¥ÂÉç„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò': 80, '„Åù„ÅÆ‰ªñ': 0 };
    const subjectColors = ['#e94560', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#6366f1', '#84cc16'];

    // ===== GAME SYSTEM DATA =====
    const titleMap = [{ min: 1, max: 5, t: 'Ë¶ãÁøí„ÅÑÊõ∏Áîü' }, { min: 6, max: 10, t: 'Ê≥ïÂæãÂàùÂøÉËÄÖ' }, { min: 11, max: 20, t: 'Âã§Âãâ„Å™Â≠¶Âæí' }, { min: 21, max: 30, t: 'Ê≥ïÂæãÊà¶Â£´' }, { min: 31, max: 40, t: 'ÁÜüÁ∑¥„ÅÆ‰øÆË°åËÄÖ' }, { min: 41, max: 50, t: 'Ê≥ï„ÅÆÂÆàË≠∑ËÄÖ' }, { min: 51, max: 60, t: '‰ºùË™¨„ÅÆÊåëÊà¶ËÄÖ' }, { min: 61, max: 70, t: 'Á§æÂä¥Â£´ÂÄôË£úÁîü' }, { min: 71, max: 80, t: 'Ê≥ïÂæã„ÅÆÈÅî‰∫∫' }, { min: 81, max: 90, t: 'ÂêàÊ†ºË´ãË≤†‰∫∫' }, { min: 91, max: 99, t: 'Á§æÂä¥Â£´„Éû„Çπ„Çø„Éº' }];
    const bosses = [
      { subject: 'Âä¥ÂÉçÂü∫Ê∫ñÊ≥ï', name: '„Éñ„É©„ÉÉ„ÇØ‰ºÅÊ•≠„ÅÆÈ≠îÁéã', icon: '\u{1F47F}', hp: 7200 },
      { subject: 'Âä¥ÂÉçÂÆâÂÖ®Ë°õÁîüÊ≥ï', name: 'Âç±Èô∫„ÅÆÊÇ™È≠î', icon: '\u{1F525}', hp: 4800 },
      { subject: 'Âä¥ÂÉçËÄÖÁÅΩÂÆ≥Ë£úÂÑü‰øùÈô∫Ê≥ï', name: 'ÁÅΩÂÆ≥„ÅÆÁï™‰∫∫', icon: '\u{1F30A}', hp: 7200 },
      { subject: 'ÈõáÁî®‰øùÈô∫Ê≥ï', name: 'Â§±Ê•≠„ÅÆÂΩ±', icon: '\u{1F47B}', hp: 7200 },
      { subject: 'Âä¥ÂÉç‰øùÈô∫Âæ¥ÂèéÊ≥ï', name: 'Âæ¥Âèé„ÅÆÈ¨º', icon: '\u{1F4B0}', hp: 4200 },
      { subject: 'ÂÅ•Â∫∑‰øùÈô∫Ê≥ï', name: 'ÁóÖÈ≠î„ÅÆÁéã', icon: '\u{1F9DF}', hp: 7800 },
      { subject: 'ÂõΩÊ∞ëÂπ¥ÈáëÊ≥ï', name: 'Âπ¥Èáë„ÅÆÂÆàË≠∑Á´ú', icon: '\u{1F409}', hp: 9000 },
      { subject: 'ÂéöÁîüÂπ¥Èáë‰øùÈô∫Ê≥ï', name: 'ÂéöÁîü„ÅÆÂ∑®‰∫∫', icon: '\u{1F9CC}', hp: 9000 },
      { subject: 'Á§æ‰ºö‰øùÈô∫„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò', name: 'Â∏∏Ë≠ò„ÅÆËø∑ÂÆÆ‰∏ª', icon: '\u{1F9E0}', hp: 4800 },
      { subject: 'Âä¥ÂÉç„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò', name: 'Âä¥ÂÉç„ÅÆË≥¢ËÄÖ', icon: '\u{1F9D9}', hp: 4800 }
    ];
    const badges = [
      { id: 'first', name: 'Âàù„ÇÅ„ÅÆ‰∏ÄÊ≠©', icon: '\u{1F463}', desc: 'Âàù„ÇÅ„Å¶ÂãâÂº∑„ÇíË®òÈå≤', check: r => r.length > 0 },
      { id: 'three', name: '‰∏âÊó•Âùä‰∏ªÂçíÊ•≠', icon: '\u{1F525}', desc: '3Êó•ÈÄ£Á∂ö„ÅßÂãâÂº∑', check: (r, c) => c >= 3 },
      { id: 'week', name: '‰∏ÄÈÄ±Èñì„ÅÆÊà¶Â£´', icon: '\u2694\uFE0F', desc: '7Êó•ÈÄ£Á∂ö„ÅßÂãâÂº∑', check: (r, c) => c >= 7 },
      { id: 'iron', name: 'ÈâÑ‰∫∫', icon: '\u{1F9BE}', desc: '30Êó•ÈÄ£Á∂ö„ÅßÂãâÂº∑', check: (r, c) => c >= 30 },
      { id: 'h100', name: '100ÊôÇÈñì„ÅÆÂ£Å', icon: '\u{1F4AA}', desc: 'Á¥ØË®à100ÊôÇÈñìÁ™ÅÁ†¥', check: r => r.reduce((s, x) => s + x.minutes, 0) >= 6000 },
      { id: 'h500', name: '„Éû„É©„ÇΩ„É≥„É©„É≥„Éä„Éº', icon: '\u{1F3C3}', desc: 'Á¥ØË®à500ÊôÇÈñìÁ™ÅÁ†¥', check: r => r.reduce((s, x) => s + x.minutes, 0) >= 30000 },
      { id: 'h1000', name: 'ÂçÉ„ÅÆÈ´ò„Åø', icon: '\u{1F451}', desc: 'Á¥ØË®à1000ÊôÇÈñìÁ™ÅÁ†¥', check: r => r.reduce((s, x) => s + x.minutes, 0) >= 60000 },
      { id: 'allsub', name: 'ÂÖ®ÁßëÁõÆÂà∂Ë¶á', icon: '\u{1F30D}', desc: 'ÂÖ®ÁßëÁõÆ„ÅßÂãâÂº∑Ë®òÈå≤„ÅÇ„Çä', check: r => { const s = new Set(r.map(x => x.subject)); return subjects.filter(x => x !== '„Åù„ÅÆ‰ªñ').every(x => s.has(x)) } },
      { id: 'marathon', name: 'Â§úÊòé„Åë„ÅÆÂ≠¶Âæí', icon: '\u{1F305}', desc: '1Êó•3ÊôÇÈñì‰ª•‰∏äÂãâÂº∑', check: r => { const d = {}; r.forEach(x => { d[x.date] = (d[x.date] || 0) + x.minutes }); return Object.values(d).some(v => v >= 180) } },
      { id: 'master', name: 'ÁßëÁõÆ„Éû„Çπ„Çø„Éº', icon: '\u{1F393}', desc: '1ÁßëÁõÆ„ÅÆÁõÆÊ®ôÊôÇÈñìÈÅîÊàê', check: r => { const d = {}; r.forEach(x => { d[x.subject] = (d[x.subject] || 0) + x.minutes }); return subjects.some(s => subjectTargets[s] > 0 && (d[s] || 0) >= subjectTargets[s] * 60) } }
    ];

    // ===== AI ADVISOR DATA =====
    const aiData = {
      'Âä¥ÂÉçÂü∫Ê∫ñÊ≥ï': { points: ['Âä¥ÂÉçÊôÇÈñì„Éª‰ºëÊÜ©„Éª‰ºëÊó•„ÅÆÂéüÂâá„Å®‰æãÂ§ñÔºà36ÂçîÂÆöÔºâ„ÅåÊúÄÈ†ªÂá∫„ÄÇÂ§âÂΩ¢Âä¥ÂÉçÊôÇÈñìÂà∂„ÅÆÁ®ÆÈ°û„Å®Ë¶Å‰ª∂„ÇÇÈáçË¶Å„ÄÇ', 'Ëß£ÈõáÂà∂Èôê„ÉªËß£Èõá‰∫àÂëä„ÅÆË¶Å‰ª∂„ÇíÊ≠£Á¢∫„Å´ÊöóË®ò„ÄÇËß£Èõá‰∫àÂëäÊâãÂΩì„ÅÆË®àÁÆóÊñπÊ≥ï„ÇÇÂá∫„Çã„ÄÇ', 'Â∞±Ê•≠Ë¶èÂâá„ÅÆ‰ΩúÊàêÁæ©ÂãôÔºàÂ∏∏ÊôÇ10‰∫∫‰ª•‰∏äÔºâ„Å®Â±äÂá∫Áæ©Âãô„ÅÆÈÅï„ÅÑ„Å´Ê≥®ÊÑè„ÄÇÁµ∂ÂØæÁöÑÂøÖË¶ÅË®òËºâ‰∫ãÈ†Ö„ÇíË¶ö„Åà„Çã„ÄÇ', 'Ë≥ÉÈáëÊîØÊâï„ÅÑ„ÅÆ5ÂéüÂâáÔºàÈÄöË≤®Êâï„ÅÑ„ÉªÁõ¥Êé•Êâï„ÅÑ„ÉªÂÖ®È°çÊâï„ÅÑ„ÉªÊØéÊúà1Âõû‰ª•‰∏ä„Éª‰∏ÄÂÆöÊúüÊó•Êâï„ÅÑÔºâ„ÅØÂøÖ„ÅöÂá∫„Çã„ÄÇ', 'Âπ¥Ê¨°ÊúâÁµ¶‰ºëÊöá„ÅÆ‰ªò‰∏éË¶Å‰ª∂Ôºà6„É∂ÊúàÁ∂ôÁ∂öÂã§Âãô„Éª8Ââ≤‰ª•‰∏äÂá∫Âã§Ôºâ„ÄÅÊó•Êï∞„ÉªÊôÇÂäπÔºà2Âπ¥Ôºâ„ÇíÊï¥ÁêÜ„ÄÇ'], strategy: 'ÈÅéÂéªÂïè„Åß„ÅÆÂá∫È°åÈ†ªÂ∫¶„ÅåÊúÄ„ÇÇÈ´ò„ÅÑÁßëÁõÆ„ÄÇÊù°Êñá„ÅÆÊï∞Â≠óÔºàÊó•Êï∞„ÄÅÊúüÈñì„ÄÅÈáëÈ°çÔºâ„ÇíÊ≠£Á¢∫„Å´Ë¶ö„Åà„Çã„Åì„Å®„ÅåÈçµ„ÄÇ' },
      'Âä¥ÂÉçÂÆâÂÖ®Ë°õÁîüÊ≥ï': { points: ['ÂÆâÂÖ®Ë°õÁîüÁÆ°ÁêÜ‰ΩìÂà∂Ôºà‰∫ãÊ•≠Â†¥Ë¶èÊ®°Âà•„ÅÆË®≠ÁΩÆÁæ©ÂãôÔºâ„ÇíË°®„ÅßÊï¥ÁêÜ„ÄÇÁ∑èÊã¨ÂÆâÂÖ®Ë°õÁîüÁÆ°ÁêÜËÄÖ„ÉªÂÆâÂÖ®ÁÆ°ÁêÜËÄÖ„ÉªË°õÁîüÁÆ°ÁêÜËÄÖ„ÉªÁî£Ê•≠Âåª„ÅÆÈÅ∏‰ªªÂü∫Ê∫ñ„ÄÇ', 'ÂÅ•Â∫∑Ë®∫Êñ≠„ÅÆÁ®ÆÈ°ûÔºà‰∏ÄËà¨„ÉªÁâπÊÆä„ÉªËá®ÊôÇÔºâ„Å®ÂÆüÊñΩÊôÇÊúü„ÇíÊ≠£Á¢∫„Å´Ë¶ö„Åà„Çã„ÄÇÁµêÊûú„ÅÆ‰øùÂ≠òÊúüÈñì„Å´„ÇÇÊ≥®ÊÑè„ÄÇ', '„Çπ„Éà„É¨„Çπ„ÉÅ„Çß„ÉÉ„ÇØÂà∂Â∫¶„ÅÆÂØæË±°‰∫ãÊ•≠Â†¥ÔºàÂ∏∏ÊôÇ50‰∫∫‰ª•‰∏äÔºâ„Å®ÂÆüÊñΩÁæ©Âãô„ÄÇÈù¢Êé•ÊåáÂ∞é„ÅÆÊµÅ„Çå„ÇÇÊääÊè°„ÄÇ', 'ÂÆâÂÖ®Ë°õÁîüÂßîÂì°‰ºöÔºàÊ•≠Á®Æ„Éª50‰∫∫‰ª•‰∏äÔºâ„Å®Ë°õÁîüÂßîÂì°‰ºöÔºà50‰∫∫‰ª•‰∏äÔºâ„ÅÆË®≠ÁΩÆÂü∫Ê∫ñ„ÅÆÈÅï„ÅÑ„ÄÇ'], strategy: 'Êï∞Â≠ó„ÅÆÊöóË®ò„ÅåÈáçË¶Å„ÄÇ‰∫ãÊ•≠Â†¥Ë¶èÊ®°„Å®Ê•≠Á®Æ„Å´„Çà„ÇãË®≠ÁΩÆÁæ©Âãô„ÅÆÈÅï„ÅÑ„ÇíË°®„Å´„Åæ„Å®„ÇÅ„Çã„Å®ÂäπÁéáÁöÑ„ÄÇ' },
      'Âä¥ÂÉçËÄÖÁÅΩÂÆ≥Ë£úÂÑü‰øùÈô∫Ê≥ï': { points: ['Ê•≠ÂãôÁÅΩÂÆ≥„Å®ÈÄöÂã§ÁÅΩÂÆ≥„ÅÆË™çÂÆöÂü∫Ê∫ñ„ÅÆÈÅï„ÅÑ„ÅåÈáçË¶Å„ÄÇ„ÄåÊ•≠ÂãôÈÅÇË°åÊÄß„Äç„Å®„ÄåÊ•≠ÂãôËµ∑Âõ†ÊÄß„Äç„ÅÆÊ¶ÇÂøµ„ÇíÁêÜËß£„Åô„Çã„ÄÇ', 'Áµ¶‰ªò„ÅÆÁ®ÆÈ°ûÔºàÁôÇÈ§ä„Éª‰ºëÊ•≠„ÉªÈöúÂÆ≥„ÉªÈÅ∫Êóè„ÉªËë¨Á•≠„ÉªÂÇ∑ÁóÖ„Éª‰ªãË≠∑Ôºâ„Å®Áµ¶‰ªòÂü∫Á§éÊó•È°ç„ÅÆË®àÁÆóÊñπÊ≥ï„ÄÇ', 'ÁâπÂà•Âä†ÂÖ•Âà∂Â∫¶„ÅÆÂØæË±°ËÄÖÔºà‰∏≠Â∞è‰∫ãÊ•≠‰∏ª„Éª‰∏Ä‰∫∫Ë¶™ÊñπÁ≠â„ÉªÊµ∑Â§ñÊ¥æÈÅ£ËÄÖÔºâ„Å®ÊâãÁ∂ö„Åç„ÄÇ', '‰∫åÊ¨°ÂÅ•Â∫∑Ë®∫Êñ≠Á≠âÁµ¶‰ªò„ÅÆË¶Å‰ª∂„ÄÇ‰∏ÄÊ¨°ÂÅ•Â∫∑Ë®∫Êñ≠„ÅßÁï∞Â∏∏ÊâÄË¶ã„Åå4È†ÖÁõÆ‰∏≠„ÅÑ„Åö„Çå„Åã„ÅßË©≤ÂΩì„ÄÇ'], strategy: 'Áµ¶‰ªò„ÅÆÁ®ÆÈ°û„Åî„Å®„ÅÆË¶Å‰ª∂„ÉªÂÜÖÂÆπ„ÉªÊúüÈñì„ÇíÊ®™Êñ≠ÁöÑ„Å´Êï¥ÁêÜ„Åô„Çã„ÄÇÈÄöÂã§ÁÅΩÂÆ≥„ÅÆ„ÄåÂêàÁêÜÁöÑ„Å™ÁµåË∑ØÂèä„Å≥ÊñπÊ≥ï„Äç„ÅÆÂà§Êñ≠Âü∫Ê∫ñ„ÇÇÈ†ªÂá∫„ÄÇ' },
      'ÈõáÁî®‰øùÈô∫Ê≥ï': { points: ['Âü∫Êú¨ÊâãÂΩì„ÅÆÂèóÁµ¶Ë¶Å‰ª∂ÔºàÈõ¢ËÅ∑Ââç2Âπ¥Èñì„Å´12„É∂Êúà‰ª•‰∏ä„ÅÆË¢´‰øùÈô∫ËÄÖÊúüÈñìÔºâ„ÉªÁµ¶‰ªòÊó•Êï∞„ÉªÂæÖÊúüÊúüÈñìÔºà7Êó•ÈñìÔºâ„ÄÇ', 'È´òÂπ¥ÈΩ¢ÈõáÁî®Á∂ôÁ∂öÁµ¶‰ªò„ÅÆÊîØÁµ¶Ë¶Å‰ª∂Ôºà60Ê≠≥‰ª•‰∏ä65Ê≠≥Êú™Ê∫Ä„ÄÅË≥ÉÈáë75%Êú™Ê∫Ä„Å´‰Ωé‰∏ãÔºâ„Å®ÊîØÁµ¶È°ç„ÅÆË®àÁÆó„ÄÇ', 'ËÇ≤ÂÖê‰ºëÊ•≠Áµ¶‰ªòÈáëÔºà‰ºëÊ•≠ÈñãÂßãÊôÇË≥ÉÈáëÊó•È°ç√óÊîØÁµ¶Êó•Êï∞„ÅÆ67%„ÄÅ6„É∂ÊúàÁµåÈÅéÂæå50%Ôºâ„ÅÆË®àÁÆóÊñπÊ≥ï„ÄÇ', 'ÊïôËÇ≤Ë®ìÁ∑¥Áµ¶‰ªò„ÅÆÁ®ÆÈ°ûÔºà‰∏ÄËà¨„ÉªÂ∞ÇÈñÄÂÆüË∑µ„ÉªÁâπÂÆö‰∏ÄËà¨Ôºâ„Å®ÊîØÁµ¶Ë¶Å‰ª∂„ÄÇÂ∞ÇÈñÄÂÆüË∑µ„ÅØÊúÄÂ§ß70%Áµ¶‰ªò„ÄÇ'], strategy: 'Êï∞Â≠ó„ÅåÈùûÂ∏∏„Å´Â§ö„ÅÑÁßëÁõÆ„ÄÇÁµ¶‰ªòÊó•Êï∞„ÅÆË°®ÔºàÂπ¥ÈΩ¢√óË¢´‰øùÈô∫ËÄÖÊúüÈñìÔºâ„ÅØÂÆåÂÖ®ÊöóË®ò„ÅåÂøÖË¶Å„ÄÇ' },
      'Âä¥ÂÉç‰øùÈô∫Âæ¥ÂèéÊ≥ï': { points: ['Ê¶ÇÁÆó‰øùÈô∫Êñô„ÉªÁ¢∫ÂÆö‰øùÈô∫Êñô„ÅÆË®àÁÆó„Å®Áî≥ÂëäÊúüÈôê„ÄÇÂπ¥Â∫¶Êõ¥Êñ∞„ÅÆÊâãÁ∂ö„Åç„ÅÆÊµÅ„Çå„ÇíÊääÊè°„ÄÇ', '„É°„É™„ÉÉ„ÉàÂà∂„ÅÆÈÅ©Áî®Ë¶Å‰ª∂ÔºàÈÄ£Á∂ö3Âπ¥Èñì100‰∫∫‰ª•‰∏äÁ≠âÔºâ„Å®Ë®àÁÆóÊñπÊ≥ï„ÄÇ', 'Á∂ôÁ∂ö‰∫ãÊ•≠„ÅÆ‰∏ÄÊã¨„Å®ÊúâÊúü‰∫ãÊ•≠„ÅÆ‰∏ÄÊã¨„ÅÆÈÅï„ÅÑ„ÄÇ„Åù„Çå„Åû„Çå„ÅÆË¶Å‰ª∂„Å®ÊâãÁ∂ö„Åç„ÄÇ', 'Âä¥ÂÉç‰øùÈô∫Êñô„ÅÆË≤†ÊãÖÂâ≤Âêà„ÄÇÈõáÁî®‰øùÈô∫„ÅØ‰∫ãÊ•≠‰∏ª„Å®Âä¥ÂÉçËÄÖ„ÅßË≤†ÊãÖ„ÄÅÂä¥ÁÅΩ‰øùÈô∫„ÅØÂÖ®È°ç‰∫ãÊ•≠‰∏ªË≤†ÊãÖ„ÄÇ'], strategy: 'Ë®àÁÆóÂïèÈ°å„ÅåÂá∫„ÇÑ„Åô„ÅÑ„ÄÇÊ¶ÇÁÆó‰øùÈô∫Êñô„Å®Á¢∫ÂÆö‰øùÈô∫Êñô„ÅÆË®àÁÆóÊâãÈ†Ü„ÇíÁπ∞„ÇäËøî„ÅóÁ∑¥Áøí„Åô„Çã„ÄÇ' },
      'ÂÅ•Â∫∑‰øùÈô∫Ê≥ï': { points: ['Ë¢´‰øùÈô∫ËÄÖË≥áÊ†º„ÅÆÂèñÂæóÊó•ÔºàÂÖ•Á§æÊó•Ôºâ„ÉªÂñ™Â§±Êó•ÔºàÈÄÄËÅ∑Êó•„ÅÆÁøåÊó•Ôºâ„ÅÆËÄÉ„ÅàÊñπ„ÄÇÈÅ©Áî®Èô§Â§ñËÄÖ„ÇÇË¶ö„Åà„Çã„ÄÇ', 'Ë¢´Êâ∂È§äËÄÖ„ÅÆË™çÂÆöÂü∫Ê∫ñÔºàÂπ¥Âèé130‰∏áÂÜÜÊú™Ê∫Ä„ÄÅ60Ê≠≥‰ª•‰∏ä„ÉªÈöúÂÆ≥ËÄÖ„ÅØ180‰∏áÂÜÜÊú™Ê∫ÄÔºâ„ÄÇ', 'ÂÇ∑ÁóÖÊâãÂΩìÈáëÔºàÊ®ôÊ∫ñÂ†±ÈÖ¨Êó•È°ç„ÅÆ2/3„ÄÅÊúÄÈï∑1Âπ¥6„É∂ÊúàÔºâ„ÉªÂá∫Áî£ÊâãÂΩìÈáë„ÅÆÊîØÁµ¶Ë¶Å‰ª∂„Å®Ë®àÁÆó„ÄÇ', 'È´òÈ°çÁôÇÈ§äË≤ªÂà∂Â∫¶„ÅÆËá™Â∑±Ë≤†ÊãÖÈôêÂ∫¶È°ç„ÄÇÊâÄÂæóÂå∫ÂàÜ„Å´„Çà„ÇãË®àÁÆóÂºè„ÇíË¶ö„Åà„Çã„ÄÇ', '‰ªªÊÑèÁ∂ôÁ∂öË¢´‰øùÈô∫ËÄÖ„ÅÆË¶Å‰ª∂ÔºàË≥áÊ†ºÂñ™Â§±Êó•ÂâçÊó•„Åæ„ÅßÁ∂ôÁ∂ö2„É∂Êúà‰ª•‰∏ä„ÄÅ20Êó•‰ª•ÂÜÖ„Å´Â±äÂá∫Ôºâ„ÄÇ'], strategy: 'Á§æ‰ºö‰øùÈô∫„ÅÆ‰∏≠Ê†∏ÁßëÁõÆ„ÄÇÁµ¶‰ªò„ÅÆÁ®ÆÈ°û„ÅåÂ§ö„ÅÑ„ÅÆ„Åß„ÄÅ‰∏ÄË¶ßË°®„Çí‰Ωú„Å£„Å¶Ê®™Êñ≠ÁöÑ„Å´ÊØîËºÉ„Åô„Çã„Å®ÂäπÊûúÁöÑ„ÄÇ' },
      'ÂõΩÊ∞ëÂπ¥ÈáëÊ≥ï': { points: ['Ë¢´‰øùÈô∫ËÄÖ„ÅÆÁ®ÆÂà•ÔºàÁ¨¨1Âè∑ÔºöËá™Âñ∂Ê•≠Á≠â„ÄÅÁ¨¨2Âè∑Ôºö‰ºöÁ§æÂì°Á≠â„ÄÅÁ¨¨3Âè∑ÔºöÁ¨¨2Âè∑„ÅÆË¢´Êâ∂È§äÈÖçÂÅ∂ËÄÖÔºâ„ÄÇ', 'ËÄÅÈΩ¢Âü∫Á§éÂπ¥Èáë„ÅÆÂèóÁµ¶Ë≥áÊ†ºÊúüÈñìÔºà10Âπ¥‰ª•‰∏äÔºâ„Å®Âπ¥ÈáëÈ°ç„ÅÆË®àÁÆóÔºàÊ∫ÄÈ°ç√óÁ¥ç‰ªòÊúàÊï∞/480Ôºâ„ÄÇ', 'ÈöúÂÆ≥Âü∫Á§éÂπ¥Èáë„ÅÆÁ≠âÁ¥öÔºà1Á¥ö„Éª2Á¥ö„ÅÆ„ÅøÔºâ„Å®ÊîØÁµ¶Ë¶Å‰ª∂„ÄÇÂàùË®∫Êó•Ë¶Å‰ª∂„Å®‰øùÈô∫ÊñôÁ¥ç‰ªòË¶Å‰ª∂„Å´Ê≥®ÊÑè„ÄÇ', 'ÈÅ∫ÊóèÂü∫Á§éÂπ¥Èáë„ÅÆÂèóÁµ¶Ê®©ËÄÖÔºàÂ≠ê„ÅÆ„ÅÇ„ÇãÈÖçÂÅ∂ËÄÖ„Åæ„Åü„ÅØÂ≠êÔºâ„Å®ÊîØÁµ¶Ë¶Å‰ª∂„ÄÇ', '‰øùÈô∫ÊñôÂÖçÈô§Âà∂Â∫¶„ÅÆÁ®ÆÈ°ûÔºàÂÖ®È°ç„Éª3/4„ÉªÂçäÈ°ç„Éª1/4ÂÖçÈô§„ÄÅÂ≠¶ÁîüÁ¥ç‰ªòÁâπ‰æã„ÄÅÁ¥ç‰ªòÁå∂‰∫àÔºâ„Å®Âπ¥ÈáëÈ°ç„Å∏„ÅÆÂèçÊò†„ÄÇ'], strategy: 'Âπ¥ÈáëÁßëÁõÆ„ÅØÈÖçÁÇπ„ÅåÂ§ß„Åç„ÅÑ„ÄÇË®àÁÆóÂïèÈ°å„Å´ÂÇô„Åà„Å¶„ÄÅÂπ¥ÈáëÈ°ç„ÅÆË®àÁÆóÂºè„Å®Âä†ÁÆóÈ°ç„ÇíÊ≠£Á¢∫„Å´Ë¶ö„Åà„Çã„ÄÇ' },
      'ÂéöÁîüÂπ¥Èáë‰øùÈô∫Ê≥ï': { points: ['ËÄÅÈΩ¢ÂéöÁîüÂπ¥Èáë„ÅÆÊîØÁµ¶ÈñãÂßãÂπ¥ÈΩ¢„ÅÆÁµåÈÅéÊé™ÁΩÆÔºàÁîüÂπ¥ÊúàÊó•„Å´„Çà„ÇãÊÆµÈöéÁöÑÂºï‰∏ä„ÅíÔºâ„ÄÇÁî∑Â•≥„ÅÆÈÅï„ÅÑ„Å´Ê≥®ÊÑè„ÄÇ', 'Âú®ËÅ∑ËÄÅÈΩ¢Âπ¥Èáë„ÅÆ‰ªïÁµÑ„ÅøÔºàÂü∫Êú¨ÊúàÈ°çÔºãÁ∑èÂ†±ÈÖ¨ÊúàÈ°çÁõ∏ÂΩìÈ°ç„Åå50‰∏áÂÜÜË∂Ö„Åß‰∏ÄÈÉ®ÊîØÁµ¶ÂÅúÊ≠¢Ôºâ„ÄÇ', 'Âä†Áµ¶Âπ¥ÈáëÈ°ç„ÅÆÂä†ÁÆóË¶Å‰ª∂ÔºàË¢´‰øùÈô∫ËÄÖÊúüÈñì20Âπ¥‰ª•‰∏ä„ÄÅ65Ê≠≥Êú™Ê∫Ä„ÅÆÈÖçÂÅ∂ËÄÖÁ≠âÔºâ„ÄÇÊåØÊõøÂä†ÁÆó„Å®„ÅÆÈñ¢‰øÇ„ÄÇ', 'ÈöúÂÆ≥ÂéöÁîüÂπ¥Èáë„ÅÆÁ≠âÁ¥öÔºà1Á¥ö„Äú3Á¥öÔºãÈöúÂÆ≥ÊâãÂΩìÈáëÔºâ„Å®ÊîØÁµ¶Ë¶Å‰ª∂„ÄÇÈöúÂÆ≥Âü∫Á§éÂπ¥Èáë„Å®„ÅÆÈÅï„ÅÑ„ÄÇ', 'Èõ¢Â©öÊôÇ„ÅÆÂπ¥ÈáëÂàÜÂâ≤ÔºàÂêàÊÑèÂàÜÂâ≤„Å®3Âè∑ÂàÜÂâ≤„ÅÆÈÅï„ÅÑÔºâ„ÄÇÊåâÂàÜÂâ≤Âêà„ÅÆ‰∏äÈôêÔºà1/2Ôºâ„Å´Ê≥®ÊÑè„ÄÇ'], strategy: 'ÂõΩÊ∞ëÂπ¥ÈáëÊ≥ï„Å®„ÅÆÊ®™Êñ≠Â≠¶Áøí„Åå‰∏çÂèØÊ¨†„ÄÇ‰∏°Ê≥ï„ÅÆÁµ¶‰ªò„ÇíÂØæÊØî„Åï„Åõ„Å¶Ë¶ö„Åà„Çã„Å®ÁêÜËß£„ÅåÊ∑±„Åæ„Çã„ÄÇ' },
      'Á§æ‰ºö‰øùÈô∫„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò': { points: ['ÂõΩÊ∞ëÂÅ•Â∫∑‰øùÈô∫Ê≥ï„ÅÆË¢´‰øùÈô∫ËÄÖ„Å®‰øùÈô∫Áµ¶‰ªò„ÅÆÂü∫Êú¨„ÄÇÈÉΩÈÅìÂ∫úÁúå„Å®Â∏ÇÁî∫Êùë„ÅÆÂΩπÂâ≤ÂàÜÊãÖ„ÄÇ', 'È´òÈΩ¢ËÄÖÂåªÁôÇÁ¢∫‰øùÊ≥ï„ÅÆÂæåÊúüÈ´òÈΩ¢ËÄÖÂåªÁôÇÂà∂Â∫¶Ôºà75Ê≠≥‰ª•‰∏äÔºâ„ÅÆ‰ªïÁµÑ„Åø„ÄÇ', '‰ªãË≠∑‰øùÈô∫Ê≥ï„ÅÆË¢´‰øùÈô∫ËÄÖÔºàÁ¨¨1Âè∑Ôºö65Ê≠≥‰ª•‰∏ä„ÄÅÁ¨¨2Âè∑Ôºö40„Äú64Ê≠≥Ôºâ„Å®Áµ¶‰ªò„ÅÆÁ®ÆÈ°û„ÄÇ', 'Á§æ‰ºö‰øùÈô∫Âä¥ÂãôÂ£´Ê≥ï„ÅÆÊ•≠ÂãôÁØÑÂõ≤Ôºà1Âè∑„Éª2Âè∑„Éª3Âè∑Ê•≠ÂãôÔºâ„Å®Ê¨†Ê†º‰∫ãÁî±„ÄÇ', 'Á¢∫ÂÆöÊã†Âá∫Âπ¥ÈáëÊ≥ïÔºà‰ºÅÊ•≠ÂûãDC„ÉªÂÄã‰∫∫ÂûãiDeCoÔºâ„Å®Á¢∫ÂÆöÁµ¶‰ªò‰ºÅÊ•≠Âπ¥ÈáëÊ≥ï„ÅÆÊ¶ÇË¶Å„ÄÇ'], strategy: 'ÁØÑÂõ≤„ÅåÂ∫É„ÅÑ„ÅÆ„ÅßÊ∑±ËøΩ„ÅÑ„ÅØÁ¶ÅÁâ©„ÄÇÈÅéÂéªÂïè„ÅßÂá∫„ÅüË´ñÁÇπ„Çí‰∏≠ÂøÉ„Å´„ÄÅÂêÑÊ≥ïÂæã„ÅÆÂü∫Êú¨‰∫ãÈ†Ö„ÇíÊäº„Åï„Åà„Çã„ÄÇ' },
      'Âä¥ÂÉç„Å´Èñ¢„Åô„Çã‰∏ÄËà¨Â∏∏Ë≠ò': { points: ['Âä¥ÂÉçÂ•ëÁ¥ÑÊ≥ï„ÅÆÂü∫Êú¨ÂéüÂâá„Å®ÁÑ°ÊúüËª¢Êèõ„É´„Éº„É´Ôºà5Âπ¥Ë∂Ö„ÅÆÊúâÊúüÂ•ëÁ¥Ñ‚ÜíÁÑ°ÊúüËª¢ÊèõÁî≥ËæºÊ®©Ôºâ„ÄÇ', 'Âä¥ÂÉçÁµÑÂêàÊ≥ï„ÅÆ‰∏çÂΩìÂä¥ÂÉçË°åÁÇ∫„ÅÆÈ°ûÂûãÔºà‰∏çÂà©ÁõäÂèñÊâ±„ÅÑ„ÉªÈªÑÁä¨Â•ëÁ¥Ñ„ÉªÂõ£‰∫§ÊãíÂê¶„ÉªÊîØÈÖç‰ªãÂÖ•Ôºâ„ÄÇ', 'Áî∑Â•≥ÈõáÁî®Ê©ü‰ºöÂùáÁ≠âÊ≥ï„ÅÆ„Éù„Ç§„É≥„Éà„ÄÇÈñìÊé•Â∑ÆÂà•„ÅÆÁ¶ÅÊ≠¢„Å®„Éû„Çø„Éã„ÉÜ„Ç£„Éè„É©„Çπ„É°„É≥„ÉàÂØæÁ≠ñ„ÄÇ', '„Éë„Éº„Éà„Çø„Ç§„É†„ÉªÊúâÊúüÈõáÁî®Âä¥ÂÉçÊ≥ï„ÅÆÂùáÁ≠âÂæÖÈÅá„ÉªÂùáË°°ÂæÖÈÅá„ÅÆËÄÉ„ÅàÊñπ„ÄÇÂêå‰∏ÄÂä¥ÂÉçÂêå‰∏ÄË≥ÉÈáë„ÄÇ', 'ÊúÄ‰ΩéË≥ÉÈáëÊ≥ï„ÅÆÈÅ©Áî®„Å®ÂäπÂäõ„ÄÇÂú∞ÂüüÂà•ÊúÄ‰ΩéË≥ÉÈáë„Å®ÁâπÂÆöÊúÄ‰ΩéË≥ÉÈáë„ÅÆÈÅï„ÅÑ„ÄÇ'], strategy: 'Âä¥ÂÉçÁµåÊ∏à„ÅÆÁµ±Ë®à„Éá„Éº„ÇøÔºàÂÆåÂÖ®Â§±Ê•≠Áéá„ÄÅÊúâÂäπÊ±Ç‰∫∫ÂÄçÁéáÁ≠âÔºâ„ÇÇÂá∫È°å„Åï„Çå„Çã„ÄÇÁôΩÊõ∏„ÅÆÊ¶ÇË¶Å„Å´ÁõÆ„ÇíÈÄö„Åó„Å¶„Åä„Åè„ÄÇ' }
    };


    // ===== DATE/SHIFT =====
    function updateDateDisplay() {
      const t = new Date(), ds = t.getFullYear() + '/' + String(t.getMonth() + 1).padStart(2, '0') + '/' + String(t.getDate()).padStart(2, '0');
      const wd = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][t.getDay()];
      document.getElementById('dateDisplay').textContent = '\u{1F4C5} ' + ds + ' (' + wd + ')';
      document.getElementById('recordDate').value = toDateKeyLocal(t);
    }
    function getShiftType(date) {
      const s1 = new Date('2026-02-06'), s2 = new Date('2026-02-10'), s3 = new Date('2026-02-12');
      if (date < s1) return 'late'; if (date < s2) return 'early'; if (date < s3) return 'rest';
      const d = Math.floor((date - s3) / (864e5)), p = d % 12;
      if (p < 4) return 'late'; if (p < 6) return 'rest'; if (p < 10) return 'early'; return 'rest';
    }

    // ===== TAB SWITCH =====
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tab + '-tab').classList.add('active');
      if (tab === 'stats') updateAdvancedStats();
      if (tab === 'sheet') updateSheetSums();
      if (tab === 'log') updateLogTable();
      if (tab === 'report') updateReport();
      if (tab === 'game') updateGameUI();
      if (tab === 'shop') updateShopUI();
    }
    // AI Advisor removed as requested.

    function updateReport() {
      const now = new Date();
      const todayKey = toDateKeyLocal(now);
      const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - now.getDay()); // Sun
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const startOfYear = new Date(now.getFullYear(), 0, 1);

      let dToday = 0, dWeek = 0, dMonth = 0, dYear = 0;
      // Use studyRecords for calculation
      studyRecords.forEach(r => {
        const rDate = new Date(r.date);
        const m = r.minutes;
        if (r.date === todayKey) dToday += m;
        if (rDate >= startOfWeek) dWeek += m;
        if (rDate >= startOfMonth) dMonth += m;
        if (rDate >= startOfYear) dYear += m;
      });

      // Update Static Elements
      const elToday = document.getElementById('reportToday');
      if (elToday) elToday.textContent = minutesToTimeString(dToday);

      const elWeek = document.getElementById('reportWeek');
      if (elWeek) elWeek.textContent = minutesToTimeString(dWeek);

      const elMonth = document.getElementById('reportMonth');
      if (elMonth) elMonth.textContent = minutesToTimeString(dMonth);

      const elYear = document.getElementById('reportYear');
      if (elYear) elYear.textContent = minutesToTimeString(dYear);

      // Update Detail Title
      const detailTitle = document.getElementById('reportDetailTitle');
      if (detailTitle) {
        detailTitle.textContent = currentReportType === 'today' ? '‰ªäÊó•„ÅÆË©≥Á¥∞' : currentReportType === 'week' ? '‰ªäÈÄ±„ÅÆË©≥Á¥∞' : '‰ªäÊúà„ÅÆË©≥Á¥∞';
      }

      // Update Details List
      if (typeof updateReportDetails === 'function') {
        updateReportDetails(currentReportType, todayKey, startOfWeek, startOfMonth);
      } else {
        const list = document.getElementById('reportDetailList');
        if (list) list.innerHTML = "<div style='color:#666;'>Ë©≥Á¥∞Ë™≠„ÅøËæº„Åø‰∏≠...</div>";
      }

      if (typeof updateGoalCards === 'function') updateGoalCards(dToday);
    }
    function updateReportDetails(type, todayKey, startOfWeek, startOfMonth) {
      const list = document.getElementById('reportDetailList');
      if (!list) return;

      // Filter records
      const filtered = studyRecords.filter(r => {
        const rDate = new Date(r.date);
        if (type === 'today') return r.date === todayKey;
        if (type === 'week') return rDate >= startOfWeek;
        if (type === 'month') return rDate >= startOfMonth;
        return false;
      });

      // Group by Subject
      const sums = {};
      filtered.forEach(r => {
        if (!sums[r.subject]) sums[r.subject] = 0;
        sums[r.subject] += r.minutes;
      });

      if (Object.keys(sums).length === 0) {
        list.innerHTML = "<div style='color:#666; font-style:italic;'>„Éá„Éº„Çø„Å™„Åó</div>";
        return;
      }

      // Sort by duration desc
      const sorted = Object.entries(sums).sort((a, b) => b[1] - a[1]);

      let html = '<div style="display:flex; flex-direction:column; gap:8px;">';
      sorted.forEach(([sub, min]) => {
        html += `
            <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2); padding:8px 12px; border-radius:6px;">
                <span>${sub}</span>
                <span style="font-weight:bold;">${minutesToTimeString(min)}</span>
            </div>
        `;
      });
      html += '</div>';
      list.innerHTML = html;
    }

    // ===== TIMER =====
    function startTimer() {
      const sub = document.getElementById('subject').value;
      if (isPaused) { startTime = Date.now() - pausedTime; isPaused = false; } else { startTime = Date.now() - elapsedTime; }
      timerInterval = setInterval(updateTimer, 100);
      document.getElementById('startBtn').disabled = true; document.getElementById('stopBtn').disabled = false;
      document.getElementById('subject').disabled = true; hideMessage();

      // „É™„Ç¢„É´„Çø„Ç§„É†Êà¶ÈóòÈñãÂßã
      startBattleLoop();
    }
    function stopTimer() {
      clearInterval(timerInterval); pausedTime = Date.now() - startTime; isPaused = true;
      document.getElementById('startBtn').disabled = false; document.getElementById('stopBtn').disabled = true;
      updateElapsedInfo();

      // „É™„Ç¢„É´„Çø„Ç§„É†Êà¶ÈóòÂÅúÊ≠¢
      stopBattleLoop();
    }
    function resetTimer() {
      clearInterval(timerInterval); startTime = null; elapsedTime = 0; pausedTime = 0; isPaused = false;
      document.getElementById('timer').textContent = '00:00:00';
      document.getElementById('startBtn').disabled = false; document.getElementById('stopBtn').disabled = true;
      document.getElementById('subject').disabled = false; document.getElementById('elapsedInfo').textContent = ''; hideMessage();
    }
    function updateTimer() {
      elapsedTime = Date.now() - startTime;
      const h = Math.floor(elapsedTime / 36e5), m = Math.floor((elapsedTime % 36e5) / 6e4), s = Math.floor((elapsedTime % 6e4) / 1e3);
      document.getElementById('timer').textContent = pad(h) + ':' + pad(m) + ':' + pad(s);

      // Êà¶Èóò„É≠„Ç∏„ÉÉ„ÇØ„ÅÆÂÆüË°å„Çø„Ç§„Éü„É≥„Ç∞Ôºà1Áßí„Åî„Å®„Å™„Å©„ÅÆË™øÊï¥„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„Åì„Åì„Å´Ôºâ
    }

    // ===== NEW: REAL-TIME BATTLE LOGIC =====
    // ===== STATS & BATTLE LOGIC =====
    function startBattleLoop() {
      if (!currentEnemy) spawnNextEnemy();
      if (battleInterval) clearInterval(battleInterval);
      battleInterval = setInterval(performRealtimeAttack, 1000);
      logBattle("‚öîÔ∏è Êà¶ÈóòÈñãÂßãÔºÅÂãâÂº∑„Åó„Å¶Êïµ„ÇíÂÄí„ÅõÔºÅ", "spawn");
    }

    function stopBattleLoop() {
      if (battleInterval) clearInterval(battleInterval);
      battleInterval = null;
      playerStats.dps = 0;
      updateRealtimeStatsUI();
      logBattle("‚òï ‰ºëÊÜ©‰∏≠...", "normal");
    }

    // Active Buffs
    let activeBuffs = { focus: false, focusEndTime: 0 };

    function performRealtimeAttack() {
      if (!currentEnemy) return;
      calculateTotalStats();

      // --- HERO ATTACK ---
      let crtRate = playerStats.totalCRT;
      if (activeBuffs.focus) crtRate += 50;

      const isCritical = Math.random() * 100 < crtRate;
      let damage = playerStats.totalATK;
      if (isCritical) damage = Math.floor(damage * playerStats.critMultiplier);

      // Variance
      damage = Math.floor(damage * (0.9 + Math.random() * 0.2));

      // Hero deals damage
      currentEnemy.hp -= damage;
      attackDamageHistory.push({ time: Date.now(), dmg: damage });
      calculateDPS();

      showFloatingDamage(damage, isCritical);
      if (isCritical) logBattle(`üí• ‰ºöÂøÉÔºÅ ${damage}`, "critical");
      else logBattle(`‚öîÔ∏è ÊîªÊíÉ ${damage}`);

      // --- MONSTER ATTACK ---
      if (currentEnemy.hp > 0) {
        // Monster damage logic: ATK - Half of Player DEF
        let monsterDmg = currentEnemy.atk - (playerStats.totalDEF / 2);
        monsterDmg = Math.max(1, Math.floor(monsterDmg * (0.9 + Math.random() * 0.2)));

        playerStats.currentHP -= monsterDmg;
        logBattle(`üëæ ${currentEnemy.name}„ÅÆÊîªÊíÉÔºÅ ${monsterDmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ`, "error");

        if (playerStats.currentHP <= 0) {
          onPlayerDefeated();
          return;
        }
      }

      updateEnemyDisplay();
      updateRealtimeStatsUI();

      if (currentEnemy.hp <= 0) onEnemyDefeated();
    }

    function onPlayerDefeated() {
      logBattle("üí• „ÅÇ„Å™„Åü„ÅØÂäõÂ∞Ω„Åç„Åü...", "error");
      // Go back to previous floor, stage 1
      playerStats.currentFloor = Math.max(1, playerStats.currentFloor - 1);
      playerStats.currentStage = 1;

      currentEnemy = null;
      saveGameData();

      // Full heal for restart
      playerStats.currentHP = playerStats.totalHP;
      updateRealtimeStatsUI();

      logBattle(`üìâ FLOOR ${playerStats.currentFloor} „Å´Êàª„Åï„Çå„Åæ„Åó„Åü„ÄÇ‰øÆË°å„ÅóÁõ¥„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ`, "error");
      setTimeout(spawnNextEnemy, 2000);
    }

    function calculateDPS() {
      const now = Date.now();
      attackDamageHistory = attackDamageHistory.filter(h => now - h.time < 5000);
      const total = attackDamageHistory.reduce((s, h) => s + h.dmg, 0);
      playerStats.dps = Math.floor(total / 5);
    }

    function onEnemyDefeated() {
      const goldEarned = currentEnemy.rewardGold;
      playerStats.gold += goldEarned;
      logBattle(`üíÄ ${currentEnemy.name} „ÇíÊíÉÁ†¥ÔºÅ ${goldEarned}G Áç≤ÂæóÔºÅ`, "defeat");

      // Visual Juice: Explosion & Shake
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 40);
      document.body.classList.add('screen-shake');
      setTimeout(() => document.body.classList.remove('screen-shake'), 300);

      if (currentEnemy.isBoss) {
        // Boss Defeated Animation
        const bossOverlay = document.createElement('div');
        bossOverlay.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:20000;display:flex;align-items:center;justify-content:center;flex-direction:column;animation:fadeIn 1s;pointer-events:none;";
        bossOverlay.innerHTML = `
          <div style="font-size:80px; margin-bottom:20px; animation:bounce 1s infinite text-shadow:0 0 20px #ffd700;">üëë</div>
          <div style="font-size:40px; color:#ffd700; font-weight:900; letter-spacing:10px; text-shadow:0 0 10px #000;">BOSS DEFEATED</div>
          <div style="font-size:20px; color:white; margin-top:20px;">FLOOR CLEAR!</div>
        `;
        document.body.appendChild(bossOverlay);
        setTimeout(() => { bossOverlay.style.animation = "fadeOut 1s forwards"; setTimeout(() => bossOverlay.remove(), 1000); }, 3000);
      }

      // Progression
      if (playerStats.currentStage < 10) {
        playerStats.currentStage++;
      } else {
        playerStats.currentFloor++;
        playerStats.currentStage = 1;
        logBattle(`üéä FLOOR ${playerStats.currentFloor} „Å´ÈÄ≤Âá∫„Åó„ÅüÔºÅ`, "critical");
        // Major explosion on floor clear
        spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 100);
      }

      saveGameData();
      updateGameUI(); // Sync gold and other stats
      currentEnemy = null;
      setTimeout(spawnNextEnemy, 800);
    }

    function updateEnemyDisplay() {
      if (!currentEnemy) return;
      const elIcon = document.getElementById('enemyIcon'); if (elIcon) elIcon.textContent = currentEnemy.icon;
      const elName = document.getElementById('enemyName');
      if (elName) {
        elName.textContent = currentEnemy.name;
        elName.style.color = currentEnemy.isBoss ? "#ffd700" : (currentEnemy.isElite ? "#ff00ff" : "white");
        elName.style.textShadow = currentEnemy.isBoss ? "0 0 10px #f59e0b" : "none";
      }
      const hpPct = Math.max(0, (currentEnemy.hp / currentEnemy.maxHp) * 100);
      const elBar = document.getElementById('enemyHPBar'); if (elBar) elBar.style.width = hpPct + '%';
      const elHpTxt = document.getElementById('enemyHPText'); if (elHpTxt) elHpTxt.textContent = `${Math.floor(currentEnemy.hp)} / ${currentEnemy.maxHp}`;
      const elAtk = document.getElementById('enemyATK'); if (elAtk) elAtk.textContent = currentEnemy.atk;
      const elDef = document.getElementById('enemyDEF'); if (elDef) elDef.textContent = currentEnemy.def;
      const elGold = document.getElementById('enemyGold'); if (elGold) elGold.textContent = currentEnemy.rewardGold + "G";
      const elLv = document.getElementById('enemyLevel'); if (elLv) elLv.textContent = playerStats.level;
    }

    function spawnNextEnemy() {
      const floor = playerStats.currentFloor;
      const stage = playerStats.currentStage;
      const isBoss = stage === 10;
      const isElite = !isBoss && Math.random() < 0.05;

      // Enemy level and stats scaling
      const level = (floor - 1) * 10 + stage;
      let baseHP = Math.floor(100 * Math.pow(1.2, level - 1));
      let baseATK = Math.floor(10 * Math.pow(1.15, level - 1));
      let baseDEF = Math.floor(5 * Math.pow(1.15, level - 1));

      if (isBoss) {
        baseHP *= 5; baseATK *= 1.5; baseDEF *= 2;
      } else if (isElite) {
        baseHP *= 2.5; baseATK *= 1.3; baseDEF *= 1.5;
      }

      let name, icon;
      if (isBoss) {
        const bossPool = [
          { name: "Âè§„ÅÆ„Ç¥„Éº„É¨„É†", icon: "üóø" },
          { name: "„Éâ„É©„Ç¥„É≥", icon: "üêâ" },
          { name: "„Éá„Éº„É¢„É≥„É≠„Éº„Éâ", icon: "üëπ" },
          { name: "„Éï„Çß„Éã„ÉÉ„ÇØ„Çπ", icon: "üî•" },
          { name: "„É™„ÉÉ„ÉÅÁéã", icon: "üíÄ" }
        ];
        const b = bossPool[Math.floor(Math.random() * bossPool.length)];
        name = "BOSS " + b.name;
        icon = b.icon;
      } else {
        const enemyTypes = [
          { name: "„Çπ„É©„Ç§„É†", icon: "üíß" }, { name: "„Ç¥„Éñ„É™„É≥", icon: "üë∫" },
          { name: "„Çπ„Ç±„É´„Éà„É≥", icon: "üíÄ" }, { name: "„Ç™„Éº„ÇØ", icon: "üêó" },
          { name: "„Ç¶„É´„Éï", icon: "üê∫" }, { name: "„Éê„ÉÉ„Éà", icon: "ü¶á" },
          { name: "„Çπ„Éë„Ç§„ÉÄ„Éº", icon: "üï∑Ô∏è" }, { name: "„Ç≥„Éñ„É©", icon: "üêç" }
        ];
        const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
        name = (isElite ? "‚òÖELITE‚òÖ " : "") + type.name;
        icon = type.icon;
      }

      currentEnemy = {
        name: `${name} (Lv.${level})`,
        icon: icon,
        maxHp: baseHP, hp: baseHP, atk: baseATK, def: baseDEF,
        // Rebalanced Gold Scaling: 1.025x exponent (Optimal for mid-late game addictiveness)
        rewardGold: Math.floor((20 + level * 5) * Math.pow(1.025, level - 1) * (isBoss ? 10 : (isElite ? 4 : 1)) * (0.8 + Math.random() * 0.4)),
        isElite: isElite,
        isBoss: isBoss
      };

      // Full recovery every time a new enemy spawns
      playerStats.currentHP = playerStats.totalHP;

      updateEnemyDisplay();

      // Update Timer Tab Floor/Stage Display
      const elFloor = document.getElementById('rtFloorDisplay'); if (elFloor) elFloor.textContent = `FLOOR ${floor}`;
      const elStage = document.getElementById('rtStageDisplay'); if (elStage) elStage.textContent = `Stage ${stage}/10`;

      logBattle(`üëæ ${currentEnemy.name} ${isBoss ? '„Å®ÂØæÂ≥ô„Åó„ÅüÔºÅ' : (isElite ? '„ÅåÁ´ã„Å°„ÅØ„Å†„Åã„Å£„ÅüÔºÅ' : '„ÅåÁèæ„Çå„ÅüÔºÅ')}`, (isBoss || isElite) ? "critical" : "spawn");
    }

    function updateRealtimeStatsUI() {
      const sessionXP = (elapsedTime / 60000) * 10;
      calculateTotalStats();
      refreshRPGStatsUI(sessionXP);
    }

    // ===== RPG: SHOP & GACHA & UPGRADE =====
    // Shop is now in a Tab, so openShopModal is removed.

    function pullGacha() {
      const cost = 10000;
      if (playerStats.gold < cost) { alert(`„Ç≥„Ç§„É≥„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ (10,000 GÂøÖË¶Å)`); return; }
      playerStats.gold -= cost;

      const rarityWeights = { common: 75, uncommon: 18, rare: 5, epic: 1.5, legendary: 0.4, mythic: 0.08, divine: 0.02 };
      const r = Math.random() * 100;
      let targetRarity = "common", acc = 0;
      for (const [key, val] of Object.entries(rarityWeights)) {
        acc += val;
        if (r <= acc) { targetRarity = key; break; }
      }

      const allItems = [...weapons, ...armors, ...accessories, ...autoSkills];
      const possible = allItems.filter(i => i.rarity === targetRarity);
      const picked = possible.length > 0 ? possible[Math.floor(Math.random() * possible.length)] : weapons[0];

      let isNew = false, invItem;
      if (picked.type === "skill") {
        invItem = playerStats.skills.find(i => i.id === picked.id);
        if (!invItem) {
          invItem = { id: picked.id, level: 1, count: 1 };
          playerStats.skills.push(invItem);
          isNew = true;
        } else { invItem.count++; }
      } else {
        invItem = playerStats.inventory.find(i => i.name === picked.name);
        if (!invItem) {
          invItem = { id: picked.name, name: picked.name, level: 1, count: 1 };
          playerStats.inventory.push(invItem);
          isNew = true;
        } else { invItem.count++; }
      }

      saveGameData(); updateShopUI(); refreshRPGStatsUI();
      // Multi-layer particles for gacha
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 50);

      const resultOverlay = document.createElement('div');
      resultOverlay.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:30000;display:flex;align-items:center;justify-content:center;flex-direction:column;animation:fadeIn 0.5s;";
      const rarityColor = getRarityColor(picked.rarity);
      resultOverlay.innerHTML = `
        <div style="text-align:center; animation:scaleIn 0.5s;">
          <div style="font-size:120px; margin-bottom:20px; filter:drop-shadow(0 0 20px ${rarityColor}); animation:float 3s infinite ease-in-out;">${picked.icon}</div>
          <div style="padding:4px 15px; background:rgba(255,255,255,0.1); border-radius:4px; font-size:12px; color:${rarityColor}; font-weight:800; margin-bottom:10px; border:1px solid ${rarityColor}; display:inline-block;">${picked.rarity.toUpperCase()}</div>
          <div style="font-size:32px; color:white; font-weight:900; margin-bottom:5px; text-shadow:0 2px 4px rgba(0,0,0,0.5);">${picked.name}</div>
          <div style="font-size:18px; color:${isNew ? '#ffd700' : '#4caf50'}; font-weight:bold; margin-bottom:40px;">${isNew ? '‚ú® NEW WEAPON UNLOCKED! ‚ú®' : '‚öîÔ∏è WEAPON AWAKENED (x' + invItem.count + ') ‚öîÔ∏è'}</div>
          <button onclick="this.parentElement.parentElement.remove()" style="padding:15px 60px; background:linear-gradient(135deg, ${rarityColor}, #fff); color:#000; border:none; border-radius:50px; font-weight:900; cursor:pointer; box-shadow:0 10px 20px rgba(0,0,0,0.3); transition:0.2s;">‰∫ÜËß£</button>
        </div>
      `;
      document.body.appendChild(resultOverlay);
    }

    function updateShopInventory() {
      const list = document.getElementById('shopWeaponList'); // Changed ID to match HTML
      if (!list) return;

      list.innerHTML = "";
      // Sort: Type (Weapon > Armor > Accessory), then Rarity (Desc), then Level (Desc)
      const myItems = playerStats.inventory.map(inv => {
        let base = weapons.find(w => w.name === inv.name);
        let type = 'weapon';
        if (!base) { base = armors.find(a => a.name === inv.name); type = 'armor'; }
        if (!base) { base = accessories.find(a => a.name === inv.name); type = 'accessory'; }
        return base ? { ...base, ...inv, type } : null;
      }).filter(i => i).sort((a, b) => {
        const typeOrder = { weapon: 3, armor: 2, accessory: 1 };
        if (typeOrder[b.type] !== typeOrder[a.type]) return typeOrder[b.type] - typeOrder[a.type];
        const rarityOrder = { Legendary: 4, Epic: 3, Rare: 2, Common: 1 };
        if (rarityOrder[b.rarity] !== rarityOrder[a.rarity]) return rarityOrder[b.rarity] - rarityOrder[a.rarity];
        return b.level - a.level;
      });

      if (myItems.length === 0) {
        list.innerHTML = "<div style='color:#ccc; text-align:center; padding:40px; background:rgba(255,255,255,0.05); border-radius:12px;'>„Ç¢„Ç§„ÉÜ„É†„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>„Ç¨„ÉÅ„É£„ÇíÂõû„Åó„Å¶Ë£ÖÂÇô„Çí„Ç≤„ÉÉ„Éà„Åó„Çà„ÅÜÔºÅ</div>";
        return;
      }

      const rarityColors = { Common: '#9ca3af', Rare: '#3b82f6', Epic: '#8b5cf6', Legendary: '#f59e0b' };
      const typeIcons = { weapon: 'üó°Ô∏è', armor: 'üõ°Ô∏è', accessory: 'üíç' };

      myItems.forEach(w => {
        const upgradeCost = w.level * 100;

        // Determine stats based on type
        let statText = "";
        let val = 0;
        if (w.atk !== undefined) {
          val = Math.floor(w.atk * (1 + 0.1 * (w.level - 1)) * (1 + 0.05 * ((w.count || 1) - 1)));
          statText = `ATK: ${val}`;
        } else if (w.def !== undefined) {
          val = Math.floor(w.def * (1 + 0.1 * (w.level - 1)) * (1 + 0.05 * ((w.count || 1) - 1)));
          statText = `DEF: ${val}`;
        } else {
          statText = w.desc;
        }

        const isEquipped = (playerStats.equippedWeapon && playerStats.equippedWeapon.name === w.name) ||
          (playerStats.equippedArmor && playerStats.equippedArmor.name === w.name) ||
          (playerStats.equippedAccessory && playerStats.equippedAccessory.name === w.name);

        const rc = rarityColors[w.rarity] || '#9ca3af';
        const bg = `linear-gradient(135deg, ${rc}15, ${rc}05)`;
        const border = `1px solid ${rc}30`;

        const item = document.createElement('div');
        item.style.cssText = `display:flex; align-items:center; gap:12px; padding:15px; margin-bottom:10px; border-radius:12px; background:${bg}; border:${border}; transition:transform 0.2s;`;
        item.onmouseover = () => item.style.transform = "translateY(-2px)";
        item.onmouseout = () => item.style.transform = "translateY(0)";

        // XP Bar for item (mockup based on count/awakening)
        const awakenPct = Math.min(100, (w.count || 1) * 10); // Mock progress

        item.innerHTML = `
      <div style="font-size:40px; min-width:50px; text-align:center; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2));">${w.icon}</div>
      <div style="flex:1;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:800; font-size:16px; color:${rc === '#f59e0b' ? '#ffd700' : 'white'}; text-shadow:0 1px 2px rgba(0,0,0,0.5);">
                ${w.name} <span style="font-size:11px; color:${rc}; background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px; vertical-align:middle;">${w.rarity}</span>
            </div>
            <div style="font-size:12px; font-weight:bold; color:#4caf50;">
                ${isEquipped ? '‚úÖ Ë£ÖÂÇô‰∏≠' : ''}
            </div>
        </div>
        
        <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
            <div style="font-size:13px; color:#ddd; font-weight:bold;">Lv.${w.level}</div>
            <div style="font-size:13px; color:#aaa;">Ë¶öÈÜí: ${w.count || 1}</div>
        </div>
        
        <div style="background:rgba(0,0,0,0.2); border-radius:4px; padding:4px 8px; margin-top:6px; display:inline-block;">
            <div style="font-size:13px; color:#fff; font-weight:bold;">${statText}</div>
        </div>
      </div>
      
      <div style="display:flex; flex-direction:column; gap:6px; min-width:100px;">
          <button onclick="upgradeWeapon('${w.name}')" style="padding:8px 12px; background:linear-gradient(to bottom, #4caf50, #388e3c); color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2); text-shadow:0 1px 1px rgba(0,0,0,0.3); opacity:${playerStats.gold >= upgradeCost ? 1 : 0.6};" ${playerStats.gold < upgradeCost ? 'disabled' : ''}>
            üî® Âº∑Âåñ (${upgradeCost}G)
          </button>
          ${!isEquipped ?
            `<button onclick="equipItem('${w.name}')" style="padding:8px 12px; background:linear-gradient(to bottom, #2196f3, #1976d2); color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2); text-shadow:0 1px 1px rgba(0,0,0,0.3);">üõ°Ô∏è Ë£ÖÂÇô„Åô„Çã</button>` :
            ''
          }
      </div>
    `;
        list.appendChild(item);
      });
    }

    function upgradeWeapon(weaponName) {
      const invItem = playerStats.inventory.find(i => i.name === weaponName);
      if (!invItem) return;

      const cost = invItem.level * 100;
      if (playerStats.gold < cost) {
        alert("„Ç≥„Ç§„É≥„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ");
        return;
      }

      playerStats.gold -= cost;
      invItem.level++;
      saveGameData();
      updateShopInventory();
      calculateTotalStats();
      updateGameUI();
      if (typeof updateShopUI === 'function') updateShopUI();

      const shopTitle = document.querySelector('#shopModal .modal-title');
      if (shopTitle) {
        shopTitle.nextElementSibling.querySelector('span').textContent = playerStats.gold + ' G';
      }
    }
    // Duplicate autoSkills removed.

    // ...

    function checkLoginBonus() {
      // ... (existing logic)
    }

    // Updated updateGameUI to robustly populate Boss/Badges
    function updateGameUI() {
      try {
        // Sync Level
        const info = calcXPInfo();
        playerStats.level = info.level;
        playerStats.exp = info.currentXP;

        // Update Weapon if none equipped
        if (!playerStats.equippedWeapon) {
          // Keeps manual equip only
        }

        // Calculate Stats
        calculateTotalStats();

        // Safety check for studyRecords
        if (!Array.isArray(studyRecords)) studyRecords = [];

        const combo = getCombo(), mult = getComboMultiplier(combo), totalMin = studyRecords.reduce((s, r) => s + r.minutes, 0);

        const elTitle = document.getElementById('heroTitle'); if (elTitle) elTitle.textContent = getTitle(info.level);
        const elLevel = document.getElementById('heroLevel'); if (elLevel) elLevel.textContent = info.level;
        const elXpBar = document.getElementById('xpBar'); if (elXpBar) elXpBar.style.width = (info.currentXP / info.nextXP * 100) + '%';
        const elXpText = document.getElementById('xpText'); if (elXpText) elXpText.textContent = info.currentXP + ' / ' + info.nextXP + ' XP';
        const elTotalTime = document.getElementById('heroTotalTime'); if (elTotalTime) elTotalTime.textContent = minutesToTimeString(totalMin);
        const elComboCount = document.getElementById('comboCount'); if (elComboCount) elComboCount.textContent = combo + 'Êó•';
        const elComboMult = document.getElementById('comboMultiplier'); if (elComboMult) elComboMult.textContent = 'x' + mult.toFixed(1) + ' XP';

        // Update Stats Panel
        const elHp = document.getElementById('statHP'); if (elHp) elHp.textContent = playerStats.totalATK * 10;
        const elMaxHp = document.getElementById('statMaxHP'); if (elMaxHp) elMaxHp.textContent = playerStats.totalATK * 10;

        const baseAtk = playerStats.baseATK;
        const bonusAtk = playerStats.totalATK - baseAtk;
        const elAtk = document.getElementById('statATK');
        if (elAtk) elAtk.innerHTML = `${playerStats.totalATK} <span style="font-size:10px;color:#aaa;">(${baseAtk}+${bonusAtk})</span>`;

        const elDef = document.getElementById('statDEF'); if (elDef) elDef.textContent = playerStats.baseDEF;
        const elCrt = document.getElementById('statCRT'); if (elCrt) elCrt.textContent = playerStats.totalCRT.toFixed(1) + '%';
        const elGold = document.getElementById('statGold'); if (elGold) elGold.textContent = playerStats.gold + ' G';

        // Boss cards
        const bg = document.getElementById('bossGrid');
        if (bg) {
          bg.innerHTML = '';
          let defeated = 0;
          bosses.forEach(b => {
            const dmg = studyRecords.filter(r => r.subject === b.subject).reduce((s, r) => s + r.minutes, 0);
            const hpLeft = Math.max(0, b.hp - dmg), pct = (hpLeft / b.hp * 100).toFixed(1), isDead = hpLeft <= 0;
            if (isDead) defeated++;

            const card = document.createElement('div');
            card.className = 'boss-card' + (isDead ? ' defeated' : '');
            card.innerHTML = `
                <div style="font-size:32px;margin-bottom:8px;">${b.icon}</div>
                <div class="boss-name">${b.name}</div>
                <div class="boss-subject">${b.subject}</div>
                <div class="boss-hp-bar"><div class="boss-hp-fill${pct < 30 ? ' low' : ''}" style="width:${pct}%"></div></div>
                <div class="boss-hp-text">${isDead ? '‚ò†Ô∏è DEFEATED' : 'HP: ' + minutesToTimeString(hpLeft) + ' / ' + minutesToTimeString(b.hp)}</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:4px;">üó°Ô∏è „ÉÄ„É°„Éº„Ç∏: ${minutesToTimeString(dmg)}</div>
            `;
            bg.appendChild(card);
          });
          const elDefeated = document.getElementById('heroDefeated');
          if (elDefeated) elDefeated.textContent = defeated + '/10';
        }

        // Badges
        const bdg = document.getElementById('badgeGrid');
        if (bdg) {
          bdg.innerHTML = '';
          badges.forEach(b => {
            const earned = b.check(studyRecords, combo);
            const el = document.createElement('div');
            el.className = 'badge-item' + (earned ? ' earned' : '');
            el.innerHTML = `<div class="badge-icon">${b.icon}</div><div class="badge-name">${b.name}</div><div class="badge-desc">${b.desc}</div>`;
            bdg.appendChild(el);
          });
        }

        // Also update combat UI
        if (typeof updateRealtimeStatsUI === 'function') updateRealtimeStatsUI();
      } catch (e) {
        console.error("Game UI Update Error:", e);
        const msg = document.getElementById('message');
        if (msg) {
          msg.textContent = "UI Error: " + e.message;
          msg.className = "message error";
          msg.style.display = "block";
        }
      }
    }

    function updateShopUI() {
      // 1. Current Equipment (All 3 Slots)
      // Weapon
      const wp = playerStats.equippedWeapon;
      if (wp) {
        document.getElementById('shopEquipIcon').textContent = wp.icon;
        let level = 1, currentAtk = wp.atk;
        const inv = playerStats.inventory.find(i => i.name === wp.name);
        if (inv) {
          level = inv.level;
          currentAtk = Math.floor(wp.atk * (1 + 0.1 * (level - 1)) * (1 + 0.05 * ((inv.count || 1) - 1)));
        }
        document.getElementById('shopEquipName').innerHTML = `${wp.name} <span style="font-size:12px;color:#ffff00;">Lv.${level}</span>`;
        document.getElementById('shopEquipStat').textContent = `ATK ${currentAtk}`;
      }

      // Armor & Accessory
      const container = document.getElementById('currentEquipDisplay');
      if (container) {
        container.style.flexDirection = 'column';
        container.style.alignItems = 'stretch';
        container.innerHTML = '';

        const slots = [
          { label: "Ê≠¶Âô®", item: playerStats.equippedWeapon, defaultIcon: "üó°Ô∏è", statLabel: "ATK", statKey: "atk" },
          { label: "Èò≤ÂÖ∑", item: playerStats.equippedArmor, defaultIcon: "üõ°Ô∏è", statLabel: "DEF", statKey: "def" },
          { label: "Ë£ÖÈ£æ", item: playerStats.equippedAccessory, defaultIcon: "üíç", statLabel: "EFF", statKey: "desc" }
        ];

        slots.forEach(slot => {
          const item = slot.item;
          let name = "„Å™„Åó", icon = slot.defaultIcon, stat = "--", level = 1;

          if (item) {
            name = item.name;
            icon = item.icon;
            if (slot.statKey === 'desc') stat = item.desc; // Accessory
            else {
              // Calc stats
              let dim = item[slot.statKey];
              const inv = playerStats.inventory.find(i => i.name === item.name);
              if (inv) {
                level = inv.level;
                if (slot.statKey !== 'desc') dim = Math.floor(dim * (1 + 0.1 * (level - 1)) * (1 + 0.05 * ((inv.count || 1) - 1)));
              }
              stat = `${slot.statLabel} ${dim}`;
            }
          }

          const row = document.createElement('div');
          row.style.cssText = "display:flex; align-items:center; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1);";
          row.innerHTML = `
                <div style="width:40px; text-align:center; margin-right:15px; font-size:24px;">${icon}</div>
                <div style="flex:1;">
                    <div style="font-size:10px; color:rgba(255,255,255,0.5); margin-bottom:2px;">${slot.label}</div>
                    <div style="font-weight:bold; color:${item ? (item.rarity === 'Legendary' ? '#ffd700' : 'white') : '#666'}">${name} ${item ? `<span style="font-size:10px;color:#ffff00;">Lv.${level}</span>` : ''}</div>
                    <div style="font-size:11px; color:#aaa;">${stat}</div>
                </div>
            `;
          container.appendChild(row);
        });
      }

      // 2. Passive Skills
      const list = document.getElementById('shopPassiveList');
      if (list) {
        list.innerHTML = "";
        autoSkills.forEach(s => {
          const userSkill = playerStats.skills ? playerStats.skills.find(k => k.id === s.id) : null;
          const has = !!userSkill;
          const lv = has ? userSkill.level : 0;

          let bg = has ? 'rgba(76, 175, 80, 0.2)' : 'rgba(255,255,255,0.05)';
          let opacity = has ? 1 : 0.4;

          let desc = "";
          let mult = 1 + (lv - 1) * 0.2;
          if (!has) mult = 1;

          if (s.effect.atkBonus) desc = `ÊîªÊíÉ+${Math.floor(s.effect.atkBonus * mult)}`;
          if (s.effect.crtRate) desc = `‰ºöÂøÉÁéá+${Math.floor(s.effect.crtRate + (lv > 1 ? lv : 0))}%`;
          if (s.effect.expBonus) desc = `ÁµåÈ®ìÂÄ§+${s.effect.expBonus}%`; // Usually flat or small scale
          if (s.effect.allBonus) desc = `ÂÖ®+${Math.floor(s.effect.allBonus * mult)}`;
          if (s.effect.allStats) desc = `ÂÖ®„Çπ„ÉÜ+${Math.floor(s.effect.allStats * mult)}`;

          const div = document.createElement('div');
          div.style.cssText = `background:${bg}; padding:10px; border-radius:8px; text-align:center; opacity:${opacity}; position:relative; cursor:help; display:flex; flex-direction:column; align-items:center; justify-content:space-between; height:100px;`;

          div.innerHTML = `
                <div style="font-size:24px;">${s.icon}</div>
                <div style="font-size:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;">${s.name}</div>
                ${has ? `<div style="font-size:11px; color:#4caf50; font-weight:bold;">Lv.${lv}</div>` :
              `<div style="font-size:9px; color:#aaa;">Êú™Áç≤Âæó</div>`}
                <div class="shop-skill-tooltip" style="display:none; position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); padding:5px; border-radius:4px; font-size:10px; width:100px; z-index:100;">${desc}</div>
            `;

          div.onmouseenter = () => div.querySelector('.shop-skill-tooltip').style.display = 'block';
          div.onmouseleave = () => div.querySelector('.shop-skill-tooltip').style.display = 'none';

          list.appendChild(div);
        });
      }

      // 3. Gold & Inventory
      const goldDisplay = document.getElementById('shopGoldDisplay');
      if (goldDisplay) goldDisplay.textContent = `${playerStats.gold} G`;
      updateShopInventory();
    }

    // buySkill removed (replaced by Gacha)

    function equipItem(name) {
      // Determine type and equip
      let item = weapons.find(w => w.name === name);
      if (item) { playerStats.equippedWeapon = item; }
      else {
        item = armors.find(a => a.name === name);
        if (item) { playerStats.equippedArmor = item; }
        else {
          item = accessories.find(a => a.name === name);
          if (item) { playerStats.equippedAccessory = item; }
        }
      }

      if (item) {
        saveGameData();
        updateShopUI();
        updateGameUI();
        alert(`${name} „ÇíË£ÖÂÇô„Åó„Åæ„Åó„ÅüÔºÅ`);
      }
    }

    // ===== ACTIVE SKILLS =====
    const skillCooldowns = { 1: 0, 2: 0, 3: 0 };
    const skillMaxCd = { 1: 10000, 2: 45000, 3: 60000 }; // ms

    function useActiveSkill(id) {
      if (!battleInterval) { showMessage("Êà¶Èóò‰∏≠„ÅÆ„Åø‰ΩøÁî®ÂèØËÉΩ„Åß„Åô", "error"); return; }
      if (Date.now() < skillCooldowns[id]) return; // On CD

      if (id === 1) { // ÂÖ®ÂäõÊîªÊíÉ
        const dmg = playerStats.totalATK * 5;
        currentEnemy.hp -= dmg;
        showFloatingDamage(dmg, true);
        logBattle(`üî• ÂÖ®ÂäõÊîªÊíÉÔºÅ ${dmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ`, "critical");
        if (currentEnemy.hp <= 0) onEnemyDefeated();
      } else if (id === 2) { // ÈõÜ‰∏≠ÂäõUP
        activeBuffs.focus = true;
        activeBuffs.focusEndTime = Date.now() + 15000;
        logBattle("üß† ÈõÜ‰∏≠ÂäõUPÔºÅ15ÁßíÈñì‰ºöÂøÉÁéáÂ§ßÂπÖ‰∏äÊòáÔºÅ", "skill");
      } else if (id === 3) { // ÈÅéÂéªÂïèÂ••Áæ©
        const totalMin = studyRecords.reduce((s, r) => s + r.minutes, 0);
        const dmg = totalMin * 100; // 1ÂàÜ = 100„ÉÄ„É°„Éº„Ç∏
        currentEnemy.hp -= dmg;
        showFloatingDamage(dmg, true);
        logBattle(`üìú ÈÅéÂéªÂïèÂ••Áæ©ÔºÅ Á©ç„ÅøÈáç„Å≠„ÅüÁü•Ë≠ò„Åß ${dmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ`, "critical");
        if (currentEnemy.hp <= 0) onEnemyDefeated();
      }

      // Start Cooldown
      skillCooldowns[id] = Date.now() + skillMaxCd[id];
      animateCooldown(id, skillMaxCd[id]);
    }

    function animateCooldown(id, duration) {
      const btn = document.getElementById('skill' + id + 'Btn');
      const overlay = document.getElementById('skill' + id + 'Overlay');
      const text = document.getElementById('skill' + id + 'Text');
      btn.disabled = true;
      btn.classList.add('cooldown');

      let start = Date.now();
      let timer = setInterval(() => {
        let elapsed = Date.now() - start;
        let remaining = duration - elapsed;
        let pct = (remaining / duration) * 100;

        if (remaining <= 0) {
          clearInterval(timer);
          btn.disabled = false;
          btn.classList.remove('cooldown');
          overlay.style.height = '0%';
          text.textContent = '';
        } else {
          overlay.style.height = pct + '%';
          text.textContent = Math.ceil(remaining / 1000);
        }
      }, 100);
    }

    // ===== EQUIPMENT UI =====
    function openEquipModal() {
      const grid = document.getElementById('equipGrid');
      grid.innerHTML = '';
      weapons.forEach((w, i) => {
        const locked = playerStats.level < w.level;
        const equipped = playerStats.equippedWeapon && playerStats.equippedWeapon.name === w.name;

        const el = document.createElement('div');
        el.className = `equip-item ${locked ? 'locked' : ''} ${equipped ? 'equipped' : ''}`;
        if (!locked) el.onclick = () => equipWeapon(i);

        el.innerHTML = `
          <div class="equip-icon">${w.icon}</div>
          <div class="equip-info">
            <div class="equip-name">${w.name} ${equipped ? '<span style="color:#ffd93d;">(Ë£ÖÂÇô‰∏≠)</span>' : ''}</div>
            <div class="equip-stat">ATK +${w.atk} <span style="margin-left:5px;opacity:0.6;">Lv.${w.level}~</span></div>
          </div>
          <div class="equip-rarity rarity-${w.rarity}">${w.rarity.toUpperCase()}</div>
        `;
        grid.appendChild(el);
      });
      document.getElementById('equipModal').classList.add('active');
    }

    function equipWeapon(index) {
      playerStats.equippedWeapon = weapons[index];
      saveGameData();
      updateRealtimeStatsUI();
      openEquipModal(); // Refresh modal
      logBattle(`üó°Ô∏è ${weapons[index].name} „ÇíË£ÖÂÇô„Åó„Åæ„Åó„Åü`);
    }

    // Duplicate saveGameData and dangling loadGameData body removed.
    function updateElapsedInfo() {
      const m = Math.floor(elapsedTime / 6e4), h = (m / 60).toFixed(2);
      document.getElementById('elapsedInfo').textContent = '\u7D4C\u904E\u6642\u9593: ' + m + '\u5206 (' + h + '\u6642\u9593)';
    }
    function pad(n) { return n.toString().padStart(2, '0'); }

    function recordTime() {
      const sub = document.getElementById('subject').value;
      if (!sub) { showMessage('ÁßëÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      const mi = document.getElementById('manualTime').value.trim();
      let minutes = 0;
      if (mi) { minutes = parseManualTime(mi); if (minutes === 0) { showMessage('Ê≠£„Åó„ÅÑÊôÇÈñìÂΩ¢Âºè„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (‰æã: 1:30)', 'error'); return; } }
      else { minutes = Math.floor(elapsedTime / 6e4); if (minutes === 0) { showMessage('1ÂàÜ‰ª•‰∏ä„ÅÆÂ≠¶ÁøíÊôÇÈñì„ÇíË®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; } }
      const sd = document.getElementById('recordDate').value;
      if (!sd) { showMessage('Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
      const rd = new Date(sd + 'T00:00:00'), now = new Date(), dk = sd;
      const rec = { date: dk, time: now.toTimeString().split(' ')[0].substring(0, 5), subject: sub, minutes: minutes, weekday: ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][rd.getDay()] };
      const oldLevel = calcLevel();
      studyRecords.push(rec);
      if (!sheetData[dk]) sheetData[dk] = {}; if (!sheetData[dk][sub]) sheetData[dk][sub] = 0;
      sheetData[dk][sub] += minutes;

      saveRecords();
      saveSheetData();
      saveGameData();

      calculateTotalStats();
      updateGameUI();
      refreshRPGStatsUI();

      showMessage('Â≠¶Áøí„ÇíË®òÈå≤„Åó„ÄÅÊîªÊíÉ„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
      resetTimer();

      updateSheetRow(dk); updateSheetSums(); updateLogTable();
      // Game effects
      const newLevel = calcLevel();
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 30);
      if (minutes >= 30) document.body.classList.add('screen-shake');
      setTimeout(() => document.body.classList.remove('screen-shake'), 300);
      if (newLevel > oldLevel) {
        showLevelUp(newLevel);
      }
      updateGameUI();
    }
    function parseManualTime(input) { const p = input.split(':'); if (p.length !== 2) return 0; const h = parseInt(p[0]), m = parseInt(p[1]); if (isNaN(h) || isNaN(m) || h < 0 || m < 0 || m >= 60) return 0; return h * 60 + m; }

    // ===== SPREADSHEET =====
    function generateSheetRows() {
      const tb = document.getElementById('sheetBody'); if (!tb) return;
      const today = new Date(); today.setHours(0, 0, 0, 0); const todayKey = toDateKeyLocal(today);
      const sd = new Date('2026-02-04T00:00:00'), ed = new Date('2026-08-23T00:00:00'), wd = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      let html = '', cd = new Date(sd);
      while (cd <= ed) {
        const dk = toDateKeyLocal(cd), w = wd[cd.getDay()], rem = Math.floor((ed - cd) / 864e5), st = getShiftType(cd), sc = 'shift-' + st;
        let wc = ''; if (w === 'Âúü') wc = 'weekday-sat'; if (w === 'Êó•') wc = 'weekday-sun';
        const isToday = dk === todayKey;
        html += `<tr data-date="${dk}" id="row-${dk}">`;
        html += `<td class="date-cell ${sc}" style="${isToday ? 'background: rgba(255, 215, 0, 0.3) !important; font-weight: 900; border-left: 5px solid #f59e0b;' : ''}">${dk}${isToday ? ' üìç‰ªäÊó•' : ''}</td>`;
        html += `<td class="${sc} ${wc}" style="${isToday ? 'background: rgba(255, 215, 0, 0.3) !important; font-weight: 900;' : ''}">${w}</td>`;
        html += `<td class="${sc}" style="${isToday ? 'background: rgba(255, 215, 0, 0.3) !important; font-weight: 900;' : ''}">${rem}</td>`;
        subjects.forEach((s, i) => {
          const v = sheetData[dk]?.[s] || '', ts = v ? minutesToTimeString(v) : '', hv = v ? 'has-value' : '';
          html += `<td class="${sc}" style="${isToday ? 'background: rgba(255, 215, 0, 0.2) !important;' : ''}"><input type="text" class="${hv}" data-date="${dk}" data-subject="${s}" value="${ts}" onchange="updateSheetCell(this)" placeholder="00:00"></td>`;
        });
        html += `<td class="total-cell ${sc}" id="total-${dk}" style="${isToday ? 'background: rgba(255, 215, 0, 0.3) !important; font-weight: 900;' : ''}">00:00</td></tr>`;
        cd.setDate(cd.getDate() + 1);
      }
      tb.innerHTML = html; updateAllTotals();
      setTimeout(() => { const row = document.getElementById(`row-${todayKey}`); if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
    }
    function updateSheetCell(input) {
      const d = input.dataset.date, s = input.dataset.subject, v = input.value.trim();
      if (!v) { input.classList.remove('has-value'); if (sheetData[d]) delete sheetData[d][s]; saveSheetData(); updateSheetRow(d); updateSheetSums(); return; }
      const m = timeStringToMinutes(v);
      if (m > 0) { if (!sheetData[d]) sheetData[d] = {}; sheetData[d][s] = m; input.value = minutesToTimeString(m); input.classList.add('has-value'); saveSheetData(); updateSheetRow(d); updateSheetSums(); }
      else { input.value = ''; input.classList.remove('has-value'); }
    }
    function updateSheetRow(dk) {
      const row = document.querySelector('tr[data-date="' + dk + '"]'); if (!row) return;
      subjects.forEach(s => {
        const inp = row.querySelector('input[data-subject="' + s + '"]'), v = sheetData[dk]?.[s] || 0;
        inp.value = v > 0 ? minutesToTimeString(v) : ''; v > 0 ? inp.classList.add('has-value') : inp.classList.remove('has-value');
      });
      updateRowTotal(dk);
    }
    function updateRowTotal(dk) {
      let t = 0; subjects.forEach(s => { t += sheetData[dk]?.[s] || 0; });
      const c = document.getElementById('total-' + dk); if (c) c.textContent = minutesToTimeString(t);
    }
    function updateAllTotals() { Object.keys(sheetData).forEach(d => updateRowTotal(d)); }
    function updateSheetSums() {
      const sums = new Array(11).fill(0); let gt = 0;
      Object.values(sheetData).forEach(dd => { subjects.forEach((s, i) => { const v = dd[s] || 0; sums[i] += v; gt += v; }); });
      subjects.forEach((s, i) => { const c = document.getElementById('sum-' + i); if (c) c.textContent = minutesToTimeString(sums[i]); });
      const tc = document.getElementById('sum-total'); if (tc) tc.textContent = minutesToTimeString(gt);
      const td = document.getElementById('sheetTotalTime'); if (td) td.textContent = minutesToTimeString(gt);
    }
    function syncFromTimer() {
      const tmp = {}; studyRecords.forEach(r => { if (!tmp[r.date]) tmp[r.date] = {}; if (!tmp[r.date][r.subject]) tmp[r.date][r.subject] = 0; tmp[r.date][r.subject] += r.minutes; });
      sheetData = tmp; saveSheetData();
      document.querySelectorAll('#sheetBody input').forEach(inp => {
        const d = inp.dataset.date, s = inp.dataset.subject, v = sheetData[d]?.[s] || 0;
        inp.value = v > 0 ? minutesToTimeString(v) : ''; v > 0 ? inp.classList.add('has-value') : inp.classList.remove('has-value');
      });
      updateAllTotals(); updateSheetSums(); alert('\u2705 ÂêåÊúüÂÆå‰∫Ü');
    }

    function migrateFromV4() {
      if (!confirm('V4.0„ÅÆ„Éá„Éº„Çø„ÇíÁèæÂú®„ÅÆ„Éá„Éº„Çø„Å´‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü\n(studyRecords, sheetData„ÇíÁßªË°å„Åó„Åæ„Åô)')) return;
      const sr = localStorage.getItem('studyRecords');
      const sd = localStorage.getItem('sheetData');
      if (!sr && !sd) { alert('V4.0„ÅÆ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ'); return; }
      if (sr) { studyRecords = JSON.parse(sr); saveRecords(); }
      if (sd) { sheetData = JSON.parse(sd); saveSheetData(); }
      generateSheetRows();
      updateSheetSums();
      updateLogTable();
      alert('‚úÖ „Éá„Éº„ÇøÁßªË°å„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
    }

    // ===== LOG =====
    function updateLogTable() {
      const tb = document.getElementById('logTableBody');
      if (studyRecords.length === 0) { tb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:rgba(255,255,255,0.4);">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>'; return; }
      const sorted = [...studyRecords].reverse(); let html = '';
      sorted.forEach((r, i) => {
        const ai = studyRecords.length - 1 - i;
        html += '<tr><td>' + r.date + '</td><td>' + r.time + '</td><td style="font-weight:bold;">' + r.subject + '</td><td style="font-family:Courier New,monospace;color:#ffd93d;font-weight:bold;">' + minutesToTimeString(r.minutes) + '</td><td><div class="log-actions"><button class="edit-btn" onclick="openEditModal(' + ai + ')">Á∑®ÈõÜ</button><button class="delete-btn" onclick="deleteRecord(' + ai + ')">ÂâäÈô§</button></div></td></tr>';
      });
      tb.innerHTML = html;
    }
    function openEditModal(i) { editingIndex = i; const r = studyRecords[i]; document.getElementById('editDate').value = r.date; document.getElementById('editSubject').value = r.subject; document.getElementById('editTime').value = minutesToTimeString(r.minutes); document.getElementById('editModal').classList.add('active'); }
    function closeEditModal() { document.getElementById('editModal').classList.remove('active'); editingIndex = -1; }
    function saveEdit() {
      if (editingIndex === -1) return; const old = studyRecords[editingIndex], nd = document.getElementById('editDate').value, ns = document.getElementById('editSubject').value, nt = document.getElementById('editTime').value, nm = timeStringToMinutes(nt);
      if (nm === 0) { alert('Ê≠£„Åó„ÅÑÊôÇÈñìÂΩ¢Âºè„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      if (sheetData[old.date] && sheetData[old.date][old.subject]) { sheetData[old.date][old.subject] -= old.minutes; if (sheetData[old.date][old.subject] <= 0) delete sheetData[old.date][old.subject]; }
      studyRecords[editingIndex] = { date: nd, time: old.time, subject: ns, minutes: nm, weekday: ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][new Date(nd + 'T00:00:00').getDay()] };
      if (!sheetData[nd]) sheetData[nd] = {}; if (!sheetData[nd][ns]) sheetData[nd][ns] = 0; sheetData[nd][ns] += nm;
      saveRecords(); saveSheetData(); updateSheetRow(old.date); updateSheetRow(nd); updateSheetSums(); updateLogTable(); closeEditModal(); updateGameUI(); alert('\u2705 Êõ¥Êñ∞ÂÆå‰∫Ü');
    }
    function deleteRecord(i) {
      if (!confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return; const r = studyRecords[i];
      if (sheetData[r.date] && sheetData[r.date][r.subject]) { sheetData[r.date][r.subject] -= r.minutes; if (sheetData[r.date][r.subject] <= 0) delete sheetData[r.date][r.subject]; }
      studyRecords.splice(i, 1); saveRecords(); saveSheetData(); updateSheetRow(r.date); updateSheetSums(); updateLogTable(); updateGameUI(); alert('\u2705 ÂâäÈô§ÂÆå‰∫Ü');
    }

    // ===== REPORT =====
    function switchReport(type) {
      currentReportType = type;
      document.querySelectorAll('#report-tab .filter-btn').forEach(b => { b.style.background = 'rgba(255,255,255,0.1)'; b.style.color = 'rgba(255,255,255,0.7)'; });
      const ab = type === 'today' ? 'reportBtnToday' : type === 'week' ? 'reportBtnWeek' : 'reportBtnMonth';
      const btn = document.getElementById(ab); if (btn) { btn.style.background = 'linear-gradient(135deg,#e94560,#c23152)'; btn.style.color = 'white'; }
      updateReport();
    }
    function updateReport() {
      const c = document.getElementById('reportContent'); if (!c) return;
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // --- NEW: Update summary cards (Above reportContent or within) ---
      const todayStr = today.toISOString().split('T')[0];
      const todayMin = studyRecords.filter(r => r.date === todayStr).reduce((s, r) => s + r.minutes, 0);

      const weekStart = new Date(today); weekStart.setDate(today.getDate() - today.getDay());
      const weekMin = studyRecords.filter(r => { const rd = new Date(r.date + 'T00:00:00'); return rd >= weekStart; }).reduce((s, r) => s + r.minutes, 0);

      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      const monthMin = studyRecords.filter(r => { const rd = new Date(r.date + 'T00:00:00'); return rd >= monthStart; }).reduce((s, r) => s + r.minutes, 0);

      const yearStart = new Date(today.getFullYear(), 0, 1);
      const yearMin = studyRecords.filter(r => { const rd = new Date(r.date + 'T00:00:00'); return rd >= yearStart; }).reduce((s, r) => s + r.minutes, 0);

      const elToday = document.getElementById('reportToday'); if (elToday) elToday.textContent = minutesToTimeString(todayMin);
      const elWeek = document.getElementById('reportWeek'); if (elWeek) elWeek.textContent = minutesToTimeString(weekMin);
      const elMonth = document.getElementById('reportMonth'); if (elMonth) elMonth.textContent = minutesToTimeString(monthMin);
      const elYear = document.getElementById('reportYear'); if (elYear) elYear.textContent = minutesToTimeString(yearMin);

      // --- Original Content Rendering ---
      let startDate, endDate, title, period;
      if (currentReportType === 'today') { startDate = new Date(today); startDate.setHours(0, 0, 0, 0); endDate = new Date(today); endDate.setHours(23, 59, 59, 999); title = '‰ªäÊó•„ÅÆÂ≠¶Áøí„É¨„Éù„Éº„Éà'; period = today.toISOString().split('T')[0]; }
      else if (currentReportType === 'week') { startDate = new Date(today); startDate.setDate(today.getDate() - today.getDay()); startDate.setHours(0, 0, 0, 0); endDate = new Date(today); endDate.setHours(23, 59, 59, 999); title = '‰ªäÈÄ±„ÅÆÂ≠¶Áøí„É¨„Éù„Éº„Éà'; period = startDate.toISOString().split('T')[0] + ' „Äú ' + endDate.toISOString().split('T')[0]; }
      else { startDate = new Date(today.getFullYear(), today.getMonth(), 1); endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); endDate.setHours(23, 59, 59, 999); title = '‰ªäÊúà„ÅÆÂ≠¶Áøí„É¨„Éù„Éº„Éà'; period = today.getFullYear() + 'Âπ¥' + (today.getMonth() + 1) + 'Êúà'; }
      const fr = studyRecords.filter(r => { const rd = new Date(r.date + 'T00:00:00'); return rd >= startDate && rd <= endDate; });
      const tm = fr.reduce((s, r) => s + r.minutes, 0), ud = [...new Set(fr.map(r => r.date))].length, am = ud > 0 ? tm / ud : 0;
      const st = {}; subjects.forEach(s => { st[s] = fr.filter(r => r.subject === s).reduce((a, r) => a + r.minutes, 0); });
      const ss = Object.entries(st).filter(([_, m]) => m > 0).sort((a, b) => b[1] - a[1]);
      const ts = ss.length > 0 ? ss[0] : null;
      let dd = '';
      if (currentReportType !== 'today') {
        const dm = {}; let cd = new Date(startDate); while (cd <= endDate) { const dk = cd.toISOString().split('T')[0]; dm[dk] = fr.filter(r => r.date === dk).reduce((s, r) => s + r.minutes, 0); cd.setDate(cd.getDate() + 1); }
        const dates = Object.keys(dm).sort(), mx = Math.max(...Object.values(dm), 1);
        dd = '<div class="chart-section" style="margin-top:30px;"><div class="chart-title"><span>üìä</span><span>Êó•Âà•Â≠¶ÁøíÊôÇÈñì</span></div><div style="display:grid;gap:8px;">';
        dates.forEach(dt => {
          const mn = dm[dt], pct = (mn / mx * 100).toFixed(0), dObj = new Date(dt + 'T00:00:00'), w = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][dObj.getDay()];
          dd += '<div style="display:flex;align-items:center;gap:12px;"><div style="min-width:100px;font-size:13px;font-weight:600;color:rgba(255,255,255,0.8);">' + dt.substring(5) + ' (' + w + ')</div><div style="flex:1;background:rgba(255,255,255,0.1);height:32px;border-radius:8px;overflow:hidden;"><div style="width:' + pct + '%;height:100%;background:linear-gradient(90deg,#e94560,#ffd93d);border-radius:8px;display:flex;align-items:center;justify-content:flex-end;padding-right:12px;">' + (mn > 0 ? '<span style="font-size:12px;font-weight:700;color:white;">' + minutesToTimeString(mn) + '</span>' : '') + '</div></div></div>';
        });
        dd += '</div></div>';
      }

      // We append the dynamic detail content after keeping the static overview cards if they were outside or inside.
      // In this layout, we'll keep the cards and just update their textContent, 
      // then generate/replace the dynamic list part.
      const detailHTML = '<div style="text-align:center;margin-bottom:30px;"><h2 style="font-size:28px;font-weight:800;color:white;margin-bottom:8px;">' + title + '</h2><p style="font-size:14px;color:rgba(255,255,255,0.6);font-weight:600;">' + period + '</p></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:30px;"><div style="background:linear-gradient(135deg,#e94560,#c23152);color:white;padding:24px;border-radius:16px;"><div style="font-size:13px;opacity:0.9;margin-bottom:8px;font-weight:600;">Á∑èÂ≠¶ÁøíÊôÇÈñì</div><div style="font-size:36px;font-weight:800;font-family:Courier New,monospace;">' + minutesToTimeString(tm) + '</div></div><div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:24px;border-radius:16px;"><div style="font-size:13px;opacity:0.9;margin-bottom:8px;font-weight:600;">Â≠¶ÁøíÊó•Êï∞</div><div style="font-size:36px;font-weight:800;">' + ud + 'Êó•</div></div><div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:24px;border-radius:16px;"><div style="font-size:13px;opacity:0.9;margin-bottom:8px;font-weight:600;">1Êó•Âπ≥Âùá</div><div style="font-size:36px;font-weight:800;font-family:Courier New,monospace;">' + minutesToTimeString(am) + '</div></div>' + (ts ? '<div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:24px;border-radius:16px;"><div style="font-size:13px;opacity:0.9;margin-bottom:8px;font-weight:600;">ÊúÄ„ÇÇÂãâÂº∑„Åó„ÅüÁßëÁõÆ</div><div style="font-size:16px;font-weight:800;margin-bottom:4px;">' + ts[0] + '</div><div style="font-size:24px;font-weight:700;font-family:Courier New,monospace;">' + minutesToTimeString(ts[1]) + '</div></div>' : '') + '</div><div class="chart-section"><div class="chart-title"><span>üìö</span><span>ÁßëÁõÆÂà•Â≠¶ÁøíÊôÇÈñì</span></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;">' + ss.map(([sub, mn]) => { const pct = tm > 0 ? (mn / tm * 100).toFixed(1) : 0, hr = (mn / 60).toFixed(1); return '<div style="background:rgba(0,0,0,0.2);border-radius:12px;padding:16px;border-left:5px solid #e94560;"><div style="font-weight:800;color:white;margin-bottom:8px;font-size:14px;">' + sub + '</div><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><div style="font-size:24px;font-weight:800;color:#ffd93d;">' + hr + 'h</div><div style="font-size:14px;color:rgba(255,255,255,0.6);font-weight:700;">' + pct + '%</div></div><div class="progress-bar"><div style="width:' + pct + '%;height:100%;background:linear-gradient(90deg,#e94560,#ffd93d);border-radius:4px;"></div></div></div>'; }).join('') + '</div></div>' + dd + (fr.length === 0 ? '<div style="text-align:center;padding:60px 20px;background:rgba(0,0,0,0.2);border-radius:16px;margin-top:30px;"><div style="font-size:48px;margin-bottom:16px;">üìö</div><div style="font-size:18px;font-weight:700;color:rgba(255,255,255,0.6);margin-bottom:8px;">„Åì„ÅÆÊúüÈñì„ÅÆÂ≠¶ÁøíË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>' : '');

      const elLog = document.getElementById('reportDetailList');
      if (elLog) {
        elLog.innerHTML = detailHTML;
        const elTitle = document.getElementById('reportDetailTitle');
        if (elTitle) elTitle.textContent = title + '„ÅÆË©≥Á¥∞';
      } else {
        // Fallback for older HTML versions
        c.innerHTML = detailHTML;
      }
    }

    // ===== ADVANCED STATS =====
    function updateAdvancedStats() {
      const tm = studyRecords.reduce((s, r) => s + r.minutes, 0);
      document.getElementById('totalAllTime').textContent = minutesToTimeString(tm);
      const today = new Date(), ws = new Date(today); ws.setDate(today.getDate() - today.getDay()); ws.setHours(0, 0, 0, 0);
      const wm = studyRecords.filter(r => new Date(r.date) >= ws).reduce((s, r) => s + r.minutes, 0);
      document.getElementById('weekTime').textContent = minutesToTimeString(wm);
      const ms = new Date(today.getFullYear(), today.getMonth(), 1);
      const mm = studyRecords.filter(r => new Date(r.date) >= ms).reduce((s, r) => s + r.minutes, 0);
      document.getElementById('monthTime').textContent = minutesToTimeString(mm);
      const ud = [...new Set(studyRecords.map(r => r.date))];
      document.getElementById('studyDays').textContent = ud.length;
      const ss = { early: { total: 0, count: 0 }, late: { total: 0, count: 0 }, rest: { total: 0, count: 0 } };
      studyRecords.forEach(r => { const d = new Date(r.date + 'T00:00:00'), st = getShiftType(d); ss[st].total += r.minutes; });
      ud.forEach(ds => { const d = new Date(ds + 'T00:00:00'), st = getShiftType(d), dm = studyRecords.filter(r => r.date === ds).reduce((s, r) => s + r.minutes, 0); if (dm > 0) ss[st].count++; });
      const ea = ss.early.count > 0 ? ss.early.total / ss.early.count : 0, la = ss.late.count > 0 ? ss.late.total / ss.late.count : 0, ra = ss.rest.count > 0 ? ss.rest.total / ss.rest.count : 0;
      document.getElementById('earlyAvg').textContent = minutesToTimeString(ea);
      document.getElementById('lateAvg').textContent = minutesToTimeString(la);
      document.getElementById('restAvg').textContent = minutesToTimeString(ra);
      const examDate = new Date('2026-08-23'), dte = Math.ceil((examDate - today) / 864e5);
      document.getElementById('daysToExam').textContent = dte;
      const rd = { early: 0, late: 0, rest: 0 }; let cd = new Date(today); cd.setDate(cd.getDate() + 1);
      while (cd <= examDate) { const st = getShiftType(cd); rd[st]++; cd.setDate(cd.getDate() + 1); }
      updateGoalCards(tm, rd, ea, la, ra); updateSubjectBreakdown(tm); updateTrendChart(); updateWeekdayChart(); generateInsights(tm, ea, la, ra, rd, ss);
    }
    function updateGoalCards(tm, rd, ea, la, ra) {
      [800, 1000, 1200].forEach(goal => {
        const gm = goal * 60, prog = Math.min(100, (tm / gm * 100)).toFixed(1), rem = Math.max(0, gm - tm);
        const pe = document.getElementById('goal' + goal + 'Progress'); if (pe) pe.textContent = prog + '%';

        // New Calculation: Work days fixed at 3h (180min), Holidays take the rest
        const workDays = (rd.early || 0) + (rd.late || 0);
        const holidayDays = (rd.rest || 0);
        const workMinutes = workDays * 180; // 3 hours

        // If remaining time is less than what work days provide, we still show 3h for work days (as it's fixed) but holiday pace drops to 0? 
        // Or strictly follow the math: Holiday = (Rem - Work) / HolidayDays
        let er = 180, lr = 180, rr = 0;

        if (holidayDays > 0) {
          rr = Math.max(0, (rem - workMinutes) / holidayDays);
        } else {
          // No holidays left? Just distribute evenly or keep fixed?
          // If no holidays, we can't push to holidays. 
          // If workMinutes < rem, we are in trouble (impossible with fixed 3h).
          // But relying on "fixed 3h" implies that's the habit. 
          // Let's stick to the user formula: "Holidays = Remaining time based on 3h work days"
          // If result is negative, it means 3h/day is more than enough.
          // If we strictly follow "3h fixed", then rr can be 0.
          rr = Math.max(0, (rem - workMinutes)); // Fallback if div by 0, though holidayDays should be checked.
        }

        const ep = document.getElementById('goal' + goal + 'EarlyPace'), lp = document.getElementById('goal' + goal + 'LatePace'), rp = document.getElementById('goal' + goal + 'RestPace');
        if (ep) ep.textContent = minutesToTimeString(er); if (lp) lp.textContent = minutesToTimeString(lr); if (rp) rp.textContent = minutesToTimeString(rr);

        const se = document.getElementById('goal' + goal + 'Status'); if (!se) return;
        if (tm >= gm) { const ex = tm - gm; se.innerHTML = '<span class="status-badge status-ahead">\u2705 ÈÅîÊàêÊ∏à„Åø\uFF08' + minutesToTimeString(ex) + 'Ë∂ÖÈÅé\uFF09</span>'; }
        else {
          const today = new Date(), startDate = new Date('2026-02-06'), dp = Math.max(0, Math.floor((today - startDate) / 864e5));
          let pd = { early: 0, late: 0, rest: 0 }, ck = new Date(startDate);
          for (let i = 0; i <= dp; i++) { const st = getShiftType(ck); pd[st]++; ck.setDate(ck.getDate() + 1); }

          // Calculate schedule based on the CURRENT Pace Calculation (Fixed 3h + Variable Holiday)
          // Ideally "On Track" means following this plan.
          // But calculating "Are we ahead?" implies comparing against a linear ideal or this specific plan?
          // Or just standard comparison: TotalGoal * (DaysPassed / TotalDays).
          // Let's stick to the previous linear comparison for "Status" color (Ahead/Behind) to avoid confusion, 
          // OR compare against the *fixed plan*? 
          // If we use fixed plan: Target = (PastWorkDays * 180) + (PastHolidays * RRFromStart).
          // We don't know RRFromStart easily.
          // Let's verify status based on "If today I did my 3h/Holiday quota, would I meet it?"
          // Actually, let's keep the existing status logic which compares against "Current Rate * Days Passed" 
          // The existing logic was: `shd = er * pd.early + ...`. 
          // Using the *new* er/lr/rr to calculate *past expected* might be weird if rr is very high now.
          // Let's use a standard linear progression for the "Status Text" (Ahead/Behind) to avoid confusion, 
          // OR, if the user wants to know if they are sticking to the "3h/Holiday" plan.
          // Let's use the variables we just calculated (er, lr, rr) as the "Standard Pace" to compare against.
          // Yes, if I have been doing 3h/day and X on holidays, I am on track.

          const shd = er * pd.early + lr * pd.late + rr * pd.rest;
          const diff = tm - shd;

          let ph = '';
          if (diff > 0) ph = '<div style="margin-top:12px;padding:12px;background:rgba(16,185,129,0.15);border-radius:10px;border:1px solid rgba(16,185,129,0.3);"><div style="font-size:13px;color:#6ee7b7;font-weight:700;margin-bottom:4px;">\u{1F4C8} ÈÄ≤Êçó</div><div style="font-size:16px;color:#6ee7b7;font-weight:800;">Ë®≠ÂÆö„Éö„Éº„Çπ„Çà„Çä ' + minutesToTimeString(diff) + ' ÈÄ≤„Çì„Åß„ÅÑ„Åæ„Åô\uFF01</div></div>';
          else if (diff < 0) ph = '<div style="margin-top:12px;padding:12px;background:rgba(239,68,68,0.15);border-radius:10px;border:1px solid rgba(239,68,68,0.3);"><div style="font-size:13px;color:#fca5a5;font-weight:700;margin-bottom:4px;">\u26A0\uFE0F ÈÄ≤Êçó</div><div style="font-size:16px;color:#fca5a5;font-weight:800;">Ë®≠ÂÆö„Éö„Éº„Çπ„Çà„Çä ' + minutesToTimeString(Math.abs(diff)) + ' ÈÅÖ„Çå„Å¶„ÅÑ„Åæ„Åô</div></div>';
          else ph = '<div style="margin-top:12px;padding:12px;background:rgba(96,165,250,0.15);border-radius:10px;border:1px solid rgba(96,165,250,0.3);"><div style="font-size:16px;color:#93c5fd;font-weight:800;">\u2728 „Éö„Éº„ÇπÈÄö„Çä\uFF01</div></div>';
          se.innerHTML = '<span class="status-badge status-ontrack">\u{1F4CA} ÈÄ≤Ë°å‰∏≠</span><div style="margin-top:10px;font-size:13px;color:rgba(255,255,255,0.6);font-weight:600;">ÊÆã„Çä: ' + minutesToTimeString(rem) + ' (' + (rem / 60).toFixed(0) + 'ÊôÇÈñì)</div>' + ph;
        }
      });
    }
    function updateSubjectBreakdown(tm) {
      const c = document.getElementById('subjectBreakdown'); c.innerHTML = '';
      subjects.forEach(s => {
        const mn = studyRecords.filter(r => r.subject === s).reduce((a, r) => a + r.minutes, 0), hr = (mn / 60).toFixed(1), th = subjectTargets[s], tp = th > 0 ? ((mn / 60) / th * 100).toFixed(1) : 0;
        const item = document.createElement('div'); item.className = 'subject-item';
        item.innerHTML = '<div class="subject-name"><span>' + s + '</span>' + (th > 0 ? '<span class="subject-target">ÁõÆÊ®ô' + th + 'h</span>' : '') + '</div><div class="subject-stats"><div class="subject-time">' + hr + 'h</div>' + (th > 0 ? '<div class="subject-percentage">' + tp + '%</div>' : '<div class="subject-percentage">-</div>') + '</div><div class="progress-bar"><div class="progress-fill" style="width:' + Math.min(100, tp) + '%"></div></div>';
        c.appendChild(item);
      });
    }
    function updateTrendChart() {
      const canvas = document.getElementById('trendChart'), ctx = canvas.getContext('2d'), today = new Date(), labels = [], data = [];
      for (let i = 29; i >= 0; i--) { const d = new Date(today); d.setDate(today.getDate() - i); const dk = d.toISOString().split('T')[0]; labels.push((d.getMonth() + 1) + '/' + d.getDate()); data.push((studyRecords.filter(r => r.date === dk).reduce((s, r) => s + r.minutes, 0) / 60).toFixed(2)); }
      const r7 = data.slice(-7).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 7, p7 = data.slice(-14, -7).reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 7, ch = p7 > 0 ? ((r7 - p7) / p7 * 100).toFixed(1) : 0;
      const te = document.getElementById('trendIndicator');
      if (ch > 5) te.innerHTML = '<span class="trend-indicator trend-up">\u2197 ' + ch + '% Â¢óÂä†</span>';
      else if (ch < -5) te.innerHTML = '<span class="trend-indicator trend-down">\u2198 ' + Math.abs(ch) + '% Ê∏õÂ∞ë</span>';
      else te.innerHTML = '<span class="trend-indicator trend-neutral">\u2192 Ê®™„Å∞„ÅÑ</span>';
      if (trendChartInstance) trendChartInstance.destroy();
      trendChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Â≠¶ÁøíÊôÇÈñì(h)', data: data, borderColor: '#e94560', backgroundColor: 'rgba(233,69,96,0.1)', tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => v + 'h', color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } } } } });
    }
    function updateWeekdayChartPeriod(p) {
      weekdayChartPeriod = p;
      ['weekdayBtn1Week', 'weekdayBtn1Month', 'weekdayBtnAll'].forEach(id => { const b = document.getElementById(id); if (b) { b.style.background = 'rgba(255,255,255,0.1)'; b.style.color = 'rgba(255,255,255,0.7)'; } });
      const ab = p === 'week' ? 'weekdayBtn1Week' : p === 'month' ? 'weekdayBtn1Month' : 'weekdayBtnAll';
      const btn = document.getElementById(ab); if (btn) { btn.style.background = '#e94560'; btn.style.color = 'white'; }
      updateWeekdayChart();
    }
    function updateWeekdayChart() {
      const canvas = document.getElementById('weekdayChart'); if (!canvas) return; const ctx = canvas.getContext('2d'), wds = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      const today = new Date(); let fr = studyRecords;
      if (weekdayChartPeriod === 'week') { const wa = new Date(today); wa.setDate(today.getDate() - 7); fr = studyRecords.filter(r => new Date(r.date) >= wa); }
      else if (weekdayChartPeriod === 'month') { const ma = new Date(today); ma.setMonth(today.getMonth() - 1); fr = studyRecords.filter(r => new Date(r.date) >= ma); }
      const datasets = [];
      subjects.forEach((s, idx) => {
        const wt = [0, 0, 0, 0, 0, 0, 0], wc = [0, 0, 0, 0, 0, 0, 0];
        fr.filter(r => r.subject === s).forEach(r => { const d = new Date(r.date).getDay(); wt[d] += r.minutes; if (r.minutes > 0) wc[d]++; });
        const avg = wt.map((t, i) => wc[i] > 0 ? (t / wc[i] / 60).toFixed(2) : 0);
        if (avg.some(v => v > 0)) datasets.push({ label: s, data: avg, backgroundColor: subjectColors[idx], borderColor: subjectColors[idx], borderWidth: 1 });
      });
      if (weekdayChartInstance) weekdayChartInstance.destroy();
      weekdayChartInstance = new Chart(ctx, { type: 'bar', data: { labels: wds, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: 'rgba(255,255,255,0.7)' } }, title: { display: true, text: weekdayChartPeriod === 'week' ? 'Áõ¥Ëøë1ÈÄ±Èñì' : weekdayChartPeriod === 'month' ? 'Áõ¥Ëøë1„É∂Êúà' : 'ÂÖ®ÊúüÈñì', color: 'white' } }, scales: { x: { stacked: true, ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } }, y: { stacked: true, beginAtZero: true, ticks: { callback: v => v + 'h', color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } } } } });
    }

    // ===== INSIGHTS =====
    function generateInsights(tm, ea, la, ra, rd, ss) {
      const c = document.getElementById('insights'); c.innerHTML = ''; const ins = [];
      const gm = 1000 * 60, rem = gm - tm, tw = rd.early + rd.late + rd.rest * 2, br = tw > 0 ? rem / tw : 0;
      if (rem > 0) {
        const er = br, lr = br, rr = br * 2, eOk = er <= ea * 1.1, lOk = lr <= la * 1.1, rOk = rr <= ra * 1.1;
        if (eOk && lOk && rOk) ins.push({ icon: '\u{1F3AF}', title: '1000ÊôÇÈñìÁõÆÊ®ôÈÅîÊàê„ÅØÂçÅÂàÜÂèØËÉΩ„Åß„ÅôÔºÅ', text: 'ÁèæÂú®„ÅÆ„Éö„Éº„Çπ„ÇíÁ∂≠ÊåÅ„Åô„Çå„Å∞ÁõÆÊ®ôÈÅîÊàê„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ' });
        else {
          const sh = []; if (!eOk) sh.push('Êó©Áï™+' + Math.round(er - ea) + 'ÂàÜ'); if (!lOk) sh.push('ÈÅÖÁï™+' + Math.round(lr - la) + 'ÂàÜ'); if (!rOk) sh.push('‰ºëÊó•+' + Math.round(rr - ra) + 'ÂàÜ');
          ins.push({ icon: '\u26A0\uFE0F', title: '„Éö„Éº„Çπ„Ç¢„ÉÉ„Éó„ÅåÂøÖË¶Å„Åß„Åô', text: sh.join('„ÄÅ') + '„ÅÆÂ¢óÂä†„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ‰ºëÊó•„ÇíÊ¥ªÁî®„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ' });
        }
      } else ins.push({ icon: '\u{1F389}', title: '1000ÊôÇÈñìÁõÆÊ®ôÈÅîÊàê„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ', text: 'Á¥†Êô¥„Çâ„Åó„ÅÑÂä™Âäõ„Åß„ÅôÔºÅ„Åï„Çâ„Å´‰∏ä„ÇíÁõÆÊåá„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ' });
      if (ss.rest.count > 0 && ss.early.count > 0) {
        const ratio = ra / ea;
        if (ratio < 1.3) ins.push({ icon: '\u{1F4C5}', title: '‰ºëÊó•„ÅÆÂ≠¶ÁøíÊôÇÈñì„ÇíÂ¢ó„ÇÑ„Åó„Åæ„Åó„Çá„ÅÜ', text: '‰ºëÊó•„ÅØÊó©Áï™„ÅÆ' + ratio.toFixed(1) + 'ÂÄç„Åß„Åô„ÄÇ2ÂÄç„ÇíÁõÆÊ®ô„Å´„Åô„Çã„Å®ÂäπÁéáÁöÑ„Åß„Åô„ÄÇ' });
        else if (ratio > 3) ins.push({ icon: '\u26A1', title: 'Âπ≥Êó•„ÅÆÂ≠¶ÁøíÁøíÊÖ£„ÇíÂº∑Âåñ„Åó„Åæ„Åó„Çá„ÅÜ', text: '‰ºëÊó•„ÅØ„Åó„Å£„Åã„ÇäÂãâÂº∑„Åß„Åç„Å¶„ÅÑ„Åæ„Åô„ÄÇÂπ≥Êó•„ÇÇÈÄöÂã§ÊôÇÈñìÁ≠â„ÇíÊ¥ªÁî®„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ' });
      }
      const stot = {}; subjects.forEach(s => { if (subjectTargets[s] > 0) { const mn = studyRecords.filter(r => r.subject === s).reduce((a, r) => a + r.minutes, 0); stot[s] = { minutes: mn, progress: (mn / 60) / subjectTargets[s] }; } });
      const sp = Object.entries(stot).sort((a, b) => a[1].progress - b[1].progress);
      if (sp.length > 0) {
        const wk = sp[0], st = sp[sp.length - 1];
        if (wk[1].progress < 0.3 && st[1].progress > 0.6) ins.push({ icon: '\u{1F4D6}', title: wk[0] + '„Å´ÈáçÁÇπ„ÇíÁΩÆ„Åç„Åæ„Åó„Çá„ÅÜ', text: 'ÈÄ≤Êçó„Åå' + (wk[1].progress * 100).toFixed(0) + '%„Å®ÈÅÖ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éê„É©„É≥„Çπ„ÇíÂèñ„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ' });
      }
      const today = new Date(), l7 = []; for (let i = 0; i < 7; i++) { const d = new Date(today); d.setDate(today.getDate() - i); l7.push(d.toISOString().split('T')[0]); }
      const sd7 = l7.filter(d => studyRecords.some(r => r.date === d)).length;
      if (sd7 >= 6) ins.push({ icon: '\u{1F525}', title: 'Á¥†Êô¥„Çâ„Åó„ÅÑÂ≠¶ÁøíÁøíÊÖ£ÔºÅ', text: '„Åì„ÅÆ1ÈÄ±Èñì„Åß' + sd7 + 'Êó•Â≠¶Áøí„ÄÇÁ∂ôÁ∂ö„ÅØÂäõ„Å™„ÇäÔºÅ' });
      else if (sd7 >= 4) ins.push({ icon: '\u{1F4AA}', title: 'ËâØ„ÅÑ„Éö„Éº„Çπ„Åß„ÅôÔºÅ', text: '„Åì„ÅÆ1ÈÄ±Èñì„Åß' + sd7 + 'Êó•Â≠¶Áøí„ÄÇÈÄ±5Êó•‰ª•‰∏ä„ÇíÁõÆÊ®ô„Å´ÔºÅ' });
      const examDate = new Date('2026-08-23'), dte = Math.ceil((examDate - today) / 864e5);
      if (dte <= 30) ins.push({ icon: '\u23F0', title: 'Ë©¶È®ìÁõ¥ÂâçÊúü„Åß„Åô', text: 'ÊÆã„Çä' + dte + 'Êó•„ÄÇÂæ©Áøí„Å®ÈÅéÂéªÂïèÊºîÁøí„Å´ÈõÜ‰∏≠„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ' });
      else if (dte <= 60) ins.push({ icon: '\u{1F4DD}', title: '‰ªï‰∏ä„Åí„ÅÆÊôÇÊúü„Åß„Åô', text: 'ÊÆã„Çä' + dte + 'Êó•„ÄÇÈÅéÂéªÂïèÊºîÁøí„ÇíÂ¢ó„ÇÑ„Åó„Å¶„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ' });
      ins.forEach(i => {
        const el = document.createElement('div'); el.className = 'insight-item';
        el.innerHTML = '<div class="insight-icon">' + i.icon + '</div><div class="insight-content"><h3>' + i.title + '</h3><p>' + i.text + '</p></div>'; c.appendChild(el);
      });
    }

    // ===== GAME ENGINE =====

    function getTitle(lv) { for (const t of titleMap) if (lv >= t.min && lv <= t.max) return t.t; return 'Á§æÂä¥Â£´„Éû„Çπ„Çø„Éº'; }
    function getWeapon(lv) { let w = weapons[0]; for (const wp of weapons) if (lv >= wp.lv) w = wp; return w; }
    function getCombo() {
      const dates = [...new Set(studyRecords.map(r => r.date))].sort().reverse();
      if (dates.length === 0) return 0;
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 864e5).toISOString().split('T')[0];
      if (dates[0] !== today && dates[0] !== yesterday) return 0;
      let combo = 1, prev = new Date(dates[0]);
      for (let i = 1; i < dates.length; i++) {
        const cur = new Date(dates[i]), diff = Math.round((prev - cur) / 864e5);
        if (diff === 1) { combo++; prev = cur; } else break;
      }
      return combo;
    }
    function getComboMultiplier(c) { if (c >= 30) return 3.0; if (c >= 14) return 2.5; if (c >= 7) return 2.0; if (c >= 5) return 1.5; if (c >= 3) return 1.2; if (c >= 2) return 1.1; return 1.0; }

    function updateGameUI() {
      calculateTotalStats();
      refreshRPGStatsUI();

      const info = calcXPInfo();
      const combo = getCombo(), mult = getComboMultiplier(combo), totalMin = studyRecords.reduce((s, r) => s + r.minutes, 0);

      document.getElementById('heroTitle').textContent = getTitle(info.level);
      document.getElementById('heroLevel').textContent = info.level;
      document.getElementById('xpBar').style.width = (info.currentXP / info.nextXP * 100) + '%';
      document.getElementById('xpText').textContent = info.currentXP + ' / ' + info.nextXP + ' XP';
      document.getElementById('heroTotalTime').textContent = minutesToTimeString(totalMin);
      document.getElementById('comboCount').textContent = combo + '\u65E5';
      document.getElementById('comboMultiplier').textContent = 'x' + mult.toFixed(1) + ' XP';

      const wp = playerStats.equippedWeapon;
      if (wp) {
        document.getElementById('weaponIcon').textContent = wp.icon;
        document.getElementById('weaponName').textContent = wp.name;
        document.getElementById('weaponStat').textContent = `ATK ${wp.atk}`;
      }

      // Boss cards
      const bg = document.getElementById('bossGrid'); bg.innerHTML = '';
      let defeated = 0;
      bosses.forEach(b => {
        const dmg = studyRecords.filter(r => r.subject === b.subject).reduce((s, r) => s + r.minutes, 0);
        const hpLeft = Math.max(0, b.hp - dmg), pct = (hpLeft / b.hp * 100).toFixed(1), isDead = hpLeft <= 0;
        if (isDead) defeated++;
        const card = document.createElement('div'); card.className = 'boss-card' + (isDead ? ' defeated' : '');
        card.innerHTML = '<div style="font-size:32px;margin-bottom:8px;">' + b.icon + '</div><div class="boss-name">' + b.name + '</div><div class="boss-subject">' + b.subject + '</div><div class="boss-hp-bar"><div class="boss-hp-fill' + (pct < 30 ? ' low' : '') + '" style="width:' + pct + '%"></div></div><div class="boss-hp-text">' + (isDead ? '\u2620\uFE0F DEFEATED' : 'HP: ' + minutesToTimeString(hpLeft) + ' / ' + minutesToTimeString(b.hp)) + '</div><div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:4px;">\u{1F5E1}\uFE0F „ÉÄ„É°„Éº„Ç∏: ' + minutesToTimeString(dmg) + '</div>';
        bg.appendChild(card);
      });
      document.getElementById('heroDefeated').textContent = defeated + '/10';
      // Badges
      const bdg = document.getElementById('badgeGrid'); bdg.innerHTML = '';
      badges.forEach(b => {
        const earned = b.check(studyRecords, combo);
        const el = document.createElement('div'); el.className = 'badge-item' + (earned ? ' earned' : '');
        el.innerHTML = '<div class="badge-icon">' + b.icon + '</div><div class="badge-name">' + b.name + '</div><div class="badge-desc">' + b.desc + '</div>';
        bdg.appendChild(el);
      });

      // Also update combat UI
      if (typeof updateRealtimeStatsUI === 'function') updateRealtimeStatsUI();
      if (typeof updateShopUI === 'function') updateShopUI();
    }

    // ===== PARTICLE EFFECTS =====
    const particles = [];
    function spawnParticles(x, y, count) {
      for (let i = 0; i < count; i++) {
        particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 12, vy: (Math.random() - 0.5) * 12 - 4, life: 1, color: ['#e94560', '#ffd93d', '#ff6b6b', '#10b981'][Math.floor(Math.random() * 4)], size: Math.random() * 6 + 2 });
      }
    }
    function animateParticles() {
      const canvas = document.getElementById('particleCanvas'), ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth; canvas.height = window.innerHeight; ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.life -= 0.02;
        if (p.life <= 0) { particles.splice(i, 1); continue; }
        ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2); ctx.fill();
      }
      requestAnimationFrame(animateParticles);
    }
    animateParticles();

    function showLevelUp(lv) {
      const overlay = document.getElementById('levelUpOverlay');
      document.getElementById('levelUpText').textContent = 'LEVEL UP!';
      document.getElementById('levelUpSub').textContent = 'Lv.' + lv + ' - ' + getTitle(lv);
      overlay.classList.add('active');
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 80);
      setTimeout(() => overlay.classList.remove('active'), 2500);
    }

    // ===== AI ADVISOR =====
    function initAIAdvisor() {
      const grid = document.getElementById('aiSubjectGrid');
      const aiSubjects = subjects.filter(s => s !== '„Åù„ÅÆ‰ªñ');
      aiSubjects.forEach(s => {
        const btn = document.createElement('button'); btn.className = 'ai-subject-btn'; btn.textContent = s;
        btn.onclick = function () { document.querySelectorAll('.ai-subject-btn').forEach(b => b.classList.remove('active')); this.classList.add('active'); showAIAdvice(s); };
        grid.appendChild(btn);
      });
      updateAIProgress();
    }
    function showAIAdvice(subject) {
      const panel = document.getElementById('aiAdvicePanel');
      const data = aiData[subject]; if (!data) { panel.innerHTML = ''; return; }
      const mn = studyRecords.filter(r => r.subject === subject).reduce((s, r) => s + r.minutes, 0);
      const hr = (mn / 60).toFixed(1), target = subjectTargets[subject] || 0, pct = target > 0 ? ((mn / 60) / target * 100).toFixed(1) : 0;
      let html = '<div class="ai-advice-panel">';
      html += '<h2 style="color:#ffd93d;margin-bottom:5px;">' + subject + '</h2>';
      html += '<div style="display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap;"><div style="padding:12px 20px;background:rgba(233,69,96,0.15);border-radius:10px;border:1px solid rgba(233,69,96,0.3);"><span style="font-size:12px;color:rgba(255,255,255,0.5);">Â≠¶ÁøíÊ∏à„Åø</span><div style="font-size:24px;font-weight:bold;color:#ffd93d;">' + hr + 'h</div></div>';
      if (target > 0) html += '<div style="padding:12px 20px;background:rgba(16,185,129,0.15);border-radius:10px;border:1px solid rgba(16,185,129,0.3);"><span style="font-size:12px;color:rgba(255,255,255,0.5);">ÁõÆÊ®ô</span><div style="font-size:24px;font-weight:bold;color:#6ee7b7;">' + target + 'h</div></div><div style="padding:12px 20px;background:rgba(96,165,250,0.15);border-radius:10px;border:1px solid rgba(96,165,250,0.3);"><span style="font-size:12px;color:rgba(255,255,255,0.5);">ÈÅîÊàêÁéá</span><div style="font-size:24px;font-weight:bold;color:#93c5fd;">' + pct + '%</div></div>';
      html += '</div>';
      html += '<h3 style="color:#10b981;margin-bottom:15px;font-size:18px;">\u{1F4CB} ÈáçË¶Å„Éù„Ç§„É≥„Éà</h3>';
      data.points.forEach((p, i) => { html += '<div class="ai-point"><h4>„Éù„Ç§„É≥„Éà' + (i + 1) + '</h4><p>' + p + '</p></div>'; });
      html += '<div class="ai-tips"><h3>\u{1F4A1} Â≠¶ÁøíÊà¶Áï•</h3><p style="color:rgba(255,255,255,0.8);line-height:1.7;">' + data.strategy + '</p></div>';
      // Progress-based advice
      html += '<div class="ai-progress-advice"><h3 style="color:#e94560;margin-bottom:10px;">\u{1F3AF} „ÅÇ„Å™„Åü„Å∏„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ</h3>';
      if (mn === 0) html += '<p style="color:rgba(255,255,255,0.8);line-height:1.7;">„Åæ„Å†„Åì„ÅÆÁßëÁõÆ„ÅÆÂ≠¶Áøí„ÇíÂßã„ÇÅ„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Åæ„Åö„ÅØÂü∫Êú¨„ÉÜ„Ç≠„Çπ„Éà„ÇíÈÄöË™≠„Åó„ÄÅÂÖ®‰ΩìÂÉè„ÇíÊé¥„ÇÄ„Åì„Å®„Åã„ÇâÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇÊúÄÂàù„ÅØÁêÜËß£„Åß„Åç„Å™„Åè„Å¶„ÇÇÂ§ß‰∏àÂ§´„Åß„Åô„ÄÇÁπ∞„ÇäËøî„ÅóË™≠„ÇÄ„Åì„Å®„ÅßÂÆöÁùÄ„Åó„Å¶„ÅÑ„Åç„Åæ„Åô„ÄÇ</p>';
      else if (pct < 25) html += '<p style="color:rgba(255,255,255,0.8);line-height:1.7;">Â≠¶Áøí„ÇíÂßã„ÇÅ„Åü„Å∞„Åã„Çä„Åß„Åô„ÄÇ‰ªä„ÅØÂü∫Êú¨Ê¶ÇÂøµ„ÅÆÁêÜËß£„Å´ÈõÜ‰∏≠„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇÊù°Êñá„ÅÆË∂£Êó®„ÇíÁêÜËß£„Åô„Çã„Åì„Å®„ÅåÈáçË¶Å„Åß„Åô„ÄÇÊöóË®ò„ÅØÂæåÂõû„Åó„Å´„Åó„Å¶„ÄÅ„Åæ„Åö„ÅØ„Äå„Å™„Åú„Åù„ÅÆ„É´„Éº„É´„Åå„ÅÇ„Çã„ÅÆ„Åã„Äç„ÇíËÄÉ„Åà„Å™„Åå„ÇâË™≠„ÅøÈÄ≤„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
      else if (pct < 50) html += '<p style="color:rgba(255,255,255,0.8);line-height:1.7;">Âü∫Á§éÂõ∫„ÇÅ„ÅÆÊÆµÈöé„Åß„Åô„ÄÇÈÅéÂéªÂïè„ÇíËß£„ÅçÂßã„ÇÅ„ÄÅ„Å©„Åì„ÅåÂá∫È°å„Åï„Çå„ÇÑ„Åô„ÅÑ„Åã„ÇíÊääÊè°„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇÈñìÈÅï„Åà„ÅüÂïèÈ°å„ÅØÂøÖ„ÅöËß£Ë™¨„ÇíË™≠„Åø„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„ÅÆË©≤ÂΩìÁÆáÊâÄ„Å´Êàª„Å£„Å¶Á¢∫Ë™ç„Åô„ÇãÁøíÊÖ£„Çí„Å§„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
      else if (pct < 75) html += '<p style="color:rgba(255,255,255,0.8);line-height:1.7;">È†ÜË™ø„Å´ÈÄ≤„Çì„Åß„ÅÑ„Åæ„ÅôÔºÅÂøúÁî®ÂïèÈ°å„ÇÑÊ®™Êñ≠Êï¥ÁêÜ„Å´Âèñ„ÇäÁµÑ„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ‰ªñ„ÅÆÁßëÁõÆ„Å®„ÅÆÈñ¢ÈÄ£ÊÄß„ÇíÊÑèË≠ò„Åó„Å¶Â≠¶Áøí„Åô„Çã„Å®„ÄÅÁêÜËß£„Åå„Åï„Çâ„Å´Ê∑±„Åæ„Çä„Åæ„Åô„ÄÇÊï∞Â≠ó„ÅÆÊöóË®ò„ÇÇÊú¨Ê†ºÁöÑ„Å´Âßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
      else if (pct < 100) html += '<p style="color:rgba(255,255,255,0.8);line-height:1.7;">‰ªï‰∏ä„Åí„ÅÆÊÆµÈöé„Åß„Åô„ÄÇËã¶Êâã„Å™Ë´ñÁÇπ„ÇíÈõÜ‰∏≠ÁöÑ„Å´Âæ©Áøí„Åó„ÄÅÊú¨Ë©¶È®ì„É¨„Éô„É´„ÅÆÂïèÈ°å„ÅßÂÆüÂäõ„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇÊôÇÈñì„ÇíË®à„Å£„Å¶ÂïèÈ°å„ÇíËß£„ÅèÁ∑¥Áøí„ÇÇÈáçË¶Å„Åß„Åô„ÄÇ</p>';
      else html += '<p style="color:rgba(255,255,255,0.8);line-height:1.7;">\u{1F389} ÁõÆÊ®ôÊôÇÈñì„ÇíÈÅîÊàê„Åó„Åæ„Åó„ÅüÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑ„Åß„Åô„ÄÇ„Åì„Åì„Åã„Çâ„ÅØÂÆöÊúüÁöÑ„Å™Âæ©Áøí„ÅßÁü•Ë≠ò„ÇíÁ∂≠ÊåÅ„Åó„Å§„Å§„ÄÅ‰ªñ„ÅÆÁßëÁõÆ„Å®„ÅÆ„Éê„É©„É≥„Çπ„ÇíÊÑèË≠ò„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇÊ®™Êñ≠ÁöÑ„Å™ÂïèÈ°åÊºîÁøí„ÅßÁ∑èÂêàÂäõ„ÇíÈ´ò„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
      html += '</div></div>';
      panel.innerHTML = html;
    }
    function updateAIProgress() {
      const panel = document.getElementById('aiGeneralAdvice');
      const totalMin = studyRecords.reduce((s, r) => s + r.minutes, 0), totalHr = (totalMin / 60).toFixed(1);
      const today = new Date(), examDate = new Date('2026-08-23'), dte = Math.ceil((examDate - today) / 864e5);
      const combo = getCombo();
      // Find weakest subject
      let weakest = '', weakPct = 999;
      subjects.forEach(s => { if (subjectTargets[s] > 0) { const mn = studyRecords.filter(r => r.subject === s).reduce((a, r) => a + r.minutes, 0); const p = (mn / 60) / subjectTargets[s]; if (p < weakPct) { weakPct = p; weakest = s; } } });
      let html = '<div style="margin-top:25px;">';
      html += '<h2 style="color:#10b981;margin-bottom:20px;">\u{1F916} Á∑èÂêà„Ç¢„Éâ„Éê„Ç§„Çπ</h2>';
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px;">';
      // Time-period advice
      if (dte > 150) html += '<div class="ai-point"><h4>\u{1F4C5} Â≠¶ÁøíÂàùÊúüÔºàÂü∫Á§éÂõ∫„ÇÅÊúüÔºâ</h4><p>Ë©¶È®ì„Åæ„Åß' + dte + 'Êó•„ÅÇ„Çä„Åæ„Åô„ÄÇ‰ªä„ÅØÁÑ¶„Çâ„ÅöÂü∫Á§é„ÇíÂõ∫„ÇÅ„ÇãÊôÇÊúü„Åß„Åô„ÄÇ„ÉÜ„Ç≠„Çπ„Éà„ÅÆÈÄöË™≠„Å®Âü∫Êú¨ÂïèÈ°å„ÅÆÁπ∞„ÇäËøî„Åó„Çí‰∏≠ÂøÉ„Å´„ÄÇ1Êó•1ÁßëÁõÆ„Å´ÈõÜ‰∏≠„Åô„Çã„Çà„Çä„ÄÅ2-3ÁßëÁõÆ„Çí„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥„Åô„Çã„Å®È£Ω„Åç„Åö„Å´Á∂ö„Åë„Çâ„Çå„Åæ„Åô„ÄÇ</p></div>';
      else if (dte > 90) html += '<div class="ai-point"><h4>\u{1F4C5} Â≠¶Áøí‰∏≠ÊúüÔºàÂÆüÂäõÈ§äÊàêÊúüÔºâ</h4><p>Ë©¶È®ì„Åæ„Åß' + dte + 'Êó•„ÄÇÈÅéÂéªÂïèÊºîÁøí„ÇíÊú¨Ê†ºÂåñ„Åï„Åõ„Åæ„Åó„Çá„ÅÜ„ÄÇÈñìÈÅï„Åà„ÅüÂïèÈ°å„ÅÆ„Éé„Éº„Éà„Çí‰Ωú„Çä„ÄÅÂº±ÁÇπ„ÇíÂèØË¶ñÂåñ„Åô„Çã„Åì„Å®„ÅåÈáçË¶Å„Åß„Åô„ÄÇÊ®™Êñ≠Êï¥ÁêÜ„ÅßÁßëÁõÆÈñì„ÅÆÂÖ±ÈÄöÁÇπ„ÉªÁõ∏ÈÅïÁÇπ„ÇíÊääÊè°„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ</p></div>';
      else if (dte > 30) html += '<div class="ai-point"><h4>\u{1F4C5} Â≠¶ÁøíÂæåÊúüÔºà‰ªï‰∏ä„ÅíÊúüÔºâ</h4><p>Ë©¶È®ì„Åæ„Åß' + dte + 'Êó•„ÄÇÊ®°Êì¨Ë©¶È®ì„ÅßÊú¨Áï™„ÅÆÊôÇÈñìÈÖçÂàÜ„ÇíÁ∑¥Áøí„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇËã¶ÊâãÁßëÁõÆ„ÅÆÂÖãÊúç„Å®ÂæóÊÑèÁßëÁõÆ„ÅÆÁ¢∫ÂÆü„Å™ÂæóÁÇπ„ÅåÈçµ„Åß„Åô„ÄÇÊñ∞„Åó„ÅÑÊïôÊùê„Å´„ÅØÊâã„ÇíÂá∫„Åï„Åö„ÄÅ‰ªä„ÅÇ„ÇãÊïôÊùê„ÇíÂÆåÁíß„Å´„Åô„Çã„Åì„Å®„ÇíÂÑ™ÂÖà„ÄÇ</p></div>';
      else html += '<div class="ai-point"><h4>\u{1F4C5} Áõ¥ÂâçÊúü</h4><p>Ë©¶È®ì„Åæ„Åß' + dte + 'Êó•ÔºÅ‰ΩìË™øÁÆ°ÁêÜ„ÇíÊúÄÂÑ™ÂÖà„Å´„ÄÇÊñ∞„Åó„ÅÑ„Åì„Å®„ÇíË¶ö„Åà„Çã„Çà„Çä„ÄÅ‰ªä„Åæ„ÅßÂ≠¶„Çì„Å†„Åì„Å®„ÅÆÁ¢∫Ë™ç„Å´ÊôÇÈñì„Çí‰Ωø„ÅÑ„Åæ„Åó„Çá„ÅÜ„ÄÇÊ≥ïÊîπÊ≠£ÊÉÖÂ†±„ÅÆÊúÄÁµÇÁ¢∫Ë™ç„ÇÇÂøò„Çå„Åö„Å´„ÄÇ</p></div>';
      // Weak subject
      if (weakest && weakPct < 0.5) html += '<div class="ai-point"><h4>\u26A0\uFE0F ÂÑ™ÂÖà„Åô„Åπ„ÅçÁßëÁõÆ</h4><p>„Äå' + weakest + '„Äç„ÅÆÈÄ≤Êçó„Åå' + (weakPct * 100).toFixed(0) + '%„Å®ÊúÄ„ÇÇÈÅÖ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÊ¨°„ÅÆÂ≠¶Áøí„Çª„ÉÉ„Ç∑„Éß„É≥„Åß„ÅØ„ÄÅ„Åì„ÅÆÁßëÁõÆ„Å´ÈáçÁÇπ„ÇíÁΩÆ„Åè„Åì„Å®„Çí„Åä„Åô„Åô„ÇÅ„Åó„Åæ„Åô„ÄÇ</p></div>';
      // Study tips
      html += '<div class="ai-point"><h4>\u{1F4A1} ÂäπÊûúÁöÑ„Å™Â≠¶ÁøíÊ≥ï</h4><p><strong>„Éù„É¢„Éâ„Éº„É≠Ê≥ï</strong>Ôºö25ÂàÜÈõÜ‰∏≠‚Üí5ÂàÜ‰ºëÊÜ©„ÅÆ„Çµ„Ç§„ÇØ„É´„ÅßÈõÜ‰∏≠Âäõ„ÇíÁ∂≠ÊåÅ„ÄÇ<br><strong>„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É™„Ç≥„Éº„É´</strong>Ôºö„ÉÜ„Ç≠„Çπ„Éà„ÇíË™≠„ÇÄ„Å†„Åë„Åß„Å™„Åè„ÄÅÈñâ„Åò„Å¶„Åã„ÇâÊÄù„ÅÑÂá∫„ÅôÁ∑¥Áøí„Çí„ÄÇ<br><strong>„Çπ„Éö„Éº„Çπ„Éâ„É™„Éî„ÉÜ„Ç£„Ç∑„Éß„É≥</strong>Ôºö1Êó•Âæå‚Üí3Êó•Âæå‚Üí1ÈÄ±ÈñìÂæå‚Üí2ÈÄ±ÈñìÂæå„Å®ÈñìÈöî„ÇíÁ©∫„Åë„Å¶Âæ©Áøí„ÄÇ</p></div>';
      html += '<div class="ai-point"><h4>\u{1F4F1} „Çπ„Ç≠„ÉûÊôÇÈñìÊ¥ªÁî®Ê≥ï</h4><p>ÈÄöÂã§‰∏≠ÔºöÈü≥Â£∞ÊïôÊùê„ÇÑ‰∏ÄÂïè‰∏ÄÁ≠î„Ç¢„Éó„É™<br>Êòº‰ºë„ÅøÔºöÈÅéÂéªÂïè„Çí3-5ÂïèËß£„Åè<br>Â∞±ÂØùÂâçÔºö‰ªäÊó•Â≠¶„Çì„Å†„Åì„Å®„ÅÆÊåØ„ÇäËøî„ÇäÔºà10ÂàÜÔºâ<br>ÊúùËµ∑„Åç„Å¶„Åô„ÅêÔºöÂâçÊó•„ÅÆÂæ©ÁøíÔºàË®òÊÜ∂ÂÆöÁùÄ„Å´ÊúÄÈÅ©Ôºâ</p></div>';
      if (combo >= 3) html += '<div class="ai-point"><h4>\u{1F525} ÈÄ£Á∂ö' + combo + 'Êó•ÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ</h4><p>Â≠¶ÁøíÁøíÊÖ£„ÅåÂÆöÁùÄ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„ÅÆË™øÂ≠ê„ÅßÁ∂ö„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ„Äå„ÇÑ„ÇãÊ∞ó„Åå„ÅÇ„Çã„Åã„ÇâÂãâÂº∑„Åô„Çã„Äç„ÅÆ„Åß„ÅØ„Å™„Åè„ÄåÂãâÂº∑„Åô„Çã„Åã„Çâ„ÇÑ„ÇãÊ∞ó„ÅåÂá∫„Çã„Äç„ÅÆ„Åß„Åô„ÄÇÁøíÊÖ£„ÅÆÂäõ„Çí‰ø°„Åò„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p></div>';
      html += '</div></div>';
      panel.innerHTML = html;
    }

    // ===== EXPORT =====
    function exportSheet() {
      let csv = '\u65E5\u4ED8,\u66DC\u65E5,\u6B8B\u308A\u65E5\u6570,' + subjects.join(',') + ',\u5F53\u65E5\u5408\u8A08\n';
      const sd = new Date('2026-02-04'), ed = new Date('2026-08-23'), wd = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      let cd = new Date(sd); while (cd <= ed) {
        const dk = toDateKeyLocal(cd), w = wd[cd.getDay()], rem = Math.floor((ed - cd) / 864e5);
        let row = dk + ',' + w + ',' + rem, dt = 0; subjects.forEach(s => { const m = sheetData[dk]?.[s] || 0; row += ',' + minutesToTimeString(m); dt += m; });
        row += ',' + minutesToTimeString(dt) + '\n'; csv += row; cd.setDate(cd.getDate() + 1);
      }
      downloadCSV(csv, 'Á§æÂä¥Â£´Ë©¶È®ì_Â≠¶ÁøíË®òÈå≤_Ê®™Âûã.csv');
    }
    function exportOriginalFormat() {
      let csv = '\u65E5\u4ED8,\u66DC\u65E5,\u6B8B\u308A\u65E5\u6570,\u79D1\u76EE,\u52C9\u5F37\u6642\u9593\n';
      const sd = new Date('2026-02-04'), ed = new Date('2026-08-23'), wd = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      let cd = new Date(sd); while (cd <= ed) {
        const dk = toDateKeyLocal(cd), w = wd[cd.getDay()], rem = Math.floor((ed - cd) / 864e5), dd = sheetData[dk] || {}, hd = Object.values(dd).some(v => v > 0);
        if (hd) subjects.forEach(s => { const m = dd[s] || 0; if (m > 0) csv += dk + ',' + w + ',' + rem + ',' + s + ',' + minutesToTimeString(m) + '\n'; });
        else csv += dk + ',' + w + ',' + rem + ',,\n'; cd.setDate(cd.getDate() + 1);
      }
      downloadCSV(csv, 'Á§æÂä¥Â£´Ë©¶È®ì_Â≠¶ÁøíË®òÈå≤_Á∏¶Âûã.csv');
    }
    function downloadCSV(csv, fn) { const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = fn; link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }

    // ===== UTILS =====
    function timeStringToMinutes(s) { const p = s.split(':'); if (p.length !== 2) return 0; return (parseInt(p[0]) || 0) * 60 + (parseInt(p[1]) || 0); }
    function minutesToTimeString(m) { return pad(Math.floor(m / 60)) + ':' + pad(Math.floor(m % 60)); }
    function showMessage(msg, type) { const e = document.getElementById('message'); e.textContent = msg; e.className = 'message ' + type; }
    function hideMessage() { document.getElementById('message').className = 'message'; }
    function pad(n) { return n.toString().padStart(2, '0'); }
    function toDateKeyLocal(date) {
      const d = new Date(date); d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().split('T')[0];
    }
    function fromDateKeyLocal(s) { return new Date(s + 'T00:00:00'); }
    function getCombo() {
      if (studyRecords.length === 0) return 0;
      const dates = [...new Set(studyRecords.map(r => r.date))].sort();
      let combo = 0, current = new Date(); current.setHours(0, 0, 0, 0);
      for (let i = dates.length - 1; i >= 0; i--) {
        const d = fromDateKeyLocal(dates[i]);
        const diff = (current - d) / 864e5;
        if (diff === 0 || diff === 1) { combo++; current = d; }
        else if (diff > 1) break;
      }
      return combo;
    }

    // ===== INITIALIZATION =====
    window.addEventListener('load', () => {
      updateDateDisplay();
      loadGameData();
      generateSheetRows();
      updateSheetSums();
      updateLogTable();
      switchReport('today');
      updateRealtimeStatsUI();
      initAIAdvisor();
      logBattle("‚öîÔ∏è ÂÜíÈô∫„ÅÆÊ∫ñÂÇô„ÅåÊï¥„ÅÑ„Åæ„Åó„ÅüÔºÅÂ≠¶Áøí„ÇíÈñãÂßã„Åó„Å¶ÈÅãÂëΩ„ÇíÂàá„ÇäÈñã„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ", "critical");
    });
  </script>
</body>

</html>
